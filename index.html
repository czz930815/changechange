<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Love Points ‚ù§Ô∏è</title>
  
  <!-- Ê®£ÂºèËàáÊ†∏ÂøÉÂ∫´ -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore-compat.js"></script>

  <style>
    body { background-color: #fff1f2; color: #334155; -webkit-tap-highlight-color: transparent; font-family: sans-serif; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    #root { opacity: 0; transition: opacity 0.5s ease-in; }
    #root.loaded { opacity: 1; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .animate-heart { animation: pulse 1.5s infinite; }
  </style>
</head>
<body>

  <div id="root"></div>

  <div id="loading" style="position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); text-align:center; color:#f43f5e; font-weight:bold;">
    <div style="font-size: 40px; margin-bottom: 10px;">‚ù§Ô∏è</div>
    Ê≠£Âú®ËºâÂÖ•ÊÑõÁöÑÂ∞èÁ™©...
  </div>

  <script type="text/babel">
    const { useState, useEffect } = React;
    
    // --- Â¶≥ÁöÑ Firebase ÈáëÈë∞ ---
    const firebaseConfig = {
      apiKey: "AIzaSyBAizT0ijN3-uxegV4w2HX6VFvXvYndc3c",
      authDomain: "change-389a0.firebaseapp.com",
      projectId: "change-389a0",
      storageBucket: "change-389a0.firebasestorage.app",
      messagingSenderId: "360528719647",
      appId: "1:360528719647:web:474055ac8fb26e370c0a2a"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const DATA_COLLECTION = "love_points_data_v1";

    // --- ‰øÆÊ≠£ÂæåÁöÑÂúñÁ§∫ÂÖÉ‰ª∂ ---
    const Icon = ({ name, size = 24, className = "" }) => {
      const icons = {
        Heart: <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z" />,
        Camera: (
          <React.Fragment>
            <path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/>
            <circle cx="12" cy="13" r="3"/>
          </React.Fragment>
        ),
        Gift: (
          <React.Fragment>
            <rect x="3" y="8" width="18" height="4" rx="1"/>
            <path d="M12 8v13M19 12v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-7M7.5 8a2.5 2.5 0 0 1 0-5A4.8 8 0 0 1 12 8a4.8 8 0 0 1 4.5-5 2.5 2.5 0 0 1 0 5"/>
          </React.Fragment>
        ),
        Bell: (
          <React.Fragment>
            <path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/>
            <path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/>
          </React.Fragment>
        ),
        Lock: (
          <React.Fragment>
            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
            <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
          </React.Fragment>
        ),
        LogOut: (
          <React.Fragment>
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
            <polyline points="16 17 21 12 16 7"/>
            <line x1="21" y1="12" x2="9" y2="12"/>
          </React.Fragment>
        ),
        CheckCircle: (
          <React.Fragment>
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
            <polyline points="22 4 12 14.01 9 11.01"/>
          </React.Fragment>
        ),
        Plus: (
          <React.Fragment>
            <line x1="12" y1="5" x2="12" y2="19"/>
            <line x1="5" y1="12" x2="19" y2="12"/>
          </React.Fragment>
        ),
        Trash2: (
          <React.Fragment>
            <polyline points="3 6 5 6 21 6"/>
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
            <line x1="10" y1="11" x2="10" y2="17"/>
            <line x1="14" y1="11" x2="14" y2="17"/>
          </React.Fragment>
        ),
        Sparkles: (
          <React.Fragment>
            <path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/>
            <path d="M5 3v4M9 3v4M3 5h4M3 9h4"/>
          </React.Fragment>
        ),
        Clock: (
          <React.Fragment>
            <circle cx="12" cy="12" r="10"/>
            <polyline points="12 6 12 12 16 14"/>
          </React.Fragment>
        ),
        XCircle: (
          <React.Fragment>
            <circle cx="12" cy="12" r="10"/>
            <line x1="15" y1="9" x2="9" y2="15"/>
            <line x1="9" y1="9" x2="15" y2="15"/>
          </React.Fragment>
        ),
        ChevronRight: <path d="m9 18 6-6-6-6"/>
      };
      return (
        <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
          {icons[name] || null}
        </svg>
      );
    };

    const compressImage = (file) => {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (e) => {
          const img = new Image();
          img.src = e.target.result;
          img.onload = () => {
            const canvas = document.createElement('canvas');
            const MAX_WIDTH = 600; 
            const scale = MAX_WIDTH / img.width;
            canvas.width = MAX_WIDTH;
            canvas.height = img.height * scale;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            resolve(canvas.toDataURL('image/jpeg', 0.6));
          };
        };
      });
    };

    function App() {
      const [user, setUser] = useState(null);
      const [activeTab, setActiveTab] = useState('home');
      const [isAdmin, setIsAdmin] = useState(false);
      const [points, setPoints] = useState(0);
      const [submissions, setSubmissions] = useState([]);
      const [rewards, setRewards] = useState([]);
      const [notifications, setNotifications] = useState([]);
      const [unreadCount, setUnreadCount] = useState(0);
      const [loading, setLoading] = useState(true);

      const [desc, setDesc] = useState('');
      const [selectedFile, setSelectedFile] = useState(null);
      const [isUploading, setIsUploading] = useState(false);
      const [wishName, setWishName] = useState('');
      const [wishImage, setWishImage] = useState(null);
      const [showWishForm, setShowWishForm] = useState(false);
      const [pricingId, setPricingId] = useState(null);
      const [pricingCost, setPricingCost] = useState('');
      const [adminPass, setAdminPass] = useState('');
      const [showAdminLogin, setShowAdminLogin] = useState(false);

      useEffect(() => {
        auth.signInAnonymously().catch(e => console.error(e));
        return auth.onAuthStateChanged((u) => {
          setUser(u);
          if (u) {
            setLoading(false);
            document.getElementById('loading').style.display = 'none';
            document.getElementById('root').classList.add('loaded');
          }
        });
      }, []);

      useEffect(() => {
        if (!user) return;
        const unsubStats = db.collection(DATA_COLLECTION).doc('stats').onSnapshot(d => {
          setPoints(d.exists ? (d.data().totalPoints || 0) : 0);
          if (!d.exists) db.collection(DATA_COLLECTION).doc('stats').set({ totalPoints: 0 });
        });
        const unsubSubs = db.collection(DATA_COLLECTION).collection('submissions').orderBy('timestamp', 'desc').onSnapshot(s => setSubmissions(s.docs.map(d => ({id:d.id, ...d.data()}))));
        const unsubRewards = db.collection(DATA_COLLECTION).collection('rewards').onSnapshot(s => {
           const d = s.docs.map(doc => ({ id: doc.id, ...doc.data() }));
           d.sort((a,b) => (a.available===b.available) ? (a.cost-b.cost) : (a.available?-1:1));
           setRewards(d);
        });
        const unsubNotifs = db.collection(DATA_COLLECTION).collection('notifications').orderBy('timestamp', 'desc').onSnapshot(s => {
          const d = s.docs.map(doc => ({id:doc.id, ...doc.data()}));
          setNotifications(d);
          setUnreadCount(d.filter(n => !n.readBy || !n.readBy.includes(user.uid)).length);
        });
        return () => { unsubStats(); unsubSubs(); unsubRewards(); unsubNotifs(); };
      }, [user]);

      const handleUploadTask = async () => {
        if (!desc.trim() || !selectedFile) return alert("Ë´ãÂ°´ÂØ´Ë™™Êòé‰∏¶ÊãçÁÖßÔºÅ");
        setIsUploading(true);
        try {
          const img = await compressImage(selectedFile);
          await db.collection(DATA_COLLECTION).collection('submissions').add({
            description: desc, image: img, status: 'pending', timestamp: firebase.firestore.FieldValue.serverTimestamp(), userId: user.uid
          });
          await db.collection(DATA_COLLECTION).collection('notifications').add({
            title: "Êñ∞‰ªªÂãô‰∏äÂÇ≥ÔºÅüì∏", body: `Áî∑ÂèãÂâõÊèê‰∫§‰∫ÜÔºö${desc}`, from: user.uid, timestamp: firebase.firestore.FieldValue.serverTimestamp(), readBy: [user.uid]
          });
          setDesc(''); setSelectedFile(null);
          alert("Êèê‰∫§ÊàêÂäüÔºÅÁ≠âÂæÖÂØ©Ê†∏ ‚ù§Ô∏è");
        } catch(e){ alert("‰∏äÂÇ≥Â§±Êïó"); } finally { setIsUploading(false); }
      };

      const handleApprove = async (sub) => {
        await db.collection(DATA_COLLECTION).collection('submissions').doc(sub.id).update({ status: 'approved' });
        await db.collection(DATA_COLLECTION).doc('stats').update({ totalPoint
