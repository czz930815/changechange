<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Love Points â¤ï¸</title>
  
  <!-- Styles and Core Libraries -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <style>
    body { background-color: #fff1f2; color: #334155; -webkit-tap-highlight-color: transparent; font-family: sans-serif; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    #root { opacity: 0; transition: opacity 0.5s ease-in; }
    #root.loaded { opacity: 1; }
    @keyframes heart-pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
    .animate-heart { animation: heart-pulse 1.5s infinite; }
  </style>
</head>
<body>

  <div id="root"></div>

  <div id="loading-screen" style="position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); text-align:center; color:#f43f5e; font-weight:bold; z-index:100;">
    <div style="font-size: 40px; margin-bottom: 10px;">â¤ï¸</div>
    æ­£åœ¨è¼‰å…¥æ„›çš„å°çª©...
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, updateDoc, collection, onSnapshot, addDoc, increment, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBAizT0ijN3-uxegV4w2HX6VFvXvYndc3c",
      authDomain: "change-389a0.firebaseapp.com",
      projectId: "change-389a0",
      storageBucket: "change-389a0.firebasestorage.app",
      messagingSenderId: "360528719647",
      appId: "1:360528719647:web:474055ac8fb26e370c0a2a"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const finalAppId = typeof __app_id !== 'undefined' ? __app_id : 'love-sync-v1';

    window.fb = { 
      db, auth, doc, setDoc, updateDoc, collection, onSnapshot, addDoc, 
      increment, serverTimestamp, deleteDoc, appId: finalAppId, 
      signInAnonymously, onAuthStateChanged 
    };
  </script>

  <script type="text/babel">
    const { useState, useEffect } = React;
    const { 
      db, auth, doc, setDoc, updateDoc, collection, onSnapshot, addDoc, 
      increment, serverTimestamp, deleteDoc, appId,
      signInAnonymously, onAuthStateChanged 
    } = window.fb;

    // --- Icon Component ---
    const Icon = ({ name, size = 24, className = "" }) => {
      const icons = {
        Heart: <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z" />,
        Camera: (<React.Fragment><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></React.Fragment>),
        Gift: (<React.Fragment><rect x="3" y="8" width="18" height="4" rx="1"/><path d="M12 8v13M19 12v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-7M7.5 8a2.5 2.5 0 0 1 0-5A4.8 8 0 0 1 12 8a4.8 8 0 0 1 4.5-5 2.5 2.5 0 0 1 0 5"/></React.Fragment>),
        Bell: (<React.Fragment><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></React.Fragment>),
        Lock: (<React.Fragment><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></React.Fragment>),
        LogOut: (<React.Fragment><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></React.Fragment>),
        CheckCircle: (<React.Fragment><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></React.Fragment>),
        Plus: (<React.Fragment><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></React.Fragment>),
        Trash2: (<React.Fragment><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></React.Fragment>),
        Sparkles: (<React.Fragment><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4M9 3v4M3 5h4M3 9h4"/></React.Fragment>),
        Clock: (<React.Fragment><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></React.Fragment>),
        XCircle: (<React.Fragment><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></React.Fragment>),
        ChevronRight: <path d="m9 18 6-6-6-6"/>,
        Image: (<React.Fragment><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></React.Fragment>)
      };
      return (
        <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
          {icons[name] || null}
        </svg>
      );
    };

    const compressImage = (file) => {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (e) => {
          const img = new Image();
          img.src = e.target.result;
          img.onload = () => {
            const canvas = document.createElement('canvas');
            const MAX_WIDTH = 600; 
            const scale = MAX_WIDTH / img.width;
            canvas.width = MAX_WIDTH;
            canvas.height = img.height * scale;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            resolve(canvas.toDataURL('image/jpeg', 0.6));
          };
        };
      });
    };

    function App() {
      const [user, setUser] = useState(null);
      const [activeTab, setActiveTab] = useState('home');
      const [isAdmin, setIsAdmin] = useState(false);
      const [points, setPoints] = useState(0);
      const [submissions, setSubmissions] = useState([]);
      const [rewards, setRewards] = useState([]);
      const [notifications, setNotifications] = useState([]);
      const [unreadCount, setUnreadCount] = useState(0);
      const [loading, setLoading] = useState(true);

      const [desc, setDesc] = useState('');
      const [selectedFile, setSelectedFile] = useState(null);
      const [isUploading, setIsUploading] = useState(false);
      
      const [wishName, setWishName] = useState('');
      const [wishImage, setWishImage] = useState(null);
      const [showWishForm, setShowWishForm] = useState(false);
      
      // Admin æ–°å¢çå‹µç‹€æ…‹
      const [adminRewardName, setAdminRewardName] = useState('');
      const [adminRewardCost, setAdminRewardCost] = useState('');
      const [adminRewardImage, setAdminRewardImage] = useState(null);
      const [isAddingReward, setIsAddingReward] = useState(false);

      const [pricingId, setPricingId] = useState(null);
      const [pricingCost, setPricingCost] = useState('');
      const [adminPass, setAdminPass] = useState('');
      const [showAdminLogin, setShowAdminLogin] = useState(false);

      useEffect(() => {
        const initAuth = async () => {
          try { await signInAnonymously(auth); } catch (e) { console.error("Auth Error:", e); }
        };
        initAuth();
        const unsubscribe = onAuthStateChanged(auth, (u) => {
          if (u) {
            setUser(u);
            setLoading(false);
            const loadingEl = document.getElementById('loading-screen');
            if (loadingEl) loadingEl.style.display = 'none';
            const rootEl = document.getElementById('root');
            if (rootEl) rootEl.classList.add('loaded');
          }
        });
        return () => unsubscribe();
      }, []);

      useEffect(() => {
        if (!user) return;
        const publicPath = (name) => collection(db, 'artifacts', appId, 'public', 'data', name);

        const unsubStats = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'stats', 'total'), (snapshot) => {
          if (snapshot.exists()) setPoints(snapshot.data().totalPoints || 0);
          else setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'stats', 'total'), { totalPoints: 0 });
        });

        const unsubSubs = onSnapshot(publicPath('submissions'), (snapshot) => {
          const data = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
          data.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
          setSubmissions(data);
        });

        const unsubRewards = onSnapshot(publicPath('rewards'), (snapshot) => {
          const data = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
          data.sort((a, b) => (a.available === b.available) ? (a.cost - b.cost) : (a.available ? -1 : 1));
          setRewards(data);
        });

        const unsubNotifs = onSnapshot(publicPath('notifications'), (snapshot) => {
          const data = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
          data.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
          setNotifications(data);
          setUnreadCount(data.filter(n => !n.readBy?.includes(user.uid)).length);
        });

        return () => { unsubStats(); unsubSubs(); unsubRewards(); unsubNotifs(); };
      }, [user]);

      const handleUploadTask = async () => {
        if (!desc.trim() || !selectedFile) return alert("è«‹è¼¸å…¥èªªæ˜ä¸¦æ‹ç…§è­‰æ˜ï¼");
        setIsUploading(true);
        try {
          const img = await compressImage(selectedFile);
          const now = serverTimestamp();
          await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'submissions'), {
            description: desc, image: img, status: 'pending', timestamp: now, userId: user.uid
          });
          await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'notifications'), {
            title: "æ–°ä»»å‹™å¾…å¯©æ ¸ï¼ğŸ“¸", body: `ç”·å‹å‰›æäº¤äº†ï¼š${desc}`, from: user.uid, timestamp: now, readBy: [user.uid]
          });
          setDesc(''); setSelectedFile(null);
          alert("æäº¤æˆåŠŸï¼ç­‰å¾…å¥³å‹å¯©æ ¸ â¤ï¸");
        } catch(e){ alert("ä¸Šå‚³å¤±æ•—"); } finally { setIsUploading(false); }
      };

      const handleApprove = async (sub) => {
        const subRef = doc(db, 'artifacts', appId, 'public', 'data', 'submissions', sub.id);
        const statsRef = doc(db, 'artifacts', appId, 'public', 'data', 'stats', 'total');
        await updateDoc(subRef, { status: 'approved' });
        await updateDoc(statsRef, { totalPoints: increment(10) });
      };

      const handleMakeWish = async () => {
        if (!wishName) return alert("è«‹è¼¸å…¥æƒ³è¦ä»€éº¼ç¦®ç‰©ï¼");
        try {
          let img = "https://placehold.co/400x300/fdf2f8/db2777?text=Wish";
          if (wishImage) img = await compressImage(wishImage);
          await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'rewards'), {
            name: wishName, image: img, cost: 0, available: false, timestamp: serverTimestamp()
          });
          setShowWishForm(false); setWishName(''); setWishImage(null);
          alert("è¨±é¡˜æˆåŠŸï¼ç­‰å¾…å¥³å‹å®šåƒ¹ âœ¨");
        } catch(e) { console.error(e); }
      };

      const handleAddRewardByAdmin = async () => {
        if (!adminRewardName || !adminRewardCost) return alert("è«‹å¡«å¯«çå‹µåç¨±èˆ‡é»æ•¸");
        setIsAddingReward(true);
        try {
          let img = "https://placehold.co/400x300/fef2f2/f43f5e?text=Gift";
          if (adminRewardImage) img = await compressImage(adminRewardImage);
          
          await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'rewards'), {
            name: adminRewardName,
            image: img,
            cost: parseInt(adminRewardCost),
            available: true,
            timestamp: serverTimestamp()
          });
          
          setAdminRewardName(''); setAdminRewardCost(''); setAdminRewardImage(null);
          alert("çå‹µä¸Šæ¶å®Œæˆï¼");
        } catch(e) { console.error(e); alert("ä¸Šæ¶å¤±æ•—"); } finally { setIsAddingReward(false); }
      };

      const handlePriceWish = async (wish) => {
        if (!pricingCost) return;
        const rewardRef = doc(db, 'artifacts', appId, 'public', 'data', 'rewards', wish.id);
        await updateDoc(rewardRef, { cost: parseInt(pricingCost), available: true });
        setPricingId(null); setPricingCost('');
      };

      const handleRedeem = async (reward) => {
        const cost = Number(reward.cost);
        if (points < cost) return alert("é»æ•¸ä¸è¶³ï¼å¿«å»åŸ·è¡Œä»»å‹™è³ºé»æ•¸ï¼");
        if (!confirm(`ç¢ºå®šè¦èŠ±è²» ${cost} é»å…Œæ›ã€Œ${reward.name}ã€å—ï¼Ÿ`)) return;

        try {
          const statsRef = doc(db, 'artifacts', appId, 'public', 'data', 'stats', 'total');
          const now = serverTimestamp();
          await updateDoc(statsRef, { totalPoints: increment(-cost) });
          await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'submissions'), {
            description: `ğŸ æˆåŠŸå…Œæ›ï¼š${reward.name}`,
            image: reward.image,
            status: 'redeemed',
            timestamp: now,
            userId: user.uid
          });
          alert("å…Œæ›æˆåŠŸï¼é»æ•¸å·²è‡ªå‹•æ‰£é™¤ã€‚");
          setActiveTab('home');
        } catch (e) { alert("å…Œæ›å¤±æ•—"); }
      };

      const markRead = () => {
        notifications.forEach(n => {
          if (!n.readBy?.includes(user.uid)) {
            const nRef = doc(db, 'artifacts', appId, 'public', 'data', 'notifications', n.id);
            updateDoc(nRef, { readBy: [...(n.readBy || []), user.uid] });
          }
        });
      };

      if (loading) return null;

      return (
        <div className="max-w-md mx-auto shadow-2xl relative min-h-screen pb-24 sm:rounded-3xl sm:my-4 sm:border-4 sm:border-rose-100 bg-rose-50 overflow-hidden">
          {/* Header */}
          <div className="bg-gradient-to-b from-rose-400 to-rose-500 p-6 text-white rounded-b-[40px] shadow-lg relative z-10">
            <div className="flex justify-between items-center">
              <div className="flex items-center gap-2">
                <Icon name="Heart" className="fill-current text-rose-200 animate-heart" size={24} />
                <h1 className="text-xl font-bold tracking-tight">Love Points</h1>
              </div>
              <div className="flex items-center gap-3">
                <button onClick={() => { setActiveTab('notifs'); markRead(); }} className="relative p-2 bg-white/10 rounded-full hover:bg-white/20 transition-all">
                  <Icon name="Bell" size={20} />
                  {unreadCount > 0 && <span className="absolute top-0 right-0 bg-white text-rose-500 text-[10px] font-bold w-4 h-4 rounded-full flex items-center justify-center border border-rose-500">{unreadCount}</span>}
                </button>
                <button onClick={() => isAdmin ? setIsAdmin(false) : setShowAdminLogin(!showAdminLogin)} className="p-2 bg-white/10 rounded-full hover:bg-white/20 transition-all">
                  <Icon name={isAdmin ? "LogOut" : "Lock"} size={20} />
                </button>
              </div>
            </div>
            <div className="mt-8 mb-4 text-center">
              <div className="inline-block px-8 py-4 rounded-full bg-white/10 backdrop-blur-md border border-white/20 mb-3 shadow-inner">
                <span className="text-6xl font-black tracking-tighter drop-shadow-sm">{points}</span>
              </div>
              <p className="text-rose-100 text-xs font-bold tracking-[0.2em] uppercase opacity-90">Current Balance</p>
            </div>
            {/* Admin Popup */}
            {showAdminLogin && !isAdmin && (
              <div className="absolute top-20 right-4 bg-white p-5 rounded-2xl shadow-2xl z-50 w-64 text-slate-700 animate-in">
                <p className="text-xs font-bold mb-3 text-rose-500 flex items-center gap-1"><Icon name="Lock" size={12}/> å¥³å‹å°ˆç”¨é€šé“</p>
                <input type="password" placeholder="è¼¸å…¥å¯†ç¢¼ (love1314)" className="w-full bg-slate-50 border p-3 rounded-xl mb-3 text-sm focus:ring-2 focus:ring-rose-200 outline-none" value={adminPass} onChange={(e) => setAdminPass(e.target.value)} />
                <button onClick={() => { if(adminPass==='love1314') {setIsAdmin(true); setShowAdminLogin(false); setAdminPass('');} else alert('å¯†ç¢¼éŒ¯èª¤'); }} className="w-full bg-rose-500 text-white py-2.5 rounded-xl font-bold shadow-lg">ç™»å…¥å¾Œå°</button>
              </div>
            )}
          </div>

          <div className="p-5 overflow-y-auto max-h-[calc(100vh-320px)] no-scrollbar">
            {/* Notifications */}
            {activeTab === 'notifs' && (
              <div className="space-y-4 animate-in">
                <div className="flex justify-between items-center">
                   <h2 className="font-bold text-slate-700 flex gap-2"><Icon name="Bell" className="text-rose-400" size={18}/> é€šçŸ¥ç´€éŒ„</h2>
                </div>
                {notifications.length === 0 && <div className="text-center py-10 text-slate-400 text-sm italic">ç›®å‰æ²’æœ‰æ–°æ¶ˆæ¯</div>}
                {notifications.map(n => (
                  <div key={n.id} className={`p-4 rounded-2xl bg-white border transition-all ${n.readBy?.includes(user.uid) ? 'opacity-60 border-slate-100' : 'border-rose-100 shadow-sm scale-[1.02]'}`}>
                    <p className="font-bold text-sm text-slate-800">{n.title}</p>
                    <p className="text-xs text-slate-500 mt-1 leading-relaxed">{n.body}</p>
                  </div>
                ))}
              </div>
            )}

            {/* Home */}
            {activeTab === 'home' && (
              <div className="space-y-6 animate-in">
                <div className="bg-white p-5 rounded-[32px] shadow-sm border border-rose-100">
                  <h3 className="font-bold text-slate-700 mb-4 flex gap-2"><Icon name="Plus" size={16} className="text-rose-500"/> æäº¤è¡¨ç¾</h3>
                  <textarea className="w-full bg-slate-50 p-4 rounded-2xl border-none text-sm min-h-[90px] outline-none" placeholder="ä»Šå¤©ç‚ºå¦³åšäº†ä»€éº¼..." value={desc} onChange={(e) => setDesc(e.target.value)} />
                  <div className="flex gap-3 mt-4">
                    <label className={`flex-1 cursor-pointer py-3 rounded-2xl flex items-center justify-center border-2 border-dashed transition-all ${selectedFile ? 'border-rose-300 bg-rose-50 text-rose-500' : 'border-slate-200 text-slate-400 hover:bg-slate-50'}`}>
                      <Icon name="Camera" size={20} className="mr-2"/> <span className="text-xs font-bold">{selectedFile ? 'å·²æ‹å¥½' : 'æ‹ç…§è­‰æ˜'}</span>
                      <input type="file" accept="image/*" className="hidden" onChange={(e) => setSelectedFile(e.target.files[0])} />
                    </label>
                    <button onClick={handleUploadTask} disabled={isUploading} className="flex-1 bg-rose-500 text-white py-3 rounded-2xl font-bold shadow-lg text-xs disabled:opacity-50 transition-all">{isUploading ? 'æ­£åœ¨å‚³é€' : 'é€å‡ºå¯©æ ¸'}</button>
                  </div>
                </div>
                <div className="space-y-3 pb-4">
                  <h3 className="text-xs font-bold text-slate-400 uppercase tracking-widest px-2">æœ€è¿‘å‹•æ…‹ç´€éŒ„</h3>
                  {submissions.map(sub => (
                    <div key={sub.id} className="bg-white p-3 rounded-2xl flex gap-4 border border-slate-50 shadow-sm relative overflow-hidden group hover:shadow-md transition-shadow">
                       <div className={`absolute left-0 top-0 bottom-0 w-1.5 ${sub.status === 'approved' ? 'bg-green-400' : (sub.status === 'redeemed' ? 'bg-blue-400' : (sub.status === 'rejected' ? 'bg-red-400' : 'bg-yellow-400'))}`}></div>
                       <div className="w-20 h-20 bg-slate-100 rounded-xl overflow-hidden shrink-0 shadow-inner">
                         {sub.image && <img src={sub.image} className="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500" />}
                       </div>
                       <div className="flex-1 py-1 min-w-0 flex flex-col justify-center">
                          <p className="text-sm font-bold text-slate-800 truncate">{sub.description}</p>
                          <span className={`text-[10px] font-bold mt-1 inline-block ${sub.status === 'approved' ? 'text-green-500' : (sub.status === 'redeemed' ? 'text-blue-500' : 'text-slate-400')}`}>
                            {sub.status === 'pending' ? 'ç­‰å¾…å¯©æ ¸ä¸­...' : (sub.status === 'approved' ? 'å·²åŠ åˆ† (+10)' : (sub.status === 'redeemed' ? 'å…Œæ›ç´€éŒ„' : 'æœªé€šé'))}
                          </span>
                       </div>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* Rewards */}
            {activeTab === 'rewards' && (
              <div className="space-y-6 animate-in">
                <div className="bg-gradient-to-br from-indigo-500 to-purple-600 rounded-[32px] p-6 text-white shadow-xl relative overflow-hidden">
                   <div className="absolute top-0 right-0 p-4 opacity-20"><Icon name="Sparkles" size={80}/></div>
                  <h2 className="font-bold text-lg mb-1">è¨±é¡˜æ±  âœ¨</h2>
                  {!showWishForm ? (
                    <button onClick={() => setShowWishForm(true)} className="bg-white text-indigo-600 px-6 py-2.5 rounded-xl text-xs font-black shadow-lg w-full sm:w-auto active:scale-95 transition-all">æˆ‘è¦è¨±é¡˜ +</button>
                  ) : (
                    <div className="space-y-3 mt-3 animate-in slide-in-from-top duration-300">
                      <input className="w-full bg-white/20 border-none rounded-xl p-3 text-sm text-white placeholder:text-white/60 outline-none" placeholder="çå‹µåç¨±" value={wishName} onChange={(e) => setWishName(e.target.value)} />
                      <label className="flex items-center justify-center py-4 rounded-xl bg-white/10 border border-white/20 cursor-pointer border-dashed hover:bg-white/20 transition-all">
                        <Icon name="Camera" size={16} className="mr-2"/> <span className="text-xs font-bold">{wishImage ? 'å·²é¸åœ–' : 'ä¸Šå‚³åƒè€ƒåœ–'}</span>
                        <input type="file" accept="image/*" className="hidden" onChange={(e) => setWishImage(e.target.files[0])} />
                      </label>
                      <div className="flex gap-2">
                        <button onClick={() => setShowWishForm(false)} className="flex-1 bg-white/10 rounded-xl text-xs py-2 hover:bg-white/20">å–æ¶ˆ</button>
                        <button onClick={handleMakeWish} className="flex-1 bg-white text-indigo-600 rounded-xl text-xs font-bold py-2 shadow-lg">é€å‡º</button>
                      </div>
                    </div>
                  )}
                </div>
                <div className="grid grid-cols-2 gap-4">
                  {rewards.map(r => (
                    <div key={r.id} className="bg-white rounded-[24px] border border-rose-50 overflow-hidden shadow-sm flex flex-col group hover:shadow-md transition-all">
                      <div className="aspect-[4/3] bg-slate-100 relative overflow-hidden">
                        {r.image && <img src={r.image} className={`w-full h-full object-cover transition-transform duration-700 group-hover:scale-110 ${!r.available && 'grayscale opacity-60'}`} />}
                        {r.available ? (
                          <div className="absolute top-2 right-2 bg-rose-500 text-white text-[10px] font-black px-2 py-1 rounded-lg shadow-md">{r.cost} P</div>
                        ) : (
                          <div className="absolute inset-0 flex items-center justify-center bg-black/40 text-white text-[10px] font-bold backdrop-blur-[1px]">å®šåƒ¹å¯©æ ¸ä¸­</div>
                        )}
                      </div>
                      <div className="p-3 flex-1 flex flex-col justify-between">
                        <h4 className="text-xs font-bold text-slate-700 truncate mb-2">{r.name}</h4>
                        <button 
                          onClick={() => r.available && handleRedeem(r)} 
                          disabled={!r.available || points < r.cost} 
                          className={`w-full py-2 rounded-xl text-[10px] font-black transition-all ${r.available ? (points >= r.cost ? 'bg-rose-500 text-white shadow-lg active:scale-95' : 'bg-slate-100 text-slate-400 cursor-not-allowed') : 'bg-slate-50 text-slate-300 cursor-default'}`}
                        >
                          å…Œæ›
                        </button>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* Admin */}
            {activeTab === 'admin' && isAdmin && (
              <div className="space-y-6 pb-10 animate-in">
                <div className="bg-rose-100 p-4 rounded-2xl text-rose-600 font-bold flex gap-2 items-center shadow-inner"><Icon name="Sparkles" size={18}/> å¥³å‹ç®¡ç†å¾Œå° ğŸ‘‘</div>
                
                {/* 1. ä¸»å‹•æ–°å¢çå‹µ (æ–°å¢åŠŸèƒ½) */}
                <div className="bg-white p-5 rounded-[28px] border-2 border-rose-100 shadow-sm space-y-4">
                  <h3 className="text-sm font-bold text-rose-500 flex items-center gap-2"><Icon name="Plus" size={16}/> ä¸Šæ¶æ–°çå‹µå•†å“</h3>
                  <div className="space-y-3">
                    <input className="w-full bg-slate-50 border rounded-xl p-3 text-sm outline-none focus:ring-2 focus:ring-rose-200" placeholder="ä¾‹å¦‚ï¼šæŒ‰æ‘© 30 åˆ†é˜" value={adminRewardName} onChange={(e) => setAdminRewardName(e.target.value)} />
                    <input type="number" className="w-full bg-slate-50 border rounded-xl p-3 text-sm outline-none focus:ring-2 focus:ring-rose-200" placeholder="æ‰€éœ€é»æ•¸ (ä¾‹å¦‚ï¼š100)" value={adminRewardCost} onChange={(e) => setAdminRewardCost(e.target.value)} />
                    <label className={`flex items-center justify-center py-3 rounded-xl border-2 border-dashed transition-all cursor-pointer ${adminRewardImage ? 'border-rose-300 bg-rose-50 text-rose-500' : 'border-slate-200 text-slate-400 hover:bg-slate-50'}`}>
                      <Icon name="Image" size={20} className="mr-2"/> <span className="text-xs font-bold">{adminRewardImage ? 'å·²é¸å¥½åœ–' : 'ä¸Šå‚³å•†å“åœ–ç‰‡'}</span>
                      <input type="file" accept="image/*" className="hidden" onChange={(e) => setAdminRewardImage(e.target.files[0])} />
                    </label>
                    <button onClick={handleAddRewardByAdmin} disabled={isAddingReward} className="w-full py-3 bg-rose-500 text-white rounded-xl font-bold shadow-lg shadow-rose-200 active:scale-95 transition-all text-sm disabled:opacity-50">
                      {isAddingReward ? 'æ­£åœ¨ä¸Šæ¶...' : 'ç¢ºèªä¸Šæ¶çå‹µå•†å“'}
                    </button>
                  </div>
                </div>

                <div className="space-y-4 pt-4 border-t border-rose-100">
                  <h3 className="text-[10px] font-black text-slate-400 px-1 uppercase tracking-widest">å¾…è™•ç†å¯©æ ¸ä»»å‹™ ({submissions.filter(s => s.status === 'pending').length})</h3>
                  {submissions.filter(s => s.status === 'pending').map(sub => (
                    <div key={sub.id} className="bg-white p-4 rounded-[28px] border border-rose-100 shadow-md">
                      {sub.image && <img src={sub.image} className="w-full h-40 object-cover rounded-[20px] mb-4 shadow-inner" />}
                      <p className="text-sm font-bold text-slate-800 mb-5 leading-relaxed">{sub.description}</p>
                      <div className="flex gap-2">
                        <button onClick={() => { if(confirm('ç¢ºå®šè¦æ‹’çµ•å—ï¼Ÿ')) deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'submissions', sub.id)); }} className="flex-1 py-3 bg-slate-50 text-slate-400 rounded-2xl text-xs font-bold">æ‹’çµ•</button>
                        <button onClick={() => handleApprove(sub)} className="flex-[2.5] py-3 bg-rose-500 text-white rounded-2xl text-xs font-black shadow-lg">æ‰¹å‡† (+10 é»)</button>
                      </div>
                    </div>
                  ))}
                </div>

                <div className="space-y-3 pt-6 border-t border-rose-100">
                  <h3 className="text-[10px] font-black text-indigo-400 uppercase tracking-widest px-1">é¡˜æœ›å®šåƒ¹ä¸­å¿ƒ</h3>
                  {rewards.filter(r => !r.available).map(wish => (
                    <div key={wish.id} className="bg-white p-4 rounded-3xl flex items-center gap-4 border border-indigo-100 shadow-sm transition-all hover:shadow-md">
                      <div className="w-14 h-14 rounded-2xl bg-slate-100 overflow-hidden shrink-0 shadow-inner">{wish.image && <img src={wish.image} className="w-full h-full object-cover"/>}</div>
                      <div className="flex-1 min-w-0">
                        <p className="text-xs font-bold truncate text-slate-700">{wish.name}</p>
                        {pricingId === wish.id ? (
                          <div className="flex gap-2 mt-2 animate-in">
                            <input type="number" className="w-24 border rounded-lg p-2 text-xs outline-none focus:ring-2 focus:ring-indigo-400 bg-slate-50" placeholder="é»æ•¸" value={pricingCost} onChange={(e) => setPricingCost(e.target.value)} autoFocus />
                            <button onClick={() => handlePriceWish(wish)} className="bg-indigo-500 text-white p-2 rounded-lg shadow-md hover:bg-indigo-600"><Icon name="CheckCircle" size={16}/></button>
                            <button onClick={() => setPricingId(null)} className="bg-slate-100 text-slate-400 p-2 rounded-lg"><Icon name="XCircle" size={16}/></button>
                          </div>
                        ) : (
                          <button onClick={() => {setPricingId(wish.id); setPricingCost('');}} className="text-[10px] text-indigo-500 font-bold mt-1 flex items-center hover:underline group">
                            è¨­å®šéœ€è¦çš„é»æ•¸ <Icon name="ChevronRight" size={12} className="group-hover:translate-x-1 transition-transform" />
                          </button>
                        )}
                      </div>
                    </div>
                  ))}
                </div>

                <div className="space-y-2 pt-6 border-t border-rose-100">
                     <h3 className="text-[10px] font-black text-slate-400 px-1 uppercase tracking-widest">çå‹µåˆ—è¡¨ç®¡ç†</h3>
                     {rewards.filter(r => r.available).map(r => (
                       <div key={r.id} className="flex justify-between items-center bg-white p-3 rounded-2xl border border-slate-100">
                          <span className="text-xs text-slate-600 truncate">{r.name}</span>
                          <div className="flex items-center gap-3">
                             <span className="text-[10px] font-bold text-rose-400">{r.cost} P</span>
                             <button onClick={() => { if(confirm('ç¢ºå®šè¦ä¸‹æ¶æ­¤çå‹µå—ï¼Ÿ')) deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rewards', r.id)); }} className="text-slate-300 hover:text-red-500 transition-colors"><Icon name="Trash2" size={14}/></button>
                          </div>
                       </div>
                     ))}
                </div>
              </div>
            )}
          </div>

          <div className="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-md border-t border-rose-50 px-8 py-5 flex justify-between items-center text-[10px] font-bold text-slate-400 max-w-md mx-auto z-50 shadow-[0_-10px_30px_rgba(0,0,0,0.02)]">
            <button onClick={() => setActiveTab('home')} className={`flex flex-col items-center gap-1.5 transition-all ${activeTab === 'home' ? 'text-rose-500 scale-110' : ''}`}><Icon name="Camera" size={24} className={activeTab === 'home' ? 'stroke-[2.5px]' : ''}/><span>é›†é»</span></button>
            <button onClick={() => setActiveTab('rewards')} className={`flex flex-col items-center gap-1.5 transition-all ${activeTab === 'rewards' ? 'text-rose-500 scale-110' : ''}`}><Icon name="Gift" size={24} className={activeTab === 'rewards' ? 'stroke-[2.5px]' : ''}/><span>å…Œæ›</span></button>
            <button onClick={() => { setActiveTab('notifs'); markRead(); }} className={`flex flex-col items-center gap-1.5 transition-all ${activeTab === 'notifs' ? 'text-rose-500 scale-110' : ''}`}><div className="relative"><Icon name="Bell" size={24} className={activeTab === 'notifs' ? 'stroke-[2.5px]' : ''}/>{unreadCount > 0 && <span className="absolute -top-1 -right-1 bg-rose-500 w-2.5 h-2.5 rounded-full border-2 border-white animate-bounce"></span>}</div><span>é€šçŸ¥</span></button>
            {isAdmin && <button onClick={() => setActiveTab('admin')} className={`flex flex-col items-center gap-1.5 transition-all ${activeTab === 'admin' ? 'text-rose-500 scale-110' : ''}`}><Icon name="CheckCircle" size={24} className={activeTab === 'admin' ? 'stroke-[2.5px]' : ''}/><span>ç®¡ç†</span></button>}
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
