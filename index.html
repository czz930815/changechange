<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Love Points ❤️</title>
  
  <!-- 1. 樣式庫 (Tailwind) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- 2. 載入必要的程式庫 (React + Firebase) -->
  <!-- 使用 unpkg 來源，並加上 crossorigin 以避免 Script Error -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  
  <!-- Babel (用來翻譯 JSX) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Firebase (使用 Google 官方來源 Compat 版本) -->
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore-compat.js"></script>

  <style>
    /* 基礎設定 */
    body { background-color: #fff1f2; color: #334155; -webkit-tap-highlight-color: transparent; }
    /* 隱藏滾動條 */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    /* 載入動畫 */
    #root { opacity: 0; transition: opacity 0.5s ease-in; }
    #root.loaded { opacity: 1; }
    /* 錯誤訊息樣式 */
    #error-box { display: none; padding: 20px; background: #fee2e2; color: #991b1b; text-align: center; margin: 20px; border-radius: 10px; }
  </style>
</head>
<body>

  <!-- 錯誤顯示區 -->
  <div id="error-box"></div>

  <!-- React 掛載點 -->
  <div id="root"></div>

  <!-- 載入中提示 -->
  <div id="loading" style="position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); text-align:center; color:#f43f5e; font-weight:bold;">
    <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="currentColor" style="margin:0 auto 10px; display:block; animation: pulse 1s infinite;">
      <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z" />
    </svg>
    啟動中...<br>
    <span style="font-size:12px; opacity:0.7; color:#666;">請確保網址不是 file:// 開頭</span>
  </div>

  <script>
    // 檢查是否為 file:// 協議
    if (window.location.protocol === 'file:') {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('error-box').style.display = 'block';
      document.getElementById('error-box').innerHTML = `
        <h3 style="font-size:20px;">⚠️ 無法直接開啟</h3>
        <p>請將此檔案上傳至 GitHub 並使用 GitHub Pages 開啟。</p>
        <p>瀏覽器安全限制禁止直接讀取本地檔案。</p>
      `;
    }
  </script>

  <!-- 主程式 -->
  <script type="text/babel">
    try {
      // 1. 確保 React 已載入
      const { useState, useEffect } = React;
      
      // 2. Firebase 設定
      const firebaseConfig = {
        apiKey: "AIzaSyBAizT0ijN3-uxegV4w2HX6VFvXvYndc3c",
        authDomain: "change-389a0.firebaseapp.com",
        projectId: "change-389a0",
        storageBucket: "change-389a0.firebasestorage.app",
        messagingSenderId: "360528719647",
        appId: "1:360528719647:web:474055ac8fb26e370c0a2a"
      };

      // 3. 初始化 Firebase
      if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
      }
      const auth = firebase.auth();
      const db = firebase.firestore();
      const DATA_COLLECTION = "love_points_data_v1";

      // 4. 圖示元件
      const Icon = ({ name, size = 24, className = "" }) => {
        const icons = {
          Heart: <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z" />,
          Camera: <path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/>,
          Gift: <rect x="3" y="8" width="18" height="4" rx="1"/><path d="M12 8v13"/><path d="M19 12v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-7"/><path d="M7.5 8a2.5 2.5 0 0 1 0-5A4.8 8 0 0 1 12 8a4.8 8 0 0 1 4.5-5 2.5 2.5 0 0 1 0 5"/>,
          Bell: <path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/>,
          Lock: <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/>,
          LogOut: <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/>,
          CheckCircle: <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>,
          Plus: <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>,
          Trash2: <polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/>,
          Sparkles: <path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M3 5h4"/><path d="M3 9h4"/>,
          Clock: <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>,
          XCircle: <circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/>,
          ChevronRight: <path d="m9 18 6-6-6-6"/>
        };
        return (
          <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
            {icons[name] || null}
          </svg>
        );
      };

      // 5. 圖片壓縮
      const compressImage = (file) => {
        return new Promise((resolve) => {
          const reader = new FileReader();
          reader.readAsDataURL(file);
          reader.onload = (e) => {
            const img = new Image();
            img.src = e.target.result;
            img.onload = () => {
              const canvas = document.createElement('canvas');
              const MAX_WIDTH = 600; 
              const scale = MAX_WIDTH / img.width;
              canvas.width = MAX_WIDTH;
              canvas.height = img.height * scale;
              const ctx = canvas.getContext('2d');
              ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
              resolve(canvas.toDataURL('image/jpeg', 0.6));
            };
          };
        });
      };

      // 6. 主程式
      function App() {
        // 通知載入完成
        useEffect(() => {
          document.getElementById('loading').style.display = 'none';
          document.getElementById('root').classList.add('loaded');
        }, []);

        const [user, setUser] = useState(null);
        const [activeTab, setActiveTab] = useState('home');
        const [isAdmin, setIsAdmin] = useState(false);
        const [points, setPoints] = useState(0);
        const [submissions, setSubmissions] = useState([]);
        const [rewards, setRewards] = useState([]);
        const [notifications, setNotifications] = useState([]);
        const [unreadCount, setUnreadCount] = useState(0);

        const [desc, setDesc] = useState('');
        const [selectedFile, setSelectedFile] = useState(null);
        const [isUploading, setIsUploading] = useState(false);
        const [wishName, setWishName] = useState('');
        const [wishImage, setWishImage] = useState(null);
        const [showWishForm, setShowWishForm] = useState(false);
        const [pricingId, setPricingId] = useState(null);
        const [pricingCost, setPricingCost] = useState('');
        const [adminPass, setAdminPass] = useState('');
        const [showAdminLogin, setShowAdminLogin] = useState(false);

        useEffect(() => {
          auth.signInAnonymously().catch(e => console.error(e));
          if ("Notification" in window && Notification.permission === "default") {
            Notification.requestPermission();
          }
          return auth.onAuthStateChanged(setUser);
        }, []);

        useEffect(() => {
          if (!user) return;
          const unsubStats = db.collection(DATA_COLLECTION).doc('stats').onSnapshot(d => {
            setPoints(d.exists ? (d.data().totalPoints || 0) : 0);
            if (!d.exists) db.collection(DATA_COLLECTION).doc('stats').set({ totalPoints: 0 });
          });
          const unsubSubs = db.collection(DATA_COLLECTION).collection('submissions').orderBy('timestamp', 'desc').onSnapshot(s => setSubmissions(s.docs.map(d => ({id:d.id, ...d.data()}))));
          const unsubRewards = db.collection(DATA_COLLECTION).collection('rewards').onSnapshot(s => {
             const d = s.docs.map(d => ({id:d.id, ...d.data()}));
             d.sort((a,b) => (a.available===b.available) ? (a.cost-b.cost) : (a.available?-1:1));
             setRewards(d);
          });
          const unsubNotifs = db.collection(DATA_COLLECTION).collection('notifications').orderBy('timestamp', 'desc').onSnapshot(s => {
            const d = s.docs.map(doc => ({id:doc.id, ...doc.data()}));
            setNotifications(d);
            setUnreadCount(d.filter(n => !n.readBy || !n.readBy.includes(user.uid)).length);
          });
          return () => { unsubStats(); unsubSubs(); unsubRewards(); unsubNotifs(); };
        }, [user]);

        // 功能
        const sendNotif = async (title, body) => db.collection(DATA_COLLECTION).collection('notifications').add({
          title, body, from: user.uid, timestamp: firebase.firestore.FieldValue.serverTimestamp(), readBy: [user.uid]
        });

        const handleUploadTask = async () => {
          if (!desc.trim() || !selectedFile) return alert("請輸入並拍照！");
          setIsUploading(true);
          try {
            const img = await compressImage(selectedFile);
            await db.collection(DATA_COLLECTION).collection('submissions').add({
