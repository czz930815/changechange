<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Point</title>
  
  <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@300;400;700&display=swap" rel="stylesheet">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <style>
    * { font-family: 'M PLUS Rounded 1c', sans-serif !important; }
    
    body { 
      background-color: #f8fafc; 
      color: #334e68; 
      -webkit-tap-highlight-color: transparent; 
      font-weight: 300; 
      overflow-x: hidden; 
    }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    #root { opacity: 0; transition: opacity 0.5s ease-in; }
    #root.loaded { opacity: 1; }
    
    @keyframes floating { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
    .animate-float { animation: floating 4s ease-in-out infinite; }
    
    img { display: block; max-width: 100%; height: auto; border-radius: 12px; }
    
    .premium-blue-gradient { background: linear-gradient(135deg, #475569 0%, #0ea5e9 100%); }
    .glass-card { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(8px); border: 1px solid rgba(255, 255, 255, 0.2); }
    .point-glass-card { 
      background: rgba(255, 255, 255, 0.15); 
      backdrop-filter: blur(12px); 
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.15);
    }
    
    .coupon-card {
      background: white;
      border: 1.5px dashed #0ea5e9;
      border-radius: 16px;
      position: relative;
      overflow: hidden;
      transition: all 0.4s ease;
    }
    .coupon-card::before, .coupon-card::after {
      content: '';
      position: absolute;
      width: 16px;
      height: 16px;
      background: #f8fafc;
      border-radius: 50%;
      top: 50%;
      transform: translateY(-50%);
      z-index: 10;
    }
    .coupon-card::before { left: -8px; border-right: 1.5px dashed #0ea5e9; }
    .coupon-card::after { right: -8px; border-left: 1.5px dashed #0ea5e9; }
    .coupon-used { filter: grayscale(1); opacity: 0.5; border-color: #cbd5e1; }

    .scratch-grid-cell {
      aspect-ratio: 1/1;
      background: #e2e8f0;
      border-radius: 12px;
      position: relative;
      overflow: hidden;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
      border: 2px solid white;
    }
    .scratch-canvas {
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      cursor: crosshair;
      touch-action: none;
      z-index: 5;
    }
    .scratch-content {
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      display: flex; align-items: center; justify-content: center;
      font-weight: 700; font-size: 1.2rem;
      z-index: 1; background: white;
      color: #0ea5e9;
    }

    .btn-action {
      background: #0ea5e9;
      color: white;
      transition: all 0.3s ease;
      font-weight: 400;
      border-radius: 12px;
    }
    .btn-action:active { transform: scale(0.96); }
    
    .marquee { white-space: nowrap; overflow: hidden; box-sizing: border-box; }
    .marquee span { display: inline-block; padding-left: 100%; animation: marquee 15s linear infinite; }
    @keyframes marquee { 0% { transform: translate(0, 0); } 100% { transform: translate(-100%, 0); } }

    input, textarea { font-weight: 300 !important; }
    button { font-weight: 400 !important; }
    .log-item { border-bottom: 1px solid #f1f5f9; }
    .log-item:last-child { border-bottom: none; }
    
    /* Loading Screen Styles */
    #loading-screen {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: #f8fafc; display: flex; flex-direction: column;
      align-items: center; justify-content: center; z-index: 100;
      transition: opacity 0.5s ease;
    }
    .loading-icon { font-size: 40px; margin-bottom: 10px; }
    .loading-text { letter-spacing: 2px; font-size: 13px; color: #94a3b8; }
    .retry-btn { margin-top: 20px; padding: 8px 16px; border: 1px solid #cbd5e1; border-radius: 8px; color: #64748b; font-size: 12px; cursor: pointer; display: none; }
  </style>
</head>
<body>

  <div id="root"></div>

  <div id="loading-screen">
    <div class="animate-float loading-icon">ğŸ›’</div>
    <div class="loading-text" id="loading-msg">æ­£åœ¨é€£ç·šè‡³æ‡‰æœ‰ç›¡æœ‰å¤§è¶…å•†...</div>
    <button class="retry-btn" id="retry-btn" onclick="window.location.reload()">é‡æ–°é€£ç·š</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, updateDoc, collection, onSnapshot, addDoc, increment, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    try {
      // å®šç¾©å‚™ç”¨é…ç½® (ä¾†è‡ªæ‚¨æä¾›çš„åŸå§‹ä»£ç¢¼)
      const fallbackConfig = {
        apiKey: "AIzaSyBAizT0ijN3-uxegV4w2HX6VFvXvYndc3c",
        authDomain: "change-389a0.firebaseapp.com",
        projectId: "change-389a0",
        storageBucket: "change-389a0.firebasestorage.app",
        messagingSenderId: "360528719647",
        appId: "1:360528719647:web:474055ac8fb26e370c0a2a"
      };

      let firebaseConfig;
      let finalAppId;

      // å˜—è©¦ä½¿ç”¨ç’°å¢ƒè®Šæ•¸ï¼Œå¦‚æœæ²’æœ‰å‰‡ä½¿ç”¨å‚™ç”¨é…ç½®
      if (typeof __firebase_config !== 'undefined') {
        try {
          firebaseConfig = JSON.parse(__firebase_config);
          finalAppId = typeof __app_id !== 'undefined' ? __app_id : "default-app";
        } catch (e) {
          console.warn("Parsing env config failed, using fallback");
          firebaseConfig = fallbackConfig;
          finalAppId = "love-sync-v1";
        }
      } else {
        console.warn("Env config undefined, using fallback");
        firebaseConfig = fallbackConfig;
        finalAppId = "love-sync-v1";
      }

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // å°‡ Firebase åŠŸèƒ½æ›è¼‰åˆ° window
      window.fb = { 
        db, auth, doc, setDoc, updateDoc, collection, onSnapshot, addDoc, 
        increment, serverTimestamp, deleteDoc, appId: finalAppId, 
        signInAnonymously, onAuthStateChanged, signInWithCustomToken,
        isReady: true
      };
      
      // é è¨­åˆå§‹åŒ–ç™»å…¥
      (async () => {
        try {
          if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
             await signInWithCustomToken(auth, __initial_auth_token);
          } else {
             await signInAnonymously(auth);
          }
        } catch (e) {
          console.error("Auth init failed", e);
          document.getElementById('loading-msg').innerText = "ç™»å…¥é©—è­‰å¤±æ•—ï¼Œè«‹é‡è©¦";
          document.getElementById('retry-btn').style.display = 'block';
        }
      })();
    } catch (err) {
      console.error("Firebase init failed", err);
      document.getElementById('loading-msg').innerText = "ç³»çµ±åˆå§‹åŒ–å¤±æ•—";
      document.getElementById('retry-btn').style.display = 'block';
    }
    
    // è¶…æ™‚è™•ç†
    setTimeout(() => {
      const ls = document.getElementById('loading-screen');
      if (ls && ls.style.display !== 'none' && !window.fb?.isReady) {
         document.getElementById('loading-msg').innerText = "é€£ç·šå›æ‡‰è¼ƒæ…¢...";
         document.getElementById('retry-btn').style.display = 'block';
      }
    }, 8000);
  </script>

  <script type="text/babel">
    const { useState, useEffect, useRef, Fragment } = React;

    // --- åœ–ç¤ºå…ƒä»¶ ---
    const Icon = ({ name, size = 24, className = "" }) => {
      const icons = {
        Point: <path d="M6 2L3 6V20A2 2 0 0 0 5 22H19A2 2 0 0 0 21 20V6L18 2H6ZM3 6H21M16 10A4 4 0 0 1 8 10" />,
        Camera: (<Fragment><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></Fragment>),
        Gift: (<Fragment><rect x="3" y="8" width="18" height="4" rx="1"/><path d="M12 8v13M19 12v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-7M7.5 8a2.5 2.5 0 0 1 0-5A4.8 8 0 0 1 12 8a4.8 8 0 0 1 4.5-5 2.5 2.5 0 0 1 0 5"/></Fragment>),
        Bell: (<Fragment><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></Fragment>),
        Lock: (<Fragment><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></Fragment>),
        LogOut: (<Fragment><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></Fragment>),
        Trash2: (<Fragment><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></Fragment>),
        Ticket: (<Fragment><path d="M2 9V5a2 2 0 0 1 2-2h16a2 2 0 0 1 2-2v4a2 2 0 0 0 0 4v4a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2v-4a2 2 0 0 0 0-4Z"/><path d="M13 3v18M9 3v18M15 3v18"/></Fragment>),
        Store: (<Fragment><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><path d="M9 22V12h6v10"/></Fragment>),
        Chart: (<Fragment><path d="M12 20V10M18 20V4M6 20v-4"/></Fragment>),
        Check: <polyline points="20 6 9 17 4 12"/>,
        Alert: (<Fragment><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></Fragment>),
        History: (<Fragment><path d="M12 8v4l3 3"/><circle cx="12" cy="12" r="10"/></Fragment>),
        Sparkles: (<Fragment><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1-1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4M9 3v4M3 5h4M3 9h4"/></Fragment>),
        Image: (<Fragment><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></Fragment>),
        Plus: (<Fragment><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></Fragment>),
        Dice: (<Fragment><rect x="2" y="2" width="20" height="20" rx="5" ry="5"/><circle cx="8.5" cy="8.5" r="1.5"/><circle cx="15.5" cy="15.5" r="1.5"/><circle cx="8.5" cy="15.5" r="1.5"/><circle cx="15.5" cy="8.5" r="1.5"/></Fragment>),
        Calendar: (<Fragment><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></Fragment>),
        XCircle: (<Fragment><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></Fragment>),
        ArrowLeft: (<Fragment><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></Fragment>)
      };
      return (
        <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 24 24" fill="none" stroke="currentColor" strokeWidth="1.2" strokeLinecap="round" strokeLinejoin="round" className={className}>
          {icons[name] || null}
        </svg>
      );
    };

    // --- å–®æ ¼åˆ®åˆ®å…ƒä»¶ ---
    const ScratchCell = ({ value, canScratch, onRevealed }) => {
      const canvasRef = useRef(null);
      const [revealed, setRevealed] = useState(false);

      useEffect(() => {
        const canvas = canvasRef.current;
        if(!canvas) return;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = '#cbd5e1';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#94a3b8';
        ctx.font = 'bold 12px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('åˆ®', canvas.width/2, canvas.height/2 + 5);
      }, []);

      const handleScratch = (e) => {
        if(!canScratch || revealed) return;
        const canvas = canvasRef.current;
        const ctx = canvas.getContext('2d');
        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        const x = clientX - rect.left;
        const y = clientY - rect.top;

        ctx.globalCompositeOperation = 'destination-out';
        ctx.beginPath();
        ctx.arc(x, y, 15, 0, Math.PI * 2);
        ctx.fill();

        if(!revealed) {
          setRevealed(true);
          onRevealed(value);
        }
      };

      return (
        <div className="scratch-grid-cell">
          <div className="scratch-content">{value}</div>
          <canvas 
            ref={canvasRef} 
            className="scratch-canvas"
            width={80} height={80}
            onMouseMove={(e) => e.buttons === 1 && handleScratch(e)}
            onTouchMove={handleScratch}
            onMouseDown={handleScratch}
            onTouchStart={handleScratch}
          />
        </div>
      );
    };

    const compressImage = (file) => {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (e) => {
          const img = new Image();
          img.src = e.target.result;
          img.onload = () => {
            const canvas = document.createElement('canvas');
            const MAX_WIDTH = 300; 
            const scale = MAX_WIDTH / img.width;
            canvas.width = MAX_WIDTH;
            canvas.height = img.height * scale;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            resolve(canvas.toDataURL('image/jpeg', 0.3)); 
          };
        };
      });
    };

    // React App åˆå§‹åŒ–ç­‰å¾…
    function InitWrapper() {
      const [ready, setReady] = useState(false);
      useEffect(() => {
        const timer = setInterval(() => {
          if (window.fb && window.fb.isReady) {
            setReady(true);
            clearInterval(timer);
          }
        }, 100);
        return () => clearInterval(timer);
      }, []);

      if (!ready) return null;
      return <App />;
    }

    function App() {
      const { 
        db, auth, doc, setDoc, updateDoc, collection, onSnapshot, addDoc, 
        increment, serverTimestamp, deleteDoc, appId,
        signInAnonymously, onAuthStateChanged 
      } = window.fb;

      const [user, setUser] = useState(null);
      const [activeTab, setActiveTab] = useState('home');
      const [isAdmin, setIsAdmin] = useState(false);
      const [points, setPoints] = useState(0);
      const [stats, setStats] = useState({ totalIssued: 0, totalRedeemed: 0 });
      const [submissions, setSubmissions] = useState([]);
      const [rewards, setRewards] = useState([]);
      const [notifications, setNotifications] = useState([]);
      const [announcement, setAnnouncement] = useState('æ­¡è¿å…‰è‡¨æ‡‰æœ‰ç›¡æœ‰å¤§è¶…å•†ï¼ä»Šå¤©ä¹Ÿè¦åŠ æ²¹å–” ğŸ«§');
      const [loading, setLoading] = useState(true);

      const [desc, setDesc] = useState('');
      const [selectedFile, setSelectedFile] = useState(null);
      const [isUploading, setIsUploading] = useState(false);
      const [adminPass, setAdminPass] = useState('');
      const [showAdminLogin, setShowAdminLogin] = useState(false);

      const [wishName, setWishName] = useState('');
      const [wishImage, setWishImage] = useState(null);
      const [showWishForm, setShowWishForm] = useState(false);
      const [isWishing, setIsWishing] = useState(false);

      // Admin & Shop States
      const [adminRewardName, setAdminRewardName] = useState('');
      const [adminRewardCost, setAdminRewardCost] = useState('');
      const [adminRewardImage, setAdminRewardImage] = useState(null);
      const [isAddingReward, setIsAddingReward] = useState(false);
      const [approvalPoints, setApprovalPoints] = useState({});
      const [penaltyDesc, setPenaltyDesc] = useState('');
      const [penaltyAmount, setPenaltyAmount] = useState('');
      const [pricingId, setPricingId] = useState(null);
      const [pricingCost, setPricingCost] = useState('');

      // New Scratch States
      const [scratchActivities, setScratchActivities] = useState([]);
      const [selectedScratchGame, setSelectedScratchGame] = useState(null); // The game object currently being played
      const [canScratchNow, setCanScratchNow] = useState(false);
      
      // Admin Scratch Inputs
      const [adminScratchTitle, setAdminScratchTitle] = useState('');
      const [adminScratchCost, setAdminScratchCost] = useState('');
      const [adminScratchPrize, setAdminScratchPrize] = useState('');
      const [adminScratchTarget, setAdminScratchTarget] = useState('');
      const [adminScratchWinnerIndex, setAdminScratchWinnerIndex] = useState(null);
      const [adminScratchImage, setAdminScratchImage] = useState(null);

      // Check-in
      const [isCheckingIn, setIsCheckingIn] = useState(false);
      const [checkInImage, setCheckInImage] = useState(null);

      const getPublicRef = (name) => collection(db, 'artifacts', appId, 'public', 'data', name);

      useEffect(() => {
        return onAuthStateChanged(auth, (u) => {
          if (u) {
            setUser(u);
            setLoading(false);
            const ls = document.getElementById('loading-screen');
            if (ls) ls.style.display = 'none';
            const rt = document.getElementById('root');
            if (rt) rt.classList.add('loaded');
          }
        });
      }, [auth]);

      useEffect(() => {
        if (!user) return;
        const unsubStats = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'stats', 'total'), (d) => {
          if (d.exists()) {
            setPoints(d.data().totalPoints || 0);
            setStats({ totalIssued: d.data().totalIssued || 0, totalRedeemed: d.data().totalRedeemed || 0 });
          } else {
            setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'stats', 'total'), { totalPoints: 0, totalIssued: 0, totalRedeemed: 0 });
          }
        });
        const unsubSubs = onSnapshot(getPublicRef('submissions'), (s) => {
          setSubmissions(s.docs.map(d => ({id: d.id, ...d.data()})));
        });
        const unsubRewards = onSnapshot(getPublicRef('rewards'), (s) => {
          setRewards(s.docs.map(d => ({id: d.id, ...d.data()})));
        });
        // Listen to new scratch activities collection
        const unsubScratchActs = onSnapshot(getPublicRef('scratch_activities'), (s) => {
          setScratchActivities(s.docs.map(d => ({id: d.id, ...d.data()})));
        });
        const unsubAnnounce = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'announce'), (d) => {
          if (d.exists()) setAnnouncement(d.data().text);
        });
        const unsubNotifs = onSnapshot(getPublicRef('notifications'), (s) => {
          setNotifications(s.docs.map(d => ({id: d.id, ...d.data()})));
        });
        return () => { unsubStats(); unsubSubs(); unsubRewards(); unsubNotifs(); unsubAnnounce(); unsubScratchActs(); };
      }, [user, db, appId]);

      const deleteItem = async (colName, id, itemName) => {
        if (!confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${itemName}ã€å—ï¼Ÿ`)) return;
        try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', colName, id)); } catch (e) { alert("åˆªé™¤å¤±æ•—"); }
      };

      const checkAdmin = () => {
        if (adminPass === 'love1314') {
          setIsAdmin(true); 
          setShowAdminLogin(false); 
          setAdminPass(''); 
          setActiveTab('admin');
          alert('åº—é•·å¥½ï¼ğŸ‘‘');
        } else { 
          alert('å¯†ç¢¼ä¸å°å–” ğŸ‹'); 
        }
      };

      const handleUploadTask = async () => {
        if (!desc.trim() || !selectedFile) return alert("è¦å¯«å­—è·Ÿæ‹ç…§å–” â˜ï¸");
        setIsUploading(true);
        try {
          const imgBase64 = await compressImage(selectedFile);
          await addDoc(getPublicRef('submissions'), {
            description: desc, image: imgBase64, status: 'pending', timestamp: serverTimestamp(), userId: user.uid
          });
          setDesc(''); setSelectedFile(null); alert("æäº¤æˆåŠŸï¼");
        } catch(e){ console.error(e); alert("å¤±æ•—"); } finally { setIsUploading(false); }
      };

      const handleApprove = async (sub, customPoints) => {
        const pts = parseInt(customPoints) || 10;
        try {
          await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'submissions', sub.id), { status: 'approved', awardedPoints: pts });
          await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'stats', 'total'), { totalPoints: increment(pts), totalIssued: increment(pts) });
          alert(`æ‰¹å‡†æˆåŠŸï¼`);
        } catch(e) { alert("å¤±æ•—"); }
      };

      const handleDeductPoints = async () => {
        if (!penaltyDesc.trim() || !penaltyAmount) return alert("åŸå› æˆ–åˆ†æ•¸æ²’å¡«å–”");
        const pts = parseInt(penaltyAmount);
        try {
          await addDoc(getPublicRef('submissions'), { description: `âš ï¸ æ‰£é»ï¼š${penaltyDesc}`, status: 'deducted', awardedPoints: -pts, timestamp: serverTimestamp(), userId: user.uid });
          await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'stats', 'total'), { totalPoints: increment(-pts), totalRedeemed: increment(pts) });
          setPenaltyDesc(''); setPenaltyAmount(''); alert(`æ‰£é™¤å®Œç•¢ï¼ğŸ˜¤`);
        } catch (e) { alert("å¤±æ•—"); }
      };

      const handlePriceWish = async (wish) => {
        if (!pricingCost) return alert("è«‹è¼¸å…¥é»æ•¸");
        try {
          await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rewards', wish.id), { cost: parseInt(pricingCost), available: true });
          setPricingId(null); setPricingCost(''); alert("å®šåƒ¹ä¸Šæ¶å®Œæˆï¼ğŸ›’");
        } catch (e) { alert("å®šåƒ¹å¤±æ•—"); }
      };

      const handleAddRewardByAdmin = async () => {
        if (!adminRewardName || !adminRewardCost) return alert("è³‡è¨Šä¸å…¨");
        setIsAddingReward(true);
        try {
          let img = "https://placehold.co/400x300/e0f2fe/0ea5e9?text=STOCK";
          if (adminRewardImage) img = await compressImage(adminRewardImage);
          await addDoc(getPublicRef('rewards'), {
            name: adminRewardName, image: img, cost: parseInt(adminRewardCost), available: true, timestamp: serverTimestamp()
          });
          setAdminRewardName(''); setAdminRewardCost(''); setAdminRewardImage(null); alert("ä¸Šæ¶æˆåŠŸï¼ğŸ›’");
        } catch(e) { alert("å¤±æ•—"); } finally { setIsAddingReward(false); }
      };

      const handleMakeWish = async () => {
        if (!wishName.trim()) return alert("æƒ³è¦ä»€éº¼ï¼Ÿ");
        setIsWishing(true);
        try {
          let img = "https://placehold.co/400x300/fdf2f8/db2777?text=Wish";
          if (wishImage) img = await compressImage(wishImage);
          await addDoc(getPublicRef('rewards'), { name: wishName, image: img, cost: 0, available: false, timestamp: serverTimestamp(), userId: user.uid });
          setShowWishForm(false); setWishName(''); setWishImage(null); alert("è¨±é¡˜æˆåŠŸï¼âœ¨");
        } catch (e) { alert("å¤±æ•—"); } finally { setIsWishing(false); }
      };

      const handleRedeem = async (reward) => {
        if (points < Number(reward.cost)) return alert("é»æ•¸ä¸å¤ å•¦ ğŸ«§");
        if (!confirm(`ç¢ºå®šå…Œæ›ã€Œ${reward.name}ã€ï¼Ÿ`)) return;
        try {
          await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'stats', 'total'), { totalPoints: increment(-reward.cost), totalRedeemed: increment(reward.cost) });
          await addDoc(getPublicRef('submissions'), { description: `ğŸ å·²å…Œæ›ï¼š${reward.name}`, image: reward.image, status: 'redeemed', timestamp: serverTimestamp(), userId: user.uid, awardedPoints: -reward.cost });
          alert("å…Œæ›æˆåŠŸï¼ğŸ‰");
        } catch (e) { alert("å¤±æ•—"); }
      };

      const handleCheckIn = async () => {
        const today = new Date().toDateString();
        const hasCheckedIn = submissions.some(s => s.status === 'checkin' && new Date(s.timestamp?.seconds * 1000).toDateString() === today);
        if (hasCheckedIn) { alert("ä»Šå¤©æ‰“å¡éå›‰ï¼"); return; }
        if (!checkInImage) { alert("è«‹å…ˆä¸Šå‚³æŒ‡ç”²ä¿è­·ç…§ç‰‡å–”ï¼ğŸ“¸"); return; }

        setIsCheckingIn(true);
        try {
          const imgBase64 = await compressImage(checkInImage);
          await addDoc(getPublicRef('submissions'), { 
            description: "ğŸ’… æŒ‡ç”²ä¿è­·æ‰“å¡", 
            image: imgBase64,
            status: 'checkin', 
            awardedPoints: 2, 
            timestamp: serverTimestamp(), 
            userId: user.uid 
          });
          await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'stats', 'total'), { totalPoints: increment(2), totalIssued: increment(2) });
          alert("æ‰“å¡æˆåŠŸï¼ç²å¾— 2 é» âœ¨");
          setCheckInImage(null);
        } catch (e) { console.error(e); alert("å¤±æ•—"); } finally { setIsCheckingIn(false); }
      };

      const handlePayToScratch = async (game) => {
        if(points < game.cost) return alert("é»æ•¸ä¸è¶³ï¼");
        if(!confirm(`ç¢ºå®šèŠ± ${game.cost} é»ç©ä¸€æ¬¡ã€Œ${game.title}ã€ï¼Ÿ`)) return;
        try {
          await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'stats', 'total'), { totalPoints: increment(-game.cost), totalRedeemed: increment(game.cost) });
          await addDoc(getPublicRef('submissions'), { description: `ğŸ² åƒåŠ æ ¼å­æ¨‚ï¼š${game.title}`, status: 'scratch', awardedPoints: -game.cost, timestamp: serverTimestamp(), userId: user.uid });
          setCanScratchNow(true);
        } catch(e) { alert("å¤±æ•—"); }
      };

      const handleRevealed = async (val, game) => {
        setCanScratchNow(false);
        if(String(val) === String(game.target)) {
          alert(`ğŸ‰ å¤ªç¥å•¦ï¼æ­å–œåˆ®ä¸­ï¼š${game.prize}`);
          await addDoc(getPublicRef('submissions'), { description: `ğŸ åˆ®åˆ®æ¨‚ä¸­çï¼š${game.prize} (${game.title})`, image: game.image || "https://placehold.co/400x300/e0f2fe/0ea5e9?text=WINNER", status: 'redeemed', timestamp: serverTimestamp(), userId: user.uid, awardedPoints: 0 });
        } else { alert(`å—šï¼Œæ˜¯ ${val}... æ²’ä¸­ï¼å†ä¾†ä¸€æ¬¡ï¼ŸğŸ’ª`); }
      };

      const handleAddScratchActivity = async () => {
        if(!adminScratchTitle || !adminScratchPrize || !adminScratchTarget || adminScratchWinnerIndex === null || !adminScratchCost) return alert("è³‡æ–™ä¸å…¨");
        
        setIsAddingReward(true);
        try {
          let img = "https://placehold.co/400x300/e0f2fe/0ea5e9?text=Game";
          if (adminScratchImage) img = await compressImage(adminScratchImage);

          const grid = Array(16).fill(0).map((_, i) => i === adminScratchWinnerIndex ? adminScratchTarget : Math.floor(Math.random()*90)+10);
          
          await addDoc(getPublicRef('scratch_activities'), { 
            title: adminScratchTitle,
            prize: adminScratchPrize, 
            cost: parseInt(adminScratchCost),
            target: adminScratchTarget, 
            grid: grid, 
            image: img,
            isActive: true, 
            timestamp: serverTimestamp() 
          });
          
          // Reset fields
          setAdminScratchTitle(''); setAdminScratchPrize(''); setAdminScratchCost(''); setAdminScratchTarget(''); setAdminScratchWinnerIndex(null); setAdminScratchImage(null);
          alert("æ ¼å­æ¨‚æ´»å‹•ç™¼å¸ƒæˆåŠŸï¼");
        } catch(e) { alert("ç™¼å¸ƒå¤±æ•—"); } finally { setIsAddingReward(false); }
      };

      const handleVerifyCoupon = async (couponId) => {
        if (!confirm('ç¢ºèªæ ¸éŠ·é€™å¼µåˆ¸å—ï¼Ÿ')) return;
        try {
          await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'submissions', couponId), { status: 'verified' });
          alert("æ ¸éŠ·æˆåŠŸï¼ğŸ«§");
        } catch (e) { alert("å¤±æ•—"); }
      };

      const updateAnnounce = async () => {
        const newText = prompt("æ–°å…¬å‘Šï¼š", announcement);
        if (newText) await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'announce'), { text: newText });
      };

      const unreadCount = user ? notifications.filter(n => !n.readBy?.includes(user.uid)).length : 0;

      if (loading) return null;

      return (
        <div className="max-w-md mx-auto shadow-2xl relative min-h-screen pb-24 sm:rounded-[40px] sm:my-4 sm:border-4 sm:border-slate-200 bg-[#f8fafc] overflow-hidden flex flex-col no-scrollbar">
          
          {/* Header */}
          <div className="premium-blue-gradient p-5 pb-6 text-white rounded-b-[35px] shadow-lg shrink-0 z-10 relative">
            <div className="flex justify-between items-center mb-4">
              <div className="flex items-center gap-2 border-l-4 border-sky-400 pl-3">
                <Icon name="Point" size={18} className="text-white/90" />
                <h1 className="text-xl font-bold tracking-tighter uppercase italic opacity-90">Point</h1>
              </div>
              <div className="flex items-center gap-2">
                <button onClick={() => setActiveTab('notifs')} className="relative p-2 bg-white/10 rounded-xl transition-all">
                  <Icon name="Bell" size={18} />
                  {unreadCount > 0 && <span className="absolute -top-1 -right-1 bg-red-500 text-white text-[8px] font-black w-4 h-4 rounded-full flex items-center justify-center border border-white">!</span>}
                </button>
                <button onClick={() => isAdmin ? setIsAdmin(false) : setShowAdminLogin(!showAdminLogin)} className="p-2 bg-white/10 rounded-xl active:scale-90 transition-all">
                  <Icon name={isAdmin ? "LogOut" : "Lock"} size={18} />
                </button>
              </div>
            </div>
            
            <div className="flex justify-center mb-3">
              <div className="point-glass-card px-8 py-3 rounded-full flex items-center gap-4 shadow-xl">
                <span className="text-4xl font-bold text-white drop-shadow-md">{points}</span>
                <span className="text-[10px] font-bold text-sky-100 uppercase tracking-widest pl-4 border-l border-white/20">é»æ•¸é¤˜é¡</span>
              </div>
            </div>
            
            <div className="bg-white/10 rounded-lg px-3 py-1 marquee mx-2">
              <span className="text-[10px] font-medium text-sky-50 italic">{announcement}</span>
            </div>
            
            {showAdminLogin && !isAdmin && (
              <div className="absolute top-20 right-6 bg-white p-6 rounded-[25px] shadow-2xl z-50 w-64 text-slate-800 animate-in">
                <input type="password" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" className="w-full bg-slate-50 border-none p-4 rounded-2xl mb-4 text-sm focus:ring-1 focus:ring-sky-200 outline-none font-light" value={adminPass} onChange={(e) => setAdminPass(e.target.value)} autoFocus />
                <button onClick={checkAdmin} className="w-full premium-blue-gradient text-white py-3 rounded-2xl font-bold text-xs shadow-lg">ç™»å…¥ç®¡ç†</button>
              </div>
            )}
          </div>

          <div className="p-5 flex-1 overflow-y-auto no-scrollbar">
            
            {/* æ´»å‹•åˆ†é  */}
            {activeTab === 'activities' && (
              <div className="space-y-6 animate-in">
                {/* æ‰“å¡å€ */}
                {!selectedScratchGame ? (
                  <>
                    <div className="bg-white p-6 rounded-[35px] border border-slate-100 shadow-sm flex flex-col gap-4">
                       <div className="flex items-center gap-4">
                          <div className="bg-rose-50 p-4 rounded-2xl text-rose-500"><Icon name="Sparkles" size={24}/></div>
                          <div>
                            <p className="font-bold text-slate-700 text-sm">æŒ‡ç”²ä¿è­·æ‰“å¡</p>
                            <p className="text-[10px] text-slate-400 font-medium mt-1">ä¸Šå‚³ç…§ç‰‡è­‰æ˜ï¼Œé ˜å– 2 é»</p>
                          </div>
                       </div>
                       
                       <label className={`w-full py-3 rounded-2xl border-2 border-dashed flex items-center justify-center cursor-pointer transition-colors ${checkInImage ? 'border-rose-300 text-rose-500 bg-rose-50' : 'border-slate-100 text-slate-300 hover:border-slate-200'}`}>
                          <Icon name="Camera" size={18} className="mr-2"/>
                          <span className="text-xs font-bold">{checkInImage ? 'å·²é¸æ“‡ç…§ç‰‡' : 'é»æ“Šæ‹æ”/ä¸Šå‚³'}</span>
                          <input type="file" accept="image/*" className="hidden" onChange={(e) => setCheckInImage(e.target.files[0])} />
                       </label>

                       <button onClick={handleCheckIn} disabled={isCheckingIn} className={`btn-action w-full py-3 rounded-xl text-xs font-bold shadow-md transition-all ${!checkInImage ? 'opacity-50 cursor-not-allowed bg-slate-400' : 'bg-rose-400 hover:bg-rose-500'}`}>
                         {isCheckingIn ? 'ä¸Šå‚³ä¸­...' : 'æ‰“å¡é ˜é»æ•¸'}
                       </button>
                    </div>

                    <h3 className="font-bold text-slate-800 flex items-center gap-2 px-2 mt-4"><Icon name="Dice" className="text-sky-500" size={18}/> é¸æ“‡æ ¼å­æ¨‚æ´»å‹•</h3>
                    {scratchActivities.length === 0 ? (
                      <div className="text-center py-10 bg-white rounded-[35px] border-2 border-dashed border-slate-100 italic text-slate-300 text-xs">
                         ç›®å‰æ²’æœ‰é€²è¡Œä¸­çš„æ´»å‹• ğŸ’¤
                      </div>
                    ) : (
                      <div className="grid grid-cols-1 gap-4">
                        {scratchActivities.map(game => (
                          <div key={game.id} onClick={() => setSelectedScratchGame(game)} className="bg-white p-4 rounded-[30px] border border-slate-100 shadow-sm hover:shadow-md transition-all flex items-center gap-4 cursor-pointer group">
                             <div className="w-16 h-16 rounded-2xl bg-slate-50 overflow-hidden shrink-0 border border-slate-100">
                               {game.image && <img src={game.image} className="w-full h-full object-cover group-hover:scale-110 transition-transform"/>}
                             </div>
                             <div className="flex-1 min-w-0">
                               <h4 className="font-bold text-slate-700 text-sm truncate">{game.title}</h4>
                               <p className="text-[10px] text-slate-400 mt-1">å¤§çï¼š{game.prize}</p>
                             </div>
                             <div className="bg-sky-50 text-sky-600 px-3 py-1.5 rounded-xl text-xs font-bold whitespace-nowrap">
                               {game.cost} é»/æ¬¡
                             </div>
                          </div>
                        ))}
                      </div>
                    )}
                  </>
                ) : (
                  // æ ¼å­æ¨‚éŠæˆ²ç•«é¢
                  <div className="bg-white p-6 rounded-[35px] border-2 border-sky-100 shadow-xl shadow-sky-500/5 animate-in">
                    <button onClick={() => {setSelectedScratchGame(null); setCanScratchNow(false);}} className="mb-4 text-slate-400 hover:text-slate-600 flex items-center text-xs font-bold"><span className="mr-1"><Icon name="ArrowLeft" size={14}/></span> è¿”å›åˆ—è¡¨</button>
                    
                    <div className="text-center mb-6">
                      <h2 className="font-bold text-slate-800 text-lg mb-1">{selectedScratchGame.title}</h2>
                      <p className="text-xs text-slate-400">èŠ±è²» {selectedScratchGame.cost} é»ï¼Œå°‹æ‰¾æ•¸å­— <span className="font-bold text-sky-500 text-sm">{selectedScratchGame.target}</span></p>
                    </div>

                    {!canScratchNow ? (
                      <div className="text-center py-8">
                        <div className="w-20 h-20 bg-sky-50 rounded-full mx-auto flex items-center justify-center text-sky-500 mb-4 animate-bounce"><Icon name="Lock" size={32}/></div>
                        <button onClick={() => handlePayToScratch(selectedScratchGame)} className="w-full btn-action py-4 font-bold shadow-lg shadow-sky-100 mb-2">æ”¯ä»˜ {selectedScratchGame.cost} é»é–‹å§‹</button>
                        <p className="text-[10px] text-slate-300">æ”¯ä»˜å¾Œé»æ“Šä»»æ„æ ¼å­å³å¯</p>
                      </div>
                    ) : (
                      <div className="grid grid-cols-4 gap-2 animate-in">
                         {selectedScratchGame.grid.map((val, i) => (
                           <ScratchCell key={i} value={val} canScratch={canScratchNow} onRevealed={(v) => handleRevealed(v, selectedScratchGame)} />
                         ))}
                      </div>
                    )}
                  </div>
                )}
              </div>
            )}

            {/* é›†é»åˆ†é  */}
            {activeTab === 'home' && (
              <div className="space-y-6 animate-in">
                <div className="bg-white p-6 rounded-[30px] border border-slate-100 shadow-sm transition-all hover:shadow-md">
                  <h3 className="font-bold text-slate-800 mb-4 flex gap-2 items-center"><Icon name="Plus" size={18} className="text-sky-500"/> è³ºé»è³ºè³ºè³º</h3>
                  <textarea className="w-full bg-slate-50 p-5 rounded-[20px] border-none text-sm min-h-[90px] outline-none focus:ring-1 focus:ring-sky-100 transition-all font-light" placeholder="ä»Šå¤©æœ‰ä»€éº¼å€¼å¾—åŠ é»æ•¸çš„..." value={desc} onChange={(e) => setDesc(e.target.value)} />
                  <div className="flex gap-4 mt-6">
                    <label className={`flex-[1.5] cursor-pointer py-3.5 rounded-3xl flex items-center justify-center border-2 border-dashed ${selectedFile ? 'border-sky-300 text-sky-600' : 'text-slate-300'}`}>
                      <Icon name="Image" size={16} className="mr-2"/> <span className="text-xs font-bold">{selectedFile ? 'å·²é¸å¥½' : 'ä¸Šå‚³è­‰æ˜'}</span>
                      <input type="file" accept="image/*" className="hidden" onChange={(e) => setSelectedFile(e.target.files[0])} />
                    </label>
                    <button onClick={handleUploadTask} disabled={isUploading} className="flex-1 btn-action py-3.5 rounded-3xl font-bold shadow-md text-xs">é€å‡º</button>
                  </div>
                </div>

                <div className="space-y-4">
                   <h3 className="text-[10px] font-bold text-slate-400 uppercase tracking-[0.2em] px-2 flex items-center gap-2"><Icon name="Ticket" size={14} className="text-sky-500"/> æˆ‘çš„å…Œæ›åˆ¸</h3>
                   <div className="flex flex-col gap-3">
                     {submissions.filter(s => s.status === 'redeemed' || s.status === 'verified').length === 0 && <p className="text-center text-[11px] text-slate-300 py-6 bg-white rounded-[25px] border-2 border-dashed border-slate-50 italic">ç›®å‰é‚„æ²’æœ‰å…Œæ›åˆ¸</p>}
                     {submissions.filter(s => s.status === 'redeemed' || s.status === 'verified').map(coupon => (
                       <div key={coupon.id} className={`coupon-card p-4 flex items-center gap-4 shadow-sm ${coupon.status === 'verified' ? 'coupon-used' : ''}`}>
                         <div className="w-14 h-14 bg-slate-50 rounded-xl overflow-hidden shrink-0 border border-sky-100 relative shadow-inner">
                           {coupon.image && <img src={coupon.image} className="w-full h-full object-cover" />}
                           {coupon.status === 'verified' && <div className="absolute inset-0 flex items-center justify-center bg-black/40 text-white font-bold text-[8px]">å·²æ ¸éŠ·</div>}
                         </div>
                         <div className="flex-1 min-w-0">
                           <p className="text-sm font-bold text-slate-700 truncate">{coupon.description.replace('ğŸ å·²å…Œæ›ï¼š', '').replace('ğŸ åˆ®åˆ®æ¨‚ä¸­çï¼š', '')}</p>
                           <p className="text-[10px] text-sky-500 font-bold mt-0.5 uppercase tracking-tighter italic">{coupon.status === 'verified' ? 'æ ¸éŠ·å®Œç•¢' : 'Valid at æ‡‰æœ‰ç›¡æœ‰å¤§è¶…å•†'}</p>
                         </div>
                         <button onClick={() => deleteItem('submissions', coupon.id, 'é€™å¼µç´€éŒ„')} className="text-slate-200 hover:text-red-400 transition-colors p-2"><Icon name="Trash2" size={16}/></button>
                       </div>
                     ))}
                   </div>
                </div>

                <div className="space-y-4">
                  <h3 className="text-[10px] font-bold text-slate-400 uppercase tracking-[0.2em] px-2 flex items-center gap-2"><Icon name="History" size={14} className="text-sky-500"/> é»æ•¸æ”¶æ”¯å­˜æ‘º</h3>
                  <div className="bg-white rounded-[25px] border border-slate-100 shadow-sm overflow-hidden">
                    {submissions.filter(s => ['approved', 'deducted', 'redeemed', 'scratch', 'checkin'].includes(s.status)).length === 0 ? <p className="text-center text-[11px] text-slate-300 py-10 italic">å°šç„¡æ˜ç´°</p> : (
                      <div className="flex flex-col">
                        {submissions.filter(s => ['approved', 'deducted', 'redeemed', 'scratch', 'checkin'].includes(s.status)).map(item => (
                          <div key={item.id} className="log-item p-4 flex justify-between items-center bg-white">
                            <div className="flex flex-col min-w-0">
                              <span className="text-[9px] text-slate-300 font-bold uppercase">{item.timestamp ? new Date(item.timestamp.seconds * 1000).toLocaleDateString() : 'å‰›å‰›'}</span>
                              <p className="text-xs font-medium text-slate-600 truncate pr-2">
                                {item.description.replace('ğŸ å·²å…Œæ›ï¼š', 'å…Œæ›: ').replace('âš ï¸ æ‰£é»ï¼š', 'æ‰£é»: ').replace('ğŸ² åƒåŠ ', 'æ´»å‹•: ').replace('ğŸ åˆ®åˆ®æ¨‚ä¸­çï¼š', 'ä¸­ç: ')}
                              </p>
                            </div>
                            <div className={`text-sm font-bold shrink-0 ${item.awardedPoints > 0 ? 'text-emerald-500' : 'text-red-400'}`}>
                              {item.awardedPoints > 0 ? `+${item.awardedPoints}` : item.awardedPoints} P
                            </div>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                </div>
              </div>
            )}

            {/* å…Œæ›åˆ†é  */}
            {activeTab === 'rewards' && (
              <div className="space-y-6 animate-in">
                <div className="bg-white p-6 rounded-[35px] border border-slate-100 shadow-sm relative overflow-hidden group">
                  <Icon name="Sparkles" className="absolute top-2 right-2 text-sky-50 group-hover:rotate-12 transition-transform" size={80} />
                  <h2 className="font-bold text-lg mb-1 flex items-center gap-2 text-slate-800">è¨±é¡˜æ±  âœ¨</h2>
                  <p className="text-xs text-slate-500 mb-5 font-medium">æƒ³è¦ä»€éº¼æ–°å•†å“å—ï¼Ÿæ‹ä¸‹ä¾†å‘Šè¨´åº—é•·å§ï¼</p>
                  {!showWishForm ? (
                    <button onClick={() => setShowWishForm(true)} className="btn-action px-6 py-3 text-xs font-bold shadow-md w-full sm:w-auto">è£é€²æ¸…å–® +</button>
                  ) : (
                    <div className="space-y-4 animate-in slide-in-from-top duration-300">
                      <input className="w-full bg-slate-50 border border-slate-100 rounded-xl p-4 text-slate-700 text-sm outline-none focus:ring-1 focus:ring-sky-200" placeholder="æƒ³æ›ä»€éº¼ï¼Ÿ" value={wishName} onChange={(e) => setWishName(e.target.value)} />
                      <label className="flex items-center justify-center py-5 rounded-xl bg-slate-50 border border-slate-100 border-dashed cursor-pointer hover:bg-slate-100 transition-all">
                        <Icon name="Camera" size={20} className="mr-2 text-slate-400"/><span className="text-xs font-bold text-slate-400">{wishImage ? 'å·²é¸å¥½åœ–' : 'ä¸Šå‚³åƒè€ƒåœ–'}</span><input type="file" accept="image/*" className="hidden" onChange={(e) => setWishImage(e.target.files[0])} /></label>
                      <div className="flex gap-2"><button onClick={() => setShowWishForm(false)} className="flex-1 text-xs font-bold py-3.5 bg-slate-50 text-slate-400 rounded-xl">å–æ¶ˆ</button><button onClick={handleMakeWish} className="flex-1 text-xs font-bold py-3.5 btn-action shadow-lg">é€å‡ºé¡˜æœ›</button></div>
                    </div>
                  )}
                </div>

                <div className="space-y-4">
                  <h2 className="font-bold text-slate-800 text-lg flex gap-2 items-center px-1 mb-2"><Icon name="Store" className="text-sky-500" size={20}/> åº—å…§ç¾è²¨</h2>
                  {rewards.filter(r => r.available).map(r => (
                    <div key={r.id} className="bg-white banner-card border border-slate-100 shadow-md flex h-36 group overflow-hidden transition-all hover:shadow-lg relative">
                      {isAdmin && (
                        <button onClick={() => deleteItem('rewards', r.id, r.name)} className="absolute top-2 right-2 z-20 bg-white/80 backdrop-blur-md p-2 rounded-full text-slate-200 hover:text-red-500 transition-all"><Icon name="Trash2" size={14}/></button>
                      )}
                      <div className="w-2/5 bg-slate-50 relative shrink-0 overflow-hidden rounded-[16px] m-3 shadow-inner">
                        {r.image && <img src={r.image} className={`w-full h-full object-cover transition-transform duration-1000 group-hover:scale-110`} />}
                      </div>
                      <div className="flex-1 p-5 pl-2 flex flex-col justify-between min-w-0 bg-white">
                        <div><h4 className="text-sm font-bold text-slate-700 truncate pr-6 leading-tight">{r.name}</h4>{r.available && <p className="text-[10px] text-sky-500 font-bold mt-1 uppercase tracking-widest">{r.cost} P Needs</p>}</div>
                        <button onClick={() => r.available && handleRedeem(r)} disabled={!r.available || points < Number(r.cost)} className={`w-full py-2.5 rounded-xl text-[10px] font-bold transition-all ${r.available && points >= Number(r.cost) ? 'btn-action shadow-md shadow-sky-50' : 'bg-slate-50 text-slate-300'}`}>{r.available ? (points >= Number(r.cost) ? 'ç«‹å³å…Œæ›' : 'é»æ•¸ä¸è¶³') : 'ç­‰å€™å®šåƒ¹'}</button>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* ç®¡ç†åˆ†é  */}
            {activeTab === 'admin' && isAdmin && (
              <div className="space-y-6 pb-10 animate-in">
                <div className="premium-blue-gradient p-6 rounded-[30px] text-white shadow-lg relative overflow-hidden">
                  <div className="absolute -right-4 -bottom-4 opacity-10 rotate-12"><Icon name="Chart" size={120}/></div>
                  <h2 className="text-sm font-bold flex gap-2 items-center mb-4"><Icon name="Chart" size={18}/> ç‡Ÿé‹å ±è¡¨çµ±è¨ˆ</h2>
                  <div className="grid grid-cols-2 gap-4">
                    <div className="glass-card p-4 rounded-2xl">
                      <p className="text-[9px] font-bold text-sky-200 uppercase tracking-widest mb-1">ç´¯ç©ç™¼è¡Œ</p>
                      <p className="text-2xl font-bold">{stats.totalIssued}</p>
                    </div>
                    <div className="glass-card p-4 rounded-2xl">
                      <p className="text-[9px] font-bold text-sky-200 uppercase tracking-widest mb-1">ç´¯ç©å›æ”¶</p>
                      <p className="text-2xl font-bold">{stats.totalRedeemed}</p>
                    </div>
                  </div>
                  <button onClick={updateAnnounce} className="w-full mt-4 bg-white/20 py-2 rounded-xl text-[10px] font-bold">ä¿®æ”¹é–€å¸‚è·‘é¦¬ç‡ˆ</button>
                </div>

                <div className="bg-white p-7 rounded-[35px] border-2 border-sky-100 shadow-lg shadow-sky-500/5 space-y-4">
                  <h3 className="font-bold text-sky-800 mb-2 flex gap-2 items-center text-sm"><Icon name="Ticket" size={18}/> å»ºç«‹æ ¼å­æ¨‚æ´»å‹•</h3>
                  <div className="space-y-3">
                    <input className="w-full bg-slate-50 border border-slate-100 rounded-xl p-3 text-sm outline-none" placeholder="æ´»å‹•æ¨™é¡Œ (å¦‚ï¼šé€±æœ«å¤§æ”¾é€)" value={adminScratchTitle} onChange={(e) => setAdminScratchTitle(e.target.value)} />
                    <div className="flex gap-2">
                      <input className="w-1/2 bg-slate-50 border border-slate-100 rounded-xl p-3 text-sm outline-none" placeholder="å¤§çåç¨±" value={adminScratchPrize} onChange={(e) => setAdminScratchPrize(e.target.value)} />
                      <input type="number" className="w-1/2 bg-slate-50 border border-slate-100 rounded-xl p-3 text-sm outline-none" placeholder="æ¯æ¬¡éŠç©é»æ•¸" value={adminScratchCost} onChange={(e) => setAdminScratchCost(e.target.value)} />
                    </div>
                    <input type="number" className="w-full bg-slate-50 border border-slate-100 rounded-xl p-3 text-sm outline-none" placeholder="ä¸­çæ•¸å­— (10-99)" value={adminScratchTarget} onChange={(e) => setAdminScratchTarget(e.target.value)} />
                    
                    <label className="flex items-center gap-2 p-3 bg-slate-50 border border-slate-100 rounded-xl cursor-pointer">
                      <Icon name="Image" size={16} className="text-slate-400"/>
                      <span className="text-xs text-slate-400">{adminScratchImage ? 'å·²é¸æ“‡å°é¢åœ–' : 'ä¸Šå‚³æ´»å‹•å°é¢'}</span>
                      <input type="file" accept="image/*" className="hidden" onChange={(e) => setAdminScratchImage(e.target.files[0])} />
                    </label>

                    <p className="text-[10px] text-slate-400 mt-2 font-bold uppercase tracking-widest">è¨­å®šä¸­çä½ç½® (é»æ“Šä¸‹æ–¹):</p>
                    <div className="grid grid-cols-4 gap-2">
                       {Array(16).fill(0).map((_, i) => (
                         <button key={i} onClick={() => setAdminScratchWinnerIndex(i)} className={`aspect-square rounded-lg border-2 text-xs font-bold transition-all ${adminScratchWinnerIndex === i ? 'bg-sky-500 border-sky-600 text-white' : 'bg-slate-50 border-slate-100 text-slate-300'}`}>#{i+1}</button>
                       ))}
                    </div>
                    <button onClick={handleAddScratchActivity} disabled={isAddingReward} className="w-full py-4 btn-action font-bold text-xs shadow-lg mt-2">{isAddingReward ? 'ç™¼å¸ƒä¸­...' : 'ç™¼å¸ƒæ´»å‹•'}</button>
                  
                    <div className="border-t border-slate-100 pt-4 mt-4">
                      <p className="text-[10px] text-slate-400 font-bold mb-2">å·²ç™¼å¸ƒçš„æ´»å‹•:</p>
                      {scratchActivities.map(game => (
                        <div key={game.id} className="flex justify-between items-center bg-slate-50 p-3 rounded-xl mb-2">
                          <span className="text-xs font-bold text-slate-600">{game.title}</span>
                          <button onClick={() => deleteItem('scratch_activities', game.id, game.title)} className="text-slate-300 hover:text-red-500"><Icon name="Trash2" size={14}/></button>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>

                <div className="bg-white p-7 rounded-[35px] border-2 border-red-50 shadow-xl shadow-red-500/5 space-y-4">
                  <h3 className="font-bold text-red-500 mb-4 flex gap-2 items-center text-sm"><Icon name="Alert" size={18}/> ç½°é»å°ˆå€</h3>
                  <div className="space-y-4">
                    <input className="w-full bg-red-50/30 border-none rounded-[15px] p-4 text-sm font-light outline-none focus:ring-1 focus:ring-red-200" placeholder="æ‰£åˆ†åŸå› " value={penaltyDesc} onChange={(e) => setPenaltyDesc(e.target.value)} />
                    <input type="number" className="w-full bg-red-50/30 border-none rounded-[15px] p-4 text-sm font-light outline-none focus:ring-1 focus:ring-red-200" placeholder="é»æ•¸" value={penaltyAmount} onChange={(e) => setPenaltyAmount(e.target.value)} />
                    <button onClick={handleDeductPoints} className="w-full py-4 bg-red-500 text-white rounded-[15px] font-bold text-xs shadow-lg active:scale-95">ç¢ºèªæ‰£é» ğŸ˜¤</button>
                  </div>
                </div>

                <div className="bg-white p-7 rounded-[35px] border-2 border-indigo-100 shadow-xl shadow-indigo-500/5 space-y-4">
                  <h3 className="font-bold text-indigo-600 mb-4 flex gap-2 items-center text-sm"><Icon name="Sparkles" size={18}/> é¡˜æœ›å®šåƒ¹ä¸­å¿ƒ</h3>
                  <div className="space-y-3">
                    {rewards.filter(r => !r.available).map(wish => (
                      <div key={wish.id} className="flex items-center gap-4 p-3 bg-indigo-50/30 rounded-2xl border border-indigo-50">
                        <div className="w-12 h-12 rounded-lg bg-white overflow-hidden shrink-0 shadow-sm">{wish.image && <img src={wish.image} className="w-full h-full object-cover"/>}</div>
                        <div className="flex-1 min-w-0">
                          <p className="text-sm font-bold text-slate-700 truncate">{wish.name}</p>
                          {pricingId === wish.id ? (
                            <div className="flex gap-2 mt-2">
                              <input type="number" className="w-20 border border-indigo-200 rounded-lg p-1.5 text-xs outline-none focus:ring-1 focus:ring-indigo-400 bg-white" placeholder="é»æ•¸" value={pricingCost} onChange={(e) => setPricingCost(e.target.value)} autoFocus />
                              <button onClick={() => handlePriceWish(wish)} className="bg-indigo-500 text-white p-1.5 rounded-lg shadow-md"><Icon name="Check" size={14}/></button>
                              <button onClick={() => setPricingId(null)} className="bg-slate-100 text-slate-400 p-1.5 rounded-lg"><Icon name="XCircle" size={16}/></button>
                            </div>
                          ) : (
                            <button onClick={() => {setPricingId(wish.id); setPricingCost('');}} className="text-[10px] text-indigo-500 font-bold mt-1 underline italic">è¨­å®šé»æ•¸ä¸¦ä¸Šæ¶</button>
                          )}
                        </div>
                        <button onClick={() => deleteItem('rewards', wish.id, wish.name)} className="text-slate-300 hover:text-red-400"><Icon name="Trash2" size={16}/></button>
                      </div>
                    ))}
                  </div>
                </div>

                <div className="space-y-4">
                  <h3 className="text-[9px] font-bold text-slate-400 px-3 uppercase tracking-[0.2em]">å¾…æ ¸å‡†è³ºé»å›å ±</h3>
                  {submissions.filter(s => s.status === 'pending').map(sub => (
                    <div key={sub.id} className="bg-white p-6 rounded-[30px] border border-slate-200 shadow-sm">
                      {sub.image && <div className="w-full h-44 mb-5 overflow-hidden rounded-[20px] bg-slate-50 border border-slate-100 shadow-inner"><img src={sub.image} className="w-full h-full object-cover" /></div>}
                      <p className="text-sm font-bold text-slate-700 mb-6 text-center italic">ã€Œ{sub.description}ã€</p>
                      <div className="flex items-center gap-4 mb-6 bg-slate-50 p-4 rounded-[20px]">
                        <span className="text-xs font-bold text-slate-400 shrink-0">ç™¼æ”¾é»æ•¸:</span>
                        <input type="number" className="w-full bg-white border-none rounded-xl px-4 py-2 text-sm font-bold text-sky-600 outline-none focus:ring-1 focus:ring-sky-200 shadow-inner" placeholder="10" value={approvalPoints[sub.id] || ''} onChange={(e) => setApprovalPoints({ ...approvalPoints, [sub.id]: e.target.value })} />
                      </div>
                      <div className="flex gap-3">
                        <button onClick={() => deleteItem('submissions', sub.id, sub.description)} className="flex-1 py-3 bg-slate-100 text-slate-300 rounded-[18px] text-[10px] font-bold">æ‹’çµ•</button>
                        <button onClick={() => handleApprove(sub, approvalPoints[sub.id] || 10)} className="flex-[2.5] premium-blue-gradient text-white py-3 rounded-[18px] text-[10px] font-bold tracking-widest shadow-lg">ç™¼æ”¾</button>
                      </div>
                    </div>
                  ))}
                </div>

                <div className="space-y-4">
                  <h3 className="text-[9px] font-bold text-slate-400 px-3 uppercase tracking-[0.2em]">å¾…æ ¸éŠ·å…Œæ›åˆ¸</h3>
                  <div className="bg-white rounded-[30px] border border-slate-100 p-4 space-y-3 shadow-sm">
                    {submissions.filter(s => s.status === 'redeemed').map(coupon => (
                       <div key={coupon.id} className="flex items-center gap-4 p-3 bg-slate-50 rounded-2xl border border-slate-100">
                          <div className="w-10 h-10 rounded-lg bg-sky-100 overflow-hidden shrink-0 shadow-inner"><img src={coupon.image} className="w-full h-full object-cover"/></div>
                          <div className="flex-1 min-w-0">
                            <p className="text-xs font-bold text-slate-600 truncate">{coupon.description.replace('ğŸ å·²å…Œæ›ï¼š', '')}</p>
                          </div>
                          <button onClick={() => handleVerifyCoupon(coupon.id)} className="bg-emerald-500 text-white px-4 py-2 rounded-xl text-[10px] font-bold active:scale-95 flex items-center gap-1 shadow-sm">
                            <Icon name="Check" size={12}/> æ ¸éŠ·
                          </button>
                       </div>
                    ))}
                  </div>
                </div>

                <div className="bg-white p-7 rounded-[35px] border border-slate-200 space-y-4 shadow-sm">
                  <h3 className="text-sm font-bold text-slate-700 flex items-center gap-2"><Icon name="Plus" size={18} className="text-sky-300"/> ç›´æ¥ä¸Šæ¶å•†å“</h3>
                  <div className="space-y-4">
                    <input className="w-full bg-slate-50 border-none rounded-[15px] p-4 text-sm font-light outline-none focus:ring-1 focus:ring-sky-100" placeholder="åç¨±" value={adminRewardName} onChange={(e) => setAdminRewardName(e.target.value)} />
                    <input type="number" className="w-full bg-slate-50 border-none rounded-[15px] p-4 text-sm font-light outline-none focus:ring-1 focus:ring-sky-100" placeholder="é»æ•¸" value={adminRewardCost} onChange={(e) => setAdminRewardCost(e.target.value)} />
                    <input type="file" accept="image/*" className="text-[10px] block w-full text-slate-300 font-light" onChange={(e) => setAdminRewardImage(e.target.files[0])} />
                    <button onClick={handleAddRewardByAdmin} className="w-full py-3.5 btn-action rounded-[15px] font-bold text-xs shadow-lg">ç¢ºèªä¸Šæ¶</button>
                  </div>
                </div>
              </div>
            )}
          </div>

          {/* åº•éƒ¨å°èˆª */}
          <div className="fixed bottom-0 left-0 right-0 bg-white/80 backdrop-blur-2xl border-t border-slate-50 px-10 py-5 flex justify-between items-center text-[10px] font-bold text-slate-300 max-w-md mx-auto z-50 sm:rounded-b-[40px]">
            <button onClick={() => setActiveTab('home')} className={`flex flex-col items-center gap-1.5 transition-all ${activeTab === 'home' ? 'text-sky-500 scale-110' : 'hover:text-slate-600'}`}>
              <Icon name="Camera" size={24} className={activeTab === 'home' ? 'stroke-[2.2px]' : ''}/><span>é›†é»</span>
            </button>
            <button onClick={() => setActiveTab('activities')} className={`flex flex-col items-center gap-1.5 transition-all ${activeTab === 'activities' ? 'text-sky-500 scale-110' : 'hover:text-slate-600'}`}>
              <Icon name="Dice" size={24} className={activeTab === 'activities' ? 'stroke-[2.2px]' : ''}/><span>æ´»å‹•</span>
            </button>
            <button onClick={() => setActiveTab('rewards')} className={`flex flex-col items-center gap-1.5 transition-all ${activeTab === 'rewards' ? 'text-sky-500 scale-110' : 'hover:text-slate-600'}`}>
              <Icon name="Gift" size={24} className={activeTab === 'rewards' ? 'stroke-[2.2px]' : ''}/><span>å…Œæ›</span>
            </button>
            <button onClick={() => setActiveTab('notifs')} className={`flex flex-col items-center gap-1.5 transition-all ${activeTab === 'notifs' ? 'text-sky-500 scale-110' : 'hover:text-slate-600'}`}>
              <div className="relative">
                <Icon name="Bell" size={24} className={activeTab === 'notifs' ? 'stroke-[2.2px]' : ''}/>
                {unreadCount > 0 && <span className="absolute -top-1 -right-1 bg-red-500 w-3.5 h-3.5 rounded-full border-2 border-white"></span>}
              </div>
              <span>é€šçŸ¥</span>
            </button>
            {isAdmin && (
              <button onClick={() => setActiveTab('admin')} className={`flex flex-col items-center gap-1.5 transition-all ${activeTab === 'admin' ? 'text-sky-500 scale-110' : 'hover:text-slate-600'}`}>
                <Icon name={isAdmin ? "LogOut" : "Lock"} size={24} className={activeTab === 'admin' ? 'stroke-[2.2px]' : ''}/><span>ç®¡ç†</span>
              </button>
            )}
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<InitWrapper />);
  </script>
</body>
</html>
