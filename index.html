<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Point | æ‡‰æœ‰ç›¡æœ‰å¤§è¶…å•†</title>
  
  <!-- é˜²æ­¢ favicon 404 éŒ¯èª¤ -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ›’</text></svg>">
  
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React & ReactDOM -->
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  
  <style>
    /* å…¨åŸŸå­—é«”è¨­å®š - ä¿æŒçº–ç´°é«˜ç´šæ„Ÿ */
    * { 
      font-family: 'Noto Sans TC', sans-serif !important; 
      box-sizing: border-box;
    }
    
    body { 
      background-color: #f8fafc; 
      color: #172554; 
      -webkit-tap-highlight-color: transparent; 
      overflow-x: hidden;
      overscroll-behavior-y: none;
      font-weight: 400;
    }
    
    .no-scrollbar::-webkit-scrollbar { display: none; }
    #root { opacity: 0; transition: opacity 0.8s ease-out; }
    #root.loaded { opacity: 1; }
    
    /* å‹•ç•« */
    @keyframes floating { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
    .animate-float { animation: floating 4s ease-in-out infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(1800deg); } }
    @keyframes bounce-hand { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
    .animate-bounce-hand { animation: bounce-hand 0.5s ease-in-out infinite; }
    .marquee { white-space: nowrap; overflow: hidden; box-sizing: border-box; }
    .marquee span { display: inline-block; padding-left: 100%; animation: marquee 25s linear infinite; }
    @keyframes marquee { 0% { transform: translate(0, 0); } 100% { transform: translate(-100%, 0); } }

    /* éª°å­å‹•ç•« */
    @keyframes shake { 
        0% { transform: translate(1px, 1px) rotate(0deg); }
        10% { transform: translate(-1px, -2px) rotate(-1deg); }
        20% { transform: translate(-3px, 0px) rotate(1deg); }
        30% { transform: translate(3px, 2px) rotate(0deg); }
        40% { transform: translate(1px, -1px) rotate(1deg); }
        50% { transform: translate(-1px, 2px) rotate(-1deg); }
        60% { transform: translate(-3px, 1px) rotate(0deg); }
        70% { transform: translate(3px, 1px) rotate(-1deg); }
        80% { transform: translate(-1px, -1px) rotate(1deg); }
        90% { transform: translate(1px, 2px) rotate(0deg); }
        100% { transform: translate(1px, -2px) rotate(-1deg); }
    }
    .dice-shake { animation: shake 0.5s infinite; }

    /* --- é«˜ç´šé…è‰²ç³»çµ± --- */
    
    .luxury-bg { 
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); 
    }
    
    .luxury-gold-bg { 
        background: linear-gradient(135deg, #ca8a04 0%, #eab308 100%); 
        color: white;
    }
    
    .luxury-card { 
      background: #ffffff; 
      border: 1px solid #e2e8f0; 
      box-shadow: 0 4px 15px rgba(15, 23, 42, 0.05);
      border-radius: 24px;
    }
    
    .header-point-card { 
      background: rgba(255, 255, 255, 0.1); 
      backdrop-filter: blur(10px); 
      border: 1px solid rgba(255, 255, 255, 0.15);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      border-radius: 16px;
    }

    /* æ–‡å­—é¡è‰² */
    .text-deep-blue { color: #172554; } 
    .text-luxury-gold { color: #b45309; } 
    .text-label { color: #64748b; font-weight: 500; font-size: 11px; text-transform: uppercase; letter-spacing: 0.05em; }
    
    /* æŒ‰éˆ•æ¨£å¼ */
    .btn-primary {
      background: #172554; 
      color: white;
      font-weight: 500;
      border-radius: 12px;
      transition: all 0.2s;
      box-shadow: 0 4px 6px rgba(23, 37, 84, 0.2);
    }
    .btn-primary:active { transform: scale(0.96); opacity: 0.9; }

    .btn-secondary {
      background: #f1f5f9;
      color: #475569;
      font-weight: 500;
      border-radius: 12px;
    }
    
    .btn-gold {
      background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
      color: white;
      font-weight: 600;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(180, 83, 9, 0.3);
    }

    .btn-luxury {
      background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
      color: white;
      font-weight: 600;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(15, 23, 42, 0.3);
      transition: all 0.2s;
    }
    .btn-luxury:active { transform: scale(0.98); }

    /* è¼¸å…¥æ¡† - ç¸®å°å­—é«”ä»¥ç¬¦åˆå¾Œå°éœ€æ±‚ */
    .settings-input {
        background: #f8fafc;
        border: 1px solid #cbd5e1;
        border-radius: 10px;
        padding: 8px 10px; /* ç¨å¾®ç¸®å°å…§è· */
        font-size: 12px;   /* ç¸®å°å­—é«” */
        width: 100%;
        outline: none;
        color: #1e293b; 
        font-weight: 500;
    }
    .settings-input:focus { border-color: #172554; background: white; }
    
    .settings-label {
        font-size: 10px; /* ç¸®å°æ¨™ç±¤å­—é«” */
        font-weight: 600;
        color: #64748b;
        margin-bottom: 4px;
        display: block;
        text-transform: uppercase;
    }

    /* è½‰ç›¤ - å„ªåŒ–æ–‡å­—é¡¯ç¤º */
    .wheel-segment {
        position: absolute; width: 50%; height: 50%;
        top: 0; right: 0; transform-origin: 0% 100%;
        display: flex; align-items: center; justify-content: center;
    }
    .wheel-text {
        position: absolute; left: -100%; width: 200%;
        text-align: center; 
        transform: rotate(30deg) translate(0, -75px);
        font-size: 11px; /* åŠ å¤§ä¸€é»é» */
        font-weight: 800; /* åŠ ç²— */
        color: #1e293b;
        text-shadow: 0 1px 0 rgba(255,255,255,0.5); /* å¢åŠ æ–‡å­—ç™½é‚Šï¼Œæå‡å¯è®€æ€§ */
    }

    /* åˆ®åˆ®æ¨‚ */
    .scratch-grid-cell {
      aspect-ratio: 1/1;
      background: #94a3b8;
      border-radius: 8px;
      position: relative;
      overflow: hidden;
      border: 2px solid white;
      box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
    }
    .scratch-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; cursor: crosshair; touch-action: none; z-index: 5; }
    .scratch-content {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      display: flex; align-items: center; justify-content: center;
      font-weight: 700; font-size: 1.2rem; z-index: 1; background: white; color: #1e293b;
    }

    /* Delete Badge */
    .delete-badge {
        position: absolute; top: -8px; right: -8px; 
        background: #ef4444; color: white; width: 20px; height: 20px; 
        border-radius: 50%; display: flex; align-items: center; justify-content: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2); cursor: pointer; z-index: 20;
    }

    #loading-screen {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: #f8fafc; display: flex; flex-direction: column;
      align-items: center; justify-content: center; z-index: 100;
      transition: opacity 0.5s ease;
    }
    .loading-icon { font-size: 48px; margin-bottom: 16px; }
  </style>
</head>
<body>

  <div id="root"></div>

  <div id="loading-screen">
    <div class="animate-float loading-icon">ğŸ›’</div>
    <div style="color:#0f172a; font-weight:500; letter-spacing: 0.1em; font-size: 16px; margin-bottom: 8px;">å³å°‡é€²å…¥æ‡‰æœ‰ç›¡æœ‰å¤§è¶…å•†</div>
    <div id="loading-status" style="font-size:12px; color:#64748b;">æ­£åœ¨ç‚ºæ‚¨é–‹å•Ÿæœå‹™...</div>
    <button id="retry-btn" onclick="window.location.reload()" style="margin-top:20px; padding:8px 20px; background:white; border:1px solid #ccc; border-radius:8px; display:none;">é‡æ–°é€£ç·š</button>
  </div>

  <script type="module">
    // Updated to version 11.6.1 for better compatibility
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, setPersistence, inMemoryPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, updateDoc, collection, onSnapshot, addDoc, increment, serverTimestamp, deleteDoc, arrayUnion, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const statusEl = document.getElementById('loading-status');
    const retryBtn = document.getElementById('retry-btn');

    try {
      let firebaseConfig = { apiKey: "AIzaSyBAizT0ijN3-uxegV4w2HX6VFvXvYndc3c", authDomain: "change-389a0.firebaseapp.com", projectId: "change-389a0", storageBucket: "change-389a0.firebasestorage.app", messagingSenderId: "360528719647", appId: "1:360528719647:web:474055ac8fb26e370c0a2a" };
      if (typeof __firebase_config !== 'undefined' && __firebase_config) { try { firebaseConfig = JSON.parse(__firebase_config); } catch (e) {} }
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      
      // é—œéµä¿®æ­£ï¼šå¼·åˆ¶è¨­å®š appId ç‚º "point-store-v1"
      // é€™æ¨£å¯ä»¥ç¢ºä¿æ‰€æœ‰è£ç½®ï¼ˆæ‰‹æ©Ÿ/é›»è…¦ï¼‰éƒ½å¼·åˆ¶é€£ç·šåˆ°åŒä¸€å€‹è³‡æ–™åº«è·¯å¾‘ï¼Œé¿å…å› ç‚ºç’°å¢ƒè®Šæ•¸ä¸åŒè€Œæ‰¾ä¸åˆ°è³‡æ–™
      const fixedAppId = "point-store-v1";
      
      window.fb = { db, auth, doc, setDoc, updateDoc, collection, onSnapshot, addDoc, increment, serverTimestamp, deleteDoc, arrayUnion, getDoc, appId: fixedAppId, isReady: true, onAuthStateChanged, signInAnonymously, signInWithCustomToken };
      
      (async () => {
        try {
          if(statusEl) statusEl.innerText = "æ­£åœ¨å»ºç«‹å®‰å…¨é€£ç·š...";
          await setPersistence(auth, inMemoryPersistence); 
          if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
          else await signInAnonymously(auth);
        } catch (e) { console.error(e); if(retryBtn) retryBtn.style.display = 'block'; }
      })();
    } catch (err) { console.error(err); if(retryBtn) retryBtn.style.display = 'block'; }
    setTimeout(() => { if(retryBtn && retryBtn.style.display === 'none') retryBtn.style.display = 'block'; }, 10000);
  </script>

  <script type="text/babel">
    const { useState, useEffect, useRef, useMemo, Fragment } = React;

    const Icon = ({ name, size = 20, className = "" }) => {
      const icons = {
        Point: <path d="M6 2L3 6V20A2 2 0 0 0 5 22H19A2 2 0 0 0 21 20V6L18 2H6ZM3 6H21M16 10A4 4 0 0 1 8 10" />,
        Camera: (<Fragment><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></Fragment>),
        Gift: (<Fragment><rect x="3" y="8" width="18" height="4" rx="1"/><path d="M12 8v13M19 12v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-7M7.5 8a2.5 2.5 0 0 1 0-5A4.8 8 0 0 1 12 8a4.8 8 0 0 1 4.5-5 2.5 2.5 0 0 1 0 5"/></Fragment>),
        Bell: (<Fragment><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></Fragment>),
        Lock: (<Fragment><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></Fragment>),
        LogOut: (<Fragment><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></Fragment>),
        Trash2: (<Fragment><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></Fragment>),
        Ticket: (<Fragment><path d="M2 9V5a2 2 0 0 1 2-2h16a2 2 0 0 1 2-2v4a2 2 0 0 0 0 4v4a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2v-4a2 2 0 0 0 0-4Z"/><path d="M13 3v18M9 3v18M15 3v18"/></Fragment>),
        Store: (<Fragment><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><path d="M9 22V12h6v10"/></Fragment>),
        Chart: (<Fragment><path d="M12 20V10M18 20V4M6 20v-4"/></Fragment>),
        Check: <polyline points="20 6 9 17 4 12"/>,
        History: (<Fragment><path d="M12 8v4l3 3"/><circle cx="12" cy="12" r="10"/></Fragment>),
        Image: (<Fragment><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></Fragment>),
        Plus: (<Fragment><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></Fragment>),
        Dice: (<Fragment><rect x="2" y="2" width="20" height="20" rx="5" ry="5"/><circle cx="8.5" cy="8.5" r="1.5"/><circle cx="15.5" cy="15.5" r="1.5"/><circle cx="8.5" cy="15.5" r="1.5"/><circle cx="15.5" cy="8.5" r="1.5"/></Fragment>),
        Hand: (<Fragment><path d="M18 11V6a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v0"/><path d="M14 10V4a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v2"/><path d="M10 10.5V6a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v8"/><path d="M18 8a2 2 0 1 1 4 0v6a8 8 0 0 1-8 8h-2c-2.8 0-4.5-.86-5.99-2.34l-3.6-3.6a2 2 0 0 1 2.83-2.82L7 15"/></Fragment>),
        Save: (<Fragment><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></Fragment>),
        Target: (<Fragment><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></Fragment>),
        Disc: (<Fragment><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/><path d="M12 2a10 10 0 0 0 0 20"/><path d="M12 12 2.3 10.5"/><path d="M12 12l9.7-1.5"/></Fragment>),
        PiggyBank: (<Fragment><path d="M19 5c-1.5 0-2.8 0.6-3.8 1.5l-2.5 2.5c-3 3-5 3-5 3s-0.5-2.3 3-5l2.5-2.5c1-1 2.5-1.5 4-1.5 2.5 0 4.8 1.5 5.8 3.5H19z"/><path d="M19 5h-1"/><path d="M22 9c0 5-4 9-9 9s-9-4-9-9c0-3.3 2-6.2 4.9-7.9l0.9 0.9C7.5 3.1 6 5.4 6 8c0 3.3 2.7 6 6 6s6-2.7 6-6c0-2-0.8-3.8-2.2-5l0.7-0.7c3.1 1.7 5.5 5 5.5 6.7z"/></Fragment>),
        Sparkles: (<Fragment><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1-1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4M9 3v4M3 5h4M3 9h4"/></Fragment>),
        Edit: (<Fragment><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></Fragment>),
        ArrowLeft: (<Fragment><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></Fragment>),
        Square: (<Fragment><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/></Fragment>),
      };
      return <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={1.5} strokeLinecap="round" strokeLinejoin="round" className={className}>{icons[name] || null}</svg>;
    };

    const ScratchCell = ({ value, canScratch, onRevealed, isRevealed }) => {
      const canvasRef = useRef(null);
      // ä½¿ç”¨ ref ä¾†é¿å…é‡è¤‡è§¸ç™¼
      const hasTriggeredRef = useRef(false);

      // åˆå§‹åŒ–èˆ‡ç‹€æ…‹è®Šæ›´æ™‚çš„ç¹ªåœ–é‚è¼¯
      useEffect(() => {
        const canvas = canvasRef.current;
        if (!canvas) return;
        const ctx = canvas.getContext('2d');

        if (isRevealed) {
            // å¦‚æœå·²æ­ç¤ºï¼Œç›´æ¥æ¸…ç©ºï¼Œç¢ºä¿ä¸æœƒç•«ä¸ŠéŠ€æ¼†
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        } else {
            // åªæœ‰åœ¨ã€Œæœªæ­ç¤ºã€ä¸”ã€Œç•«å¸ƒå°šæœªè¢«åˆ®é–‹ã€æ™‚æ‰ç•«éŠ€æ¼†
            // é€™è£¡ä¸åšè¤‡é›œåˆ¤æ–·ï¼Œåªè¦æ˜¯ false å°±ç•«ï¼Œç¢ºä¿é‡ç½®æ™‚æ­£ç¢º
            hasTriggeredRef.current = false; 
            
            ctx.globalCompositeOperation = 'source-over'; 
            ctx.fillStyle = '#94a3b8'; 
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.fillStyle = '#e2e8f0';
            ctx.font = 'bold 24px sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('?', canvas.width/2, canvas.height/2);
        }
      }, [isRevealed]); // ä¾è³´ isRevealedï¼Œç¢ºä¿è³‡æ–™åº«åŒæ­¥æ™‚ç•«é¢æ­£ç¢ºæ›´æ–°

      const scratch = (clientX, clientY) => {
        const canvas = canvasRef.current;
        if (!canvas) return;
        const rect = canvas.getBoundingClientRect();
        const x = clientX - rect.left;
        const y = clientY - rect.top;

        const ctx = canvas.getContext('2d');
        ctx.globalCompositeOperation = 'destination-out'; 
        ctx.beginPath();
        ctx.arc(x, y, 12, 0, Math.PI * 2); 
        ctx.fill();

        if (!hasTriggeredRef.current) {
            hasTriggeredRef.current = true;
            onRevealed(value);
        }
      };

      return (
        <div className="scratch-grid-cell relative">
            <div className="scratch-content flex items-center justify-center font-bold text-xl text-deep-blue h-full w-full bg-white select-none">
                {value}
            </div>
            {/* å¦‚æœå·²æ­ç¤ºï¼Œé€é CSS éš±è— canvasï¼Œä½œç‚ºé›™é‡ä¿éšª */}
            <canvas
                ref={canvasRef}
                width={80}
                height={80}
                className={`scratch-canvas absolute top-0 left-0 w-full h-full z-10 ${isRevealed ? 'invisible' : 'visible'}`}
                style={{ 
                    touchAction: 'none', 
                    opacity: isRevealed ? 0 : 1, 
                    pointerEvents: isRevealed ? 'none' : 'auto',
                    transition: 'opacity 0.5s ease-out'
                }}
                onMouseMove={(e) => !isRevealed && canScratch && e.buttons === 1 && scratch(e.clientX, e.clientY)}
                onTouchMove={(e) => !isRevealed && canScratch && scratch(e.touches[0].clientX, e.touches[0].clientY)}
                onMouseDown={(e) => !isRevealed && canScratch && scratch(e.clientX, e.clientY)}
                onTouchStart={(e) => !isRevealed && canScratch && scratch(e.touches[0].clientX, e.touches[0].clientY)}
            />
        </div>
      );
    };

    const compressImage = (file) => {
      return new Promise((resolve) => {
        const reader = new FileReader(); reader.readAsDataURL(file);
        reader.onload = (e) => {
          const img = new Image(); img.src = e.target.result;
          img.onload = () => {
            const canvas = document.createElement('canvas'); const scale = 400 / img.width;
            canvas.width = 400; canvas.height = img.height * scale;
            canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
            resolve(canvas.toDataURL('image/jpeg', 0.6)); 
          };
        };
      });
    };

    function App() {
      const { db, auth, doc, setDoc, updateDoc, collection, onSnapshot, addDoc, increment, serverTimestamp, deleteDoc, arrayUnion, getDoc, appId, onAuthStateChanged } = window.fb;
      const [user, setUser] = useState(null);
      const [activeTab, setActiveTab] = useState('home');
      const [currentActivity, setCurrentActivity] = useState(null); 
      const [isAdmin, setIsAdmin] = useState(false);
      const [points, setPoints] = useState(0);
      const [stats, setStats] = useState({ totalIssued: 0, totalRedeemed: 0 });
      const [submissions, setSubmissions] = useState([]);
      const [rewards, setRewards] = useState([]);
      const [notifications, setNotifications] = useState([]);
      const [loading, setLoading] = useState(true);
      const [announcement, setAnnouncement] = useState('æ­¡è¿å…‰è‡¨ Point æ‡‰æœ‰ç›¡æœ‰å¤§è¶…å•†');

      const defaultWheelSegments = [
        { label: "10 é»", value: 10, type: "point", color: "#fef3c7", weight: 10 },
        { label: "å’–å•¡", value: 0, type: "text", color: "#e2e8f0", weight: 5 },
        { label: "5 é»", value: 5, type: "point", color: "#dbeafe", weight: 20 },
        { label: "50 é»", value: 50, type: "point", color: "#fcd34d", weight: 1 },
        { label: "å†æ¥å†å²", value: 0, type: "text", color: "#cbd5e1", weight: 40 },
        { label: "20 é»", value: 20, type: "point", color: "#93c5fd", weight: 5 }
      ];

      // æ–°å¢ diceWinMultiplier, rpsWinRate, diceWinRate é è¨­å€¼
      const [gameSettings, setGameSettings] = useState({ 
          wheelCost: 20, 
          wheelSegments: defaultWheelSegments, 
          rpsCost: 10, 
          rpsWinMultiplier: 2, 
          rpsWinRate: 0.33, // é è¨­ 33%
          diceWinMultiplier: 2, // é è¨­ 1è³ 1 (ç¸½å…±æ‹¿å›2å€)
          diceWinRate: 0.48, // é è¨­ 48%
          bankRate: 0.05, 
          bankLockHours: 24, 
          checkInPoints: 2 
      });
      const [pendingSettings, setPendingSettings] = useState(null);

      const [savings, setSavings] = useState({ balance: 0, lastInterestTime: null, lastDepositTime: null });
      const [wheelSpinning, setWheelSpinning] = useState(false);
      const [wheelRotation, setWheelRotation] = useState(0);
      const [rpsState, setRpsState] = useState('idle');
      const [rpsUserChoice, setRpsUserChoice] = useState(null);
      const [rpsCpuChoice, setRpsCpuChoice] = useState(null);
      const [rpsBetAmount, setRpsBetAmount] = useState(10); 

      // Dice Game State
      const [diceValues, setDiceValues] = useState([1, 1, 1]);
      const [isDiceRolling, setIsDiceRolling] = useState(false);
      const [diceBetTarget, setDiceBetTarget] = useState('big'); // 'big' or 'small'
      const [diceBetAmount, setDiceBetAmount] = useState(10);

      const [desc, setDesc] = useState('');
      const [selectedFile, setSelectedFile] = useState(null);
      const [isUploading, setIsUploading] = useState(false);
      const [adminPass, setAdminPass] = useState('');
      const [showAdminLogin, setShowAdminLogin] = useState(false);
      const [approvalPoints, setApprovalPoints] = useState({});
      const [rejectionReasons, setRejectionReasons] = useState({});
      const [wishName, setWishName] = useState('');
      const [checkInImage, setCheckInImage] = useState(null);
      const [isCheckingIn, setIsCheckingIn] = useState(false);
      const [adminRewardName, setAdminRewardName] = useState('');
      const [adminRewardCost, setAdminRewardCost] = useState('');
      const [adminRewardImage, setAdminRewardImage] = useState(null);
      const [isAddingReward, setIsAddingReward] = useState(false);
      
      const [wishCosts, setWishCosts] = useState({}); // æ–°å¢ï¼šè¨±é¡˜æ± å•†å“å®šåƒ¹ç‹€æ…‹

      const [scratchActivities, setScratchActivities] = useState([]);
      const [selectedScratchGame, setSelectedScratchGame] = useState(null); 
      const [canScratchNow, setCanScratchNow] = useState(false);
      const [currentGameProgress, setCurrentGameProgress] = useState([]); 
      const [allScratchProgress, setAllScratchProgress] = useState([]);
      const [adminMonitoringGame, setAdminMonitoringGame] = useState(null);
      const [adminScratchTitle, setAdminScratchTitle] = useState('');
      const [adminScratchCost, setAdminScratchCost] = useState('');
      const [adminScratchPrize, setAdminScratchPrize] = useState('');
      const [adminScratchTarget, setAdminScratchTarget] = useState('');
      const [adminScratchWinnerIndex, setAdminScratchWinnerIndex] = useState(null);
      const [adminScratchImage, setAdminScratchImage] = useState(null);
      const [editingScratchId, setEditingScratchId] = useState(null);
      const [givePointsReason, setGivePointsReason] = useState('');
      const [givePointsAmount, setGivePointsAmount] = useState('');
      
      const [wishImage, setWishImage] = useState(null);
      const [isWishing, setIsWishing] = useState(false);

      const getPublicRef = (name) => collection(db, 'artifacts', appId, 'public', 'data', name);

      useEffect(() => {
        if (!user) return;
        const unsubStats = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'stats', 'total'), (d) => { if (d.exists()) { setPoints(d.data().totalPoints || 0); setStats({ totalIssued: d.data().totalIssued || 0, totalRedeemed: d.data().totalRedeemed || 0 }); } });
        const unsubSubs = onSnapshot(getPublicRef('submissions'), (s) => setSubmissions(s.docs.map(d => ({id: d.id, ...d.data()}))));
        const unsubRewards = onSnapshot(getPublicRef('rewards'), (s) => setRewards(s.docs.map(d => ({id: d.id, ...d.data()}))));
        const unsubSettings = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'games'), (d) => { 
            if(d.exists()) { 
                const data = d.data();
                setGameSettings(data); 
                setPendingSettings(prev => prev ? prev : data); 
            } else { 
                setPendingSettings(prev => prev ? prev : gameSettings); 
            } 
        });
        
        // ä¿®æ­£ï¼šé‡‘åº«æ”¹ç‚ºå…¬å…±è·¯å¾‘ï¼Œé¿å… ID æ”¹è®Šå°è‡´è³‡æ–™éºå¤±
        const unsubSavings = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'savings', 'account'), (d) => { if(d.exists()) setSavings(d.data()); else setSavings({ balance: 0, lastInterestTime: null, lastDepositTime: null }); });
        
        const unsubScratch = onSnapshot(getPublicRef('scratch_activities'), (s) => setScratchActivities(s.docs.map(d => ({id: d.id, ...d.data()}))));
        const unsubAnnounce = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'announce'), (d) => { if (d.exists()) setAnnouncement(d.data().text); });
        const unsubNotifs = onSnapshot(getPublicRef('notifications'), (s) => setNotifications(s.docs.map(d => ({id: d.id, ...d.data()}))));
        const unsubScratchProg = onSnapshot(getPublicRef('scratch_progress'), (s) => setAllScratchProgress(s.docs.map(d => ({id: d.id, ...d.data()}))));
        
        return () => { unsubStats(); unsubSubs(); unsubRewards(); unsubSettings(); unsubSavings(); unsubScratch(); unsubAnnounce(); unsubNotifs(); unsubScratchProg(); };
      }, [user]);

      useEffect(() => {
          if (activeTab === 'admin' && gameSettings) {
             setPendingSettings(gameSettings);
          }
      }, [activeTab]);

      useEffect(() => {
         if (!user || !selectedScratchGame) { setCurrentGameProgress([]); return; }
         // ä¿®æ­£ï¼šè®€å–å…¨åŸŸé€²åº¦ (æ”¹ç‚º _global çµå°¾)
         return onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'scratch_progress', `${selectedScratchGame.id}_global`), (d) => {
            if (d.exists()) {
                setCurrentGameProgress(d.data().revealedIndices || []);
                setCanScratchNow(true); // å…¨åŸŸæ¨¡å¼ä¸‹ï¼Œåªè¦æœ‰é»æ•¸å°±èƒ½ç©ï¼Œä¸éœ€è¦å€‹äººè³¼è²·ç‹€æ…‹
            } else {
                setCurrentGameProgress([]);
                setCanScratchNow(false);
            }
         });
      }, [selectedScratchGame, user]);

      useEffect(() => {
        return onAuthStateChanged(auth, (u) => { 
          if (u) { 
            setUser(u); 
            setLoading(false); 
            const ls = document.getElementById('loading-screen');
            if(ls) { ls.style.opacity = '0'; setTimeout(() => ls.style.display = 'none', 500); }
            document.getElementById('root').classList.add('loaded');
          } 
        });
      }, []);

      const handleSaveGameSettings = async () => { try { await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'games'), pendingSettings, { merge: true }); alert("è¨­å®šå·²æ›´æ–°"); } catch(e) { alert("æ›´æ–°å¤±æ•—"); } };
      const handleApprove = async (sub, pts) => { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'submissions', sub.id), { status: 'approved', awardedPoints: parseInt(pts) }); await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'stats', 'total'), { totalPoints: increment(pts), totalIssued: increment(pts) }); alert("å·²æ‰¹å‡†"); };
      const handleReject = async (sub) => { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'submissions', sub.id), { status: 'rejected', rejectionReason: rejectionReasons[sub.id] || "ä¸ç¬¦åˆè¦å‰‡", awardedPoints: 0 }); alert("å·²é§å›"); };
      const checkAdmin = () => { if (adminPass === 'love1314') { setIsAdmin(true); setShowAdminLogin(false); setActiveTab('admin'); alert('ç®¡ç†å“¡ æ‚¨å¥½'); } else alert('å¯†ç¢¼éŒ¯èª¤'); };

      const handleCheckIn = async () => {
        if (isCheckingIn || !checkInImage) return;
        setIsCheckingIn(true);
        try {
          const img = await compressImage(checkInImage);
          const pts = gameSettings.checkInPoints || 2;
          await addDoc(getPublicRef('submissions'), { description: "ğŸ’… æŒ‡ç”²ä¿è­·æ‰“å¡", image: img, status: 'checkin', awardedPoints: pts, timestamp: serverTimestamp(), userId: user.uid });
          await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'stats', 'total'), { totalPoints: increment(pts), totalIssued: increment(pts) });
          setCheckInImage(null); alert("æ‰“å¡æˆåŠŸ");
        } catch(e) { alert("å¤±æ•—"); } finally { setIsCheckingIn(false); }
      };

      const handleSpinWheel = async () => {
        const cost = gameSettings.wheelCost || 20;
        if(points < cost || wheelSpinning) return;
        setWheelSpinning(true);
        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'stats', 'total'), { totalPoints: increment(-cost), totalRedeemed: increment(cost) });
        
        const segments = gameSettings.wheelSegments;
        const totalWeight = segments.reduce((sum, s) => sum + (s.weight || 0), 0);
        let random = Math.random() * totalWeight;
        let winnerIndex = 0;
        for(let i=0; i<segments.length; i++) {
            random -= (segments[i].weight || 0);
            if(random <= 0) { winnerIndex = i; break; }
        }

        const segmentDegree = 360 / segments.length; 
        const randomOffset = Math.floor(Math.random() * (segmentDegree - 10)) - (segmentDegree/2 - 5); 
        const targetAngle = (winnerIndex * segmentDegree) + (segmentDegree/2) + randomOffset; 
        
        const finalRot = wheelRotation + 1800 + (360 - targetAngle - (wheelRotation % 360));
        
        setWheelRotation(finalRot);

        setTimeout(async () => {
           setWheelSpinning(false);
           const win = segments[winnerIndex] || {label: "éŠ˜è¬", value: 0};
           alert(`è½‰ç›¤çµæœï¼š${win.label}`);
           if(win.value > 0) {
              await addDoc(getPublicRef('submissions'), { description: `ğŸ¡ è½‰ç›¤çå‹µï¼š${win.label}`, status: 'bonus', awardedPoints: win.value, timestamp: serverTimestamp(), userId: user.uid });
              await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'stats', 'total'), { totalPoints: increment(win.value), totalIssued: increment(win.value) });
           }
        }, 3000);
      };

      // Dice Logic
      const handleRollDice = async () => {
          const cost = parseInt(diceBetAmount);
          if (isNaN(cost) || cost < 10) return alert("æœ€ä½ä¸‹æ³¨ 10 P");
          if (points < cost) return alert(`é»æ•¸ä¸è¶³ï¼éœ€è¦ ${cost} P`);
          if (isDiceRolling) return;

          setIsDiceRolling(true);
          
          // Deduct points (the bet)
          await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'stats', 'total'), { totalPoints: increment(-cost), totalRedeemed: increment(cost) });
          await addDoc(getPublicRef('submissions'), { description: `ğŸ² éª°å­å¤§å¸« (ä¸‹æ³¨${cost})`, status: 'scratch', awardedPoints: -cost, timestamp: serverTimestamp(), userId: user.uid });

          // Animation simulation
          let steps = 20;
          const interval = setInterval(() => {
              setDiceValues([
                  Math.floor(Math.random() * 6) + 1,
                  Math.floor(Math.random() * 6) + 1,
                  Math.floor(Math.random() * 6) + 1
              ]);
              steps--;
              if (steps <= 0) {
                  clearInterval(interval);
                  finalizeDice(cost);
              }
          }, 100);
      };

      // è¼”åŠ©å‡½å¼ï¼šç”¢ç”ŸæŒ‡å®šç¸½å’Œç¯„åœçš„éª°å­
      const generateDiceForSum = (min, max) => {
          let d1, d2, d3, sum;
          do {
              d1 = Math.floor(Math.random() * 6) + 1;
              d2 = Math.floor(Math.random() * 6) + 1;
              d3 = Math.floor(Math.random() * 6) + 1;
              sum = d1 + d2 + d3;
          } while (sum < min || sum > max || (d1 === d2 && d2 === d3)); // é¿å…åœéª° (é™¤éæ˜¯é‡å°åœéª°é‚è¼¯)
          return [d1, d2, d3];
      };

      // è¼”åŠ©å‡½å¼ï¼šç”¢ç”Ÿåœéª°
      const generateTriple = () => {
          const v = Math.floor(Math.random() * 6) + 1;
          return [v, v, v];
      };

      const finalizeDice = async (cost) => {
          // æ ¹æ“šå‹ç‡æ±ºå®šçµæœ
          const winRate = gameSettings.diceWinRate !== undefined ? gameSettings.diceWinRate : 0.48;
          const isWin = Math.random() < winRate;
          
          let d1, d2, d3;
          
          if (isWin) {
              // å¼·åˆ¶è´ï¼šå¦‚æœæŠ¼å¤§ï¼Œç”¢ç”Ÿ11-17ï¼›å¦‚æœæŠ¼å°ï¼Œç”¢ç”Ÿ4-10
              if (diceBetTarget === 'big') {
                  [d1, d2, d3] = generateDiceForSum(11, 17);
              } else {
                  [d1, d2, d3] = generateDiceForSum(4, 10);
              }
          } else {
              // å¼·åˆ¶è¼¸ï¼š
              // 1. å°æ©Ÿç‡å‡ºåœéª°é€šæ®º (ä¾‹å¦‚ 10%)
              // 2. å¦å‰‡å‡ºç›¸åçµæœ
              if (Math.random() < 0.1) {
                  [d1, d2, d3] = generateTriple();
              } else {
                  if (diceBetTarget === 'big') {
                      [d1, d2, d3] = generateDiceForSum(4, 10); // æŠ¼å¤§å‡ºå°
                  } else {
                      [d1, d2, d3] = generateDiceForSum(11, 17); // æŠ¼å°å‡ºå¤§
                  }
              }
          }

          const sum = d1 + d2 + d3;
          
          setDiceValues([d1, d2, d3]);
          setIsDiceRolling(false);

          let result = '';
          let isTriple = (d1 === d2 && d2 === d3);

          if (isTriple) {
              result = 'triple'; 
          } else if (sum >= 4 && sum <= 10) {
              result = 'small';
          } else if (sum >= 11 && sum <= 17) {
              result = 'big';
          }

          // é‡æ–°ç¢ºèªæœ€çµ‚æ˜¯å¦ç²å‹ (é›–ç„¶å‰é¢æœ‰æ§åˆ¶ï¼Œä½†ä»¥å¯¦éš›éª°å­ç‚ºæº–)
          let finalIsWin = false;
          if (!isTriple && result === diceBetTarget) {
              finalIsWin = true;
          }

          if (finalIsWin) {
              const multiplier = gameSettings.diceWinMultiplier || 2;
              const winAmount = Math.floor(cost * multiplier); 
              await addDoc(getPublicRef('submissions'), { description: `ğŸ² éª°å­å¤§å¸«ä¸­ç (${result === 'big' ? 'å¤§' : 'å°'})`, status: 'bonus', awardedPoints: winAmount, timestamp: serverTimestamp(), userId: user.uid });
              await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'stats', 'total'), { totalPoints: increment(winAmount), totalIssued: increment(winAmount) });
              alert(`ğŸ‰ æ­å–œï¼é–‹å‡º ${sum} é» (${result === 'big' ? 'å¤§' : 'å°'})ï¼Œè´å¾— ${winAmount} é»ï¼`);
          } else {
              let reason = isTriple ? `åœéª° ${d1}-${d2}-${d3} é€šæ®ºï¼` : `é–‹å‡º ${sum} é» (${result === 'big' ? 'å¤§' : 'å°'})`;
              alert(`ğŸ˜¢ å¾ˆéºæ†¾... ${reason}`);
          }
      };

      const handlePlayRPS = async (choice) => {
          const bet = parseInt(rpsBetAmount);
          if (isNaN(bet) || bet < 2) return alert("æœ€ä½ä¸‹æ³¨é»æ•¸ç‚º 2 é»");
          if (points < bet) return alert(`é»æ•¸ä¸è¶³ï¼æ‚¨åªæœ‰ ${points} é»`);
          if (rpsState === 'playing') return;

          setRpsState('playing'); 
          setRpsUserChoice(choice);
          
          await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'stats', 'total'), { totalPoints: increment(-bet), totalRedeemed: increment(bet) });
          
          setTimeout(async () => {
              // æ ¹æ“šå‹ç‡æ±ºå®šçµæœ
              const winRate = gameSettings.rpsWinRate !== undefined ? gameSettings.rpsWinRate : 0.33;
              const rand = Math.random();
              
              let resultType = 'lose';
              if (rand < winRate) {
                  resultType = 'win';
              } else if (rand < winRate + ((1 - winRate) / 2)) {
                  resultType = 'draw';
              } else {
                  resultType = 'lose';
              }

              // æ ¹æ“šçµæœæ±ºå®š CPU å‡ºæ‹³
              let cpuChoice = '';
              const map = { 'rock': 'scissors', 'paper': 'rock', 'scissors': 'paper' }; // Key wins Value
              
              if (resultType === 'win') {
                  cpuChoice = map[choice]; // ç©å®¶è´ï¼ŒCPU å‡ºè¼¸çš„
              } else if (resultType === 'draw') {
                  cpuChoice = choice; // å¹³æ‰‹
              } else {
                  // ç©å®¶è¼¸ï¼ŒCPU å‡ºè´çš„
                  // æ‰¾ map ä¸­èª°è´ choice
                  cpuChoice = Object.keys(map).find(key => map[key] === choice);
              }

              setRpsCpuChoice(cpuChoice);
              
              if(resultType === 'win') {
                  const winPts = Math.floor(bet * gameSettings.rpsWinMultiplier);
                  await addDoc(getPublicRef('submissions'), { description: `âœŠ çŒœæ‹³ç²å‹ (ä¸‹æ³¨ ${bet})`, status: 'bonus', awardedPoints: winPts, timestamp: serverTimestamp(), userId: user.uid });
                  await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'stats', 'total'), { totalPoints: increment(winPts), totalIssued: increment(winPts) });
                  alert(`ç²å‹ï¼è´å¾— ${winPts} é»`);
              } else if (resultType === 'draw') {
                  await addDoc(getPublicRef('submissions'), { description: `âœŠ çŒœæ‹³å¹³æ‰‹ (é€€è²» ${bet})`, status: 'bonus', awardedPoints: bet, timestamp: serverTimestamp(), userId: user.uid });
                  await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'stats', 'total'), { totalPoints: increment(bet), totalIssued: increment(bet) });
                  alert("å¹³æ‰‹ï¼é»æ•¸é€€é‚„");
              } else {
                 await addDoc(getPublicRef('submissions'), { description: `âœŠ çŒœæ‹³æˆ°æ•— (æå¤± ${bet})`, status: 'scratch', awardedPoints: -bet, timestamp: serverTimestamp(), userId: user.uid });
                 alert("è¼¸äº†...ä¸‹æ¬¡å†ä¾†");
              }
              setRpsState('idle');
          }, 1500);
      };

      const handleDeposit = async () => {
        const amt = parseInt(prompt("å­˜å…¥é‡‘é¡:"));
        if(!amt || points < amt) return;
        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'stats', 'total'), { totalPoints: increment(-amt), totalRedeemed: increment(amt) });
        // ä¿®æ­£ï¼šä½¿ç”¨ atomic increment ç¢ºä¿é¤˜é¡æº–ç¢ºç´¯ç©ï¼Œé¿å…è¦†å¯«ï¼Œä¸¦ä½¿ç”¨å…¬å…±è·¯å¾‘
        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'savings', 'account'), { balance: increment(amt), lastDepositTime: serverTimestamp() }, { merge: true });
        await addDoc(getPublicRef('submissions'), { description: "ğŸ¦ å­˜å…¥å°é‡‘åº«", status: 'deducted', awardedPoints: -amt, timestamp: serverTimestamp(), userId: user.uid });
        alert("å­˜å…¥æˆåŠŸ");
      };

      const handleWithdraw = async () => {
        const lockHrs = gameSettings.bankLockHours || 24;
        if(savings.lastDepositTime) {
            const passed = (Date.now() - savings.lastDepositTime.seconds*1000) / 3600000;
            if(passed < lockHrs) return alert(`ç›®å‰è™•æ–¼é–‰é–æœŸï¼Œå°šéœ€ç­‰å¾… ${(lockHrs - passed).toFixed(1)} å°æ™‚`);
        }
        const amt = parseInt(prompt("æé ˜é‡‘é¡:"));
        if(!amt || (savings.balance || 0) < amt) return;
        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'stats', 'total'), { totalPoints: increment(amt), totalIssued: increment(amt) });
        // ä¿®æ­£ï¼šä½¿ç”¨ atomic increment è™•ç†ææ¬¾ï¼Œä¸¦ä½¿ç”¨å…¬å…±è·¯å¾‘
        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'savings', 'account'), { balance: increment(-amt) }, { merge: true });
        await addDoc(getPublicRef('submissions'), { description: "ğŸ¦ é‡‘åº«ææ¬¾", status: 'bonus', awardedPoints: amt, timestamp: serverTimestamp(), userId: user.uid });
        alert("æé ˜æˆåŠŸ");
      };

      const handleCollectInterest = async () => {
        const lastTime = savings.lastInterestTime ? savings.lastInterestTime.seconds * 1000 : 0;
        if(Date.now() - lastTime < 86400000) return alert("æ¯æ—¥åªèƒ½é ˜å–ä¸€æ¬¡åˆ©æ¯");
        const interest = Math.floor((savings.balance || 0) * (gameSettings.bankRate || 0.05));
        if(interest <= 0) return alert("æœ¬é‡‘éä½ç„¡åˆ©æ¯");
        // ä¿®æ­£ï¼šä½¿ç”¨ atomic increment è™•ç†åˆ©æ¯ï¼Œä¸¦ä½¿ç”¨å…¬å…±è·¯å¾‘
        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'savings', 'account'), { balance: increment(interest), lastInterestTime: serverTimestamp() }, { merge: true });
        await addDoc(getPublicRef('submissions'), { description: "ğŸ’° é‡‘åº«åˆ©æ¯", status: 'bonus', awardedPoints: interest, timestamp: serverTimestamp(), userId: user.uid });
        alert(`é ˜å–åˆ©æ¯ï¼š${interest} é»`);
      };

      const handleUploadTask = async () => {
        if (!desc.trim() || !selectedFile) return alert("è«‹å¡«å¯«ä¸¦é™„åœ–");
        setIsUploading(true);
        try {
          const imgBase64 = await compressImage(selectedFile);
          await addDoc(getPublicRef('submissions'), { description: desc, image: imgBase64, status: 'pending', timestamp: serverTimestamp(), userId: user.uid });
          setDesc(''); setSelectedFile(null); alert("æäº¤æˆåŠŸ");
        } catch(e){ alert("å¤±æ•—"); } finally { setIsUploading(false); }
      };

      const handleRedeem = async (r) => { if(points < r.cost) return alert("é»æ•¸ä¸è¶³"); if(confirm(`å…Œæ› ${r.name}?`)) { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'stats', 'total'), { totalPoints: increment(-r.cost), totalRedeemed: increment(r.cost) }); await addDoc(getPublicRef('submissions'), { description: `ğŸ å·²å…Œæ›ï¼š${r.name}`, image: r.image, status: 'redeemed', awardedPoints: -r.cost, timestamp: serverTimestamp(), userId: user.uid }); alert("å…Œæ›æˆåŠŸ"); } };

      const handleUploadTaskByAdmin = async () => {
        if (!adminRewardName || !adminRewardCost) return;
        setIsAddingReward(true);
        try {
          const img = adminRewardImage ? await compressImage(adminRewardImage) : "https://placehold.co/400x300/e2e8f0/64748b?text=Gift";
          await addDoc(getPublicRef('rewards'), { name: adminRewardName, cost: parseInt(adminRewardCost), image: img, available: true, timestamp: serverTimestamp() });
          setAdminRewardName(''); setAdminRewardCost(''); alert("ä¸Šæ¶æˆåŠŸ");
        } catch(e) { alert("å¤±æ•—"); } finally { setIsAddingReward(false); }
      };
      
      const updateWheelSegment = (idx, field, val) => { const ms = [...pendingSettings.wheelSegments]; ms[idx] = {...ms[idx], [field]: val}; setPendingSettings({...pendingSettings, wheelSegments: ms}); };
      const deleteItem = async (col, id, name) => { if(confirm("ç¢ºå®šåˆªé™¤?")) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', col, id)); };
      const handleVerifyCoupon = async (id) => { if(confirm("æ ¸éŠ·?")) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'submissions', id), {status:'verified'}); };
      const updateAnnounce = async () => { const t = prompt("æ–°å…¬å‘Š:", announcement); if(t) await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'announce'), {text: t}); };
      
      const handleMakeWish = async () => { 
          if(wishName) { 
              setIsWishing(true); 
              try {
                  const img = wishImage ? await compressImage(wishImage) : "https://placehold.co/400x300/e2e8f0/64748b?text=Wish"; 
                  await addDoc(getPublicRef('rewards'), {name: wishName, cost: 0, image: img, available: false, timestamp: serverTimestamp(), userId: user.uid}); 
                  setWishName(''); 
                  setWishImage(null);
                  alert("è¨±é¡˜æˆåŠŸ"); 
              } catch(e) {
                  alert("è¨±é¡˜å¤±æ•—");
              } finally {
                  setIsWishing(false); 
              }
          } 
      };

      // æ–°å¢ï¼šæ‰¹å‡†è¨±é¡˜å•†å“ä¸¦ä¸Šæ¶
      const handleApproveWish = async (wish, cost) => {
        if (!cost || cost <= 0) return alert("è«‹è¼¸å…¥æœ‰æ•ˆé»æ•¸");
        try {
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rewards', wish.id), {
                cost: parseInt(cost),
                available: true
            });
            alert("å•†å“å·²ä¸Šæ¶");
        } catch(e) {
            console.error(e);
            alert("ä¸Šæ¶å¤±æ•—");
        }
      };
      
      // æ›´æ–°ï¼šæ•´åˆç™¼é€èˆ‡æ‰£é™¤é»æ•¸çš„åŠŸèƒ½
      const handleManagePoints = async (isDeduct) => { 
        if(!givePointsAmount) return alert("è«‹è¼¸å…¥é»æ•¸");
        const amount = parseInt(givePointsAmount);
        if (isNaN(amount) || amount <= 0) return alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„æ­£æ•´æ•¸");

        const reason = givePointsReason || (isDeduct ? "ç³»çµ±æ‰£é™¤" : "ç³»çµ±è£œçµ¦");
        const finalAmount = isDeduct ? -amount : amount;

        // å¦‚æœæ˜¯æ‰£é™¤ï¼Œä¸”ç›®å‰é»æ•¸ä¸è¶³ï¼Œæç¤ºè­¦å‘Š
        if(isDeduct && points < amount) {
            if(!confirm(`è­¦å‘Šï¼šç›®å‰ç³»çµ±ç¸½é»æ•¸ (${points}) å°æ–¼æ¬²æ‰£é™¤é»æ•¸ (${amount})ï¼Œç¢ºå®šè¦åŸ·è¡Œå—ï¼Ÿ`)) return;
        }

        try {
            await addDoc(getPublicRef('submissions'), {
                description: `${isDeduct ? 'ğŸ’¸' : 'ğŸ'} ${reason}`, 
                status: isDeduct ? 'deducted' : 'bonus', 
                awardedPoints: finalAmount, 
                timestamp: serverTimestamp(), 
                userId: user.uid
            }); 
            
            const statsUpdate = {
                totalPoints: increment(finalAmount)
            };

            // ä¿æŒå¸³ç›®å¹³è¡¡ï¼šæ‰£é™¤è¦–ç‚ºä¸€ç¨®ã€Œå›æ”¶ã€ï¼Œç™¼é€è¦–ç‚ºã€Œç™¼è¡Œã€
            if(isDeduct) {
                statsUpdate.totalRedeemed = increment(amount);
            } else {
                statsUpdate.totalIssued = increment(amount);
            }

            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'stats', 'total'), statsUpdate); 
            
            setGivePointsAmount('');
            setGivePointsReason('');
            alert(isDeduct ? "å·²æ‰£é™¤é»æ•¸" : "å·²ç™¼é€é»æ•¸"); 
        } catch(e) {
            console.error(e);
            alert("æ“ä½œå¤±æ•—");
        }
      };
      
      const handleAddScratchActivity = async () => { if(adminScratchTitle && adminScratchCost){ setIsAddingReward(true); const img = adminScratchImage ? await compressImage(adminScratchImage) : null; if(editingScratchId) { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'scratch_activities', editingScratchId), {title: adminScratchTitle, prize: adminScratchPrize, cost: parseInt(adminScratchCost), ...(img && {image: img})}); setEditingScratchId(null); } else { const grid = Array(16).fill(0); grid[adminScratchWinnerIndex] = parseInt(adminScratchTarget); let others = []; for(let i=1; i<=16; i++) if(i!==parseInt(adminScratchTarget)) others.push(i); others.sort(()=>Math.random()-0.5); let o=0; for(let i=0; i<16; i++) if(i!==parseInt(adminScratchWinnerIndex)) grid[i]=others[o++]; await addDoc(getPublicRef('scratch_activities'), {title: adminScratchTitle, prize: adminScratchPrize, cost: parseInt(adminScratchCost), target: adminScratchTarget, grid, image: img || "https://placehold.co/400x300/e2e8f0/64748b?text=Game", isActive: true, timestamp: serverTimestamp()}); } setAdminScratchTitle(''); setIsAddingReward(false); }};
      const handleEditScratch = (g) => { setEditingScratchId(g.id); setAdminScratchTitle(g.title); setAdminScratchPrize(g.prize); setAdminScratchCost(g.cost); document.querySelector('.admin-scratch-form').scrollIntoView({behavior:'smooth'}); };
      const getRevealedCellsForGame = (gid) => { const s=new Set(); allScratchProgress.filter(p=>p.gameId===gid).forEach(d=>d.revealedIndices?.forEach(i=>s.add(i))); return s; };

      // Implement Missing function: handleRevealed
      // ä¿®æ­£é‚è¼¯ï¼šæ¯ä¸€åˆ®éƒ½è¦æ‰£é»ï¼Œä¸¦åŠ å…¥ç‰¹å®šæç¤ºèª
      const handleRevealed = async (val, game, idx) => {
        // æª¢æŸ¥é»æ•¸æ˜¯å¦è¶³å¤ 
        if (points < game.cost) {
            alert(`é»æ•¸ä¸è¶³ï¼æ¯æ¬¡åˆ®é™¤éœ€è¦ ${game.cost} é»`);
            // å¼·åˆ¶é‡æ–°æ•´ç†é é¢ä»¥é‡ç½®ç•«å¸ƒç‹€æ…‹ (å› ç‚º canvas æ˜¯æœ¬åœ°ç‹€æ…‹)
            window.location.reload();
            return;
        }

        // ä¿®æ­£ï¼šå°‡å„²å­˜è·¯å¾‘æ”¹ç‚º 'global'ï¼Œç¢ºä¿æ‰€æœ‰äººéƒ½çœ‹åˆ°ç›¸åŒçš„åˆ®å¡é€²åº¦ï¼Œä¸”åˆ·æ–°å¾Œä¸æœƒæ¶ˆå¤±
        const progRef = doc(db, 'artifacts', appId, 'public', 'data', 'scratch_progress', `${game.id}_global`);
        
        try {
            // 1. æ‰£é™¤å–®æ¬¡é»æ•¸
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'stats', 'total'), {
                totalPoints: increment(-game.cost),
                totalRedeemed: increment(game.cost)
            });

            await addDoc(getPublicRef('submissions'), {
                description: `ğŸ« åˆ®åˆ®æ¨‚è€—è²» (å°‹æ‰¾:${game.target})`,
                status: 'scratch',
                awardedPoints: -game.cost,
                timestamp: serverTimestamp(),
                userId: user.uid
            });

            // 2. æ›´æ–°é€²åº¦ (å¦‚æœæ–‡æª”ä¸å­˜åœ¨æœƒè‡ªå‹•å‰µå»º merge: true)
            // ä¿®æ­£ï¼šç§»é™¤ won: falseï¼Œé¿å…è¦†è“‹æ—¢æœ‰çš„ä¸­çç‹€æ…‹
            await setDoc(progRef, {
                gameId: game.id,
                // userId: user.uid, // ç§»é™¤ userId ç¶å®šï¼Œæ”¹ç‚ºå…¨åŸŸ
                revealedIndices: arrayUnion(idx),
                timestamp: serverTimestamp()
                // æ³¨æ„ï¼šé€™è£¡ä¸å‚³å…¥ won æ¬„ä½ï¼Œä»¥å…è¦†è“‹
            }, { merge: true });

            // 3. åˆ¤æ–·è¼¸è´
            if (parseInt(val) === parseInt(game.target)) {
                // ä¸­çé‚è¼¯
                const progSnap = await getDoc(progRef);
                // ç¢ºä¿åªé ˜ä¸€æ¬¡ç
                if (progSnap.exists() && !progSnap.data().wonAt) {
                     await setDoc(progRef, { won: true, wonAt: serverTimestamp() }, { merge: true });
                     
                     const prize = parseInt(game.prize);
                     if(prize > 0) {
                         await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'stats', 'total'), {
                            totalPoints: increment(prize),
                            totalIssued: increment(prize)
                         });
                         
                         await addDoc(getPublicRef('submissions'), {
                            description: `ğŸ‰ åˆ®åˆ®æ¨‚ä¸­çï¼š${game.title}`,
                            status: 'bonus',
                            awardedPoints: prize,
                            timestamp: serverTimestamp(),
                            userId: user.uid
                         });
                         
                         alert("æ­å–œèµ°ç‹—å±é‹å›‰!");
                     }
                }
            } else {
                // æ²’ä¸­çé‚è¼¯
                alert("åŠ æ²¹åŠ æ²¹!ä¸‹ä¸€åˆ®å°±æ˜¯äº†!");
            }
        } catch (e) {
            console.error(e);
            alert("é€£ç·šä¸ç©©ï¼Œè«‹ç¨å¾Œå†è©¦");
        }
      };

      // ä¿®æ­£ï¼šç§»é™¤ userId ç¯©é¸ï¼Œè®“æ‰€æœ‰ä½¿ç”¨è€…éƒ½èƒ½çœ‹åˆ°æ‰“å¡ç‰† (å…¨åŸŸé¡¯ç¤º)
      const myCheckinPhotos = useMemo(() => submissions.filter(s => s.status === 'checkin' && s.image).sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0)), [submissions]);
      const allCheckinPhotos = useMemo(() => submissions.filter(s => s.status === 'checkin' && s.image).sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0)), [submissions]);
      
      // ä¿®æ­£ï¼šç§»é™¤ userId ç¯©é¸ï¼Œè®“è¨±é¡˜æ± é¡¯ç¤ºæ‰€æœ‰äººçš„é¡˜æœ›
      const myWishes = useMemo(() => rewards.filter(r => !r.available), [rewards]);
      
      const unreadCount = user ? notifications.filter(n => !n.readBy?.includes(user.uid)).length : 0;
      
      // ä¿®æ­£ï¼šç§»é™¤ userId ç¯©é¸ï¼Œè®“æ‰€æœ‰äººéƒ½èƒ½çœ‹åˆ°éŠ€è¡Œäº¤æ˜“ç´€éŒ„ (é€™æ¨£åˆ·æ–°å¾Œç´€éŒ„æ‰ä¸æœƒæ¶ˆå¤±)
      const bankTransactions = useMemo(() => {
          return submissions.filter(s => (s.description.includes('é‡‘åº«') || s.description.includes('åˆ©æ¯'))).sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
      }, [submissions]);

      const wheelTotalWeight = useMemo(() => {
          return gameSettings.wheelSegments.reduce((sum, s) => sum + (s.weight || 0), 0);
      }, [gameSettings.wheelSegments]);

      if (loading) return null;

      return (
        <div className="max-w-md mx-auto shadow-2xl relative min-h-screen pb-24 sm:rounded-[40px] sm:my-4 sm:border-4 sm:border-slate-200 bg-[#f8fafc] overflow-hidden flex flex-col no-scrollbar">
          
          <div className="luxury-bg p-6 pb-10 text-white rounded-b-[45px] shadow-2xl shrink-0 z-10 relative">
            <div className="flex justify-between items-center mb-8">
              <div className="flex items-center gap-3 pl-2"><div className="w-1.5 h-6 luxury-gold-bg rounded-full"></div><h1 className="text-lg font-bold tracking-widest uppercase font-serif gold-accent">Point</h1></div>
              <div className="flex items-center gap-3">
                <button onClick={() => setActiveTab('notifs')} className="relative p-2.5 bg-white/10 rounded-xl border border-white/20"><Icon name="Bell" size={18} className="text-white"/>{unreadCount > 0 && <span className="absolute top-1.5 right-1.5 bg-amber-400 w-2 h-2 rounded-full"></span>}</button>
                <button onClick={() => isAdmin ? setIsAdmin(false) : setShowAdminLogin(!showAdminLogin)} className="p-2.5 bg-white/10 rounded-xl border border-white/20"><Icon name={isAdmin ? "LogOut" : "Lock"} size={18} className="text-white"/></button>
              </div>
            </div>
            <div className="flex justify-center mb-6"><div className="header-point-card px-10 py-3 rounded-2xl flex flex-col items-center min-w-[150px]"><span className="text-[10px] text-white/70 uppercase tracking-widest font-bold mb-1">ç›®å‰é»æ•¸</span><span className="text-4xl font-bold text-white tracking-tight drop-shadow-lg">{points}</span></div></div>
            <div className="bg-white/10 border border-white/20 rounded-xl px-4 py-2 marquee mx-2 backdrop-blur-md"><span className="text-[11px] font-light text-white uppercase tracking-wide">{announcement}</span></div>
            {showAdminLogin && !isAdmin && <div className="absolute top-24 right-6 bg-white p-6 rounded-2xl shadow-2xl z-50 w-64 text-slate-800 border animate-in"><input type="password" placeholder="ç®¡ç†å“¡å¯†ç¢¼" className="w-full bg-slate-50 border p-3 rounded-xl mb-3 text-center tracking-widest outline-none text-sm" value={adminPass} onChange={e => setAdminPass(e.target.value)} autoFocus /><button onClick={checkAdmin} className="w-full btn-primary py-3 rounded-xl font-bold text-xs uppercase tracking-widest">é©—è­‰èº«ä»½</button></div>}
          </div>

          <div className="p-6 flex-1 overflow-y-auto no-scrollbar space-y-10">
            {activeTab === 'home' && (
              <div className="space-y-10 animate-in">
                <div className="luxury-card p-7 rounded-[35px] space-y-5">
                  <h3 className="font-bold text-deep-blue flex items-center gap-2"><Icon name="Plus" size={18}/> è³ºå–é»æ•¸å›å ±</h3>
                  <textarea className="w-full bg-slate-50 border border-slate-100 p-5 rounded-2xl text-sm min-h-[110px] outline-none" placeholder="è¨˜éŒ„ä»Šå¤©çš„åŠªåŠ›..." value={desc} onChange={e => setDesc(e.target.value)} />
                  <div className="flex gap-3">
                    <label className={`flex-1 cursor-pointer py-4 rounded-xl flex items-center justify-center border border-dashed transition-all ${selectedFile ? 'border-amber-500 bg-amber-50 text-amber-700' : 'text-slate-400 border-slate-200'}`}>
                      <Icon name="Image" size={18} className="mr-2"/> <span className="font-bold text-xs">{selectedFile ? 'å·²å°±ç·’' : 'é™„åœ–'}</span>
                      <input type="file" accept="image/*" className="hidden" onChange={e => setSelectedFile(e.target.files[0])} />
                    </label>
                    <button onClick={handleUploadTask} className="flex-1 btn-primary py-4 rounded-xl font-bold text-xs uppercase tracking-widest">é€å‡º</button>
                  </div>
                </div>

                <div className="luxury-card p-6 rounded-[30px] flex items-center gap-5">
                    <label className={`w-16 h-16 rounded-2xl border-2 border-dashed flex flex-col items-center justify-center shrink-0 transition-colors ${checkInImage ? 'border-amber-500 bg-amber-50 text-amber-700' : 'border-slate-200 text-slate-300'}`}>
                        <Icon name="Camera" size={24}/>
                        <input type="file" accept="image/*" className="hidden" onChange={e => setCheckInImage(e.target.files[0])} />
                    </label>
                    <div className="flex-1"><p className="font-bold text-sm text-deep-blue">æŒ‡ç”²ä¿è­·</p><p className="text-[10px] text-label">ä¸Šå‚³ç¾ç…§é ˜ {gameSettings.checkInPoints} P</p></div>
                    <button onClick={handleCheckIn} className={`px-6 py-2.5 rounded-xl text-xs font-bold transition-all shadow-sm ${!checkInImage ? 'bg-slate-50 text-slate-300' : 'btn-primary'}`}>æ‰“å¡</button>
                </div>

                <div className="space-y-4">
                  <h3 className="text-label px-2 border-l-2 border-slate-800 pl-3 ml-1">æœ€æ–°å‹•æ…‹</h3>
                  <div className="grid grid-cols-3 gap-3">
                      {allCheckinPhotos.slice(0, 9).map(c => (
                          <div key={c.id} className="aspect-square rounded-2xl overflow-hidden relative shadow-md border border-white group">
                             <img src={c.image} className="w-full h-full object-cover group-hover:scale-110 transition-transform" />
                             <div className="absolute bottom-0 w-full bg-black/60 text-white text-[9px] font-medium py-1 text-center backdrop-blur-sm">
                                {c.timestamp ? new Date(c.timestamp.seconds * 1000).toLocaleDateString('zh-TW', {month:'numeric', day:'numeric'}) : ''}
                             </div>
                          </div>
                      ))}
                  </div>
                </div>

                <div className="space-y-5">
                  <h3 className="text-label px-2 border-l-2 border-slate-800 pl-3 ml-1">å¸³æˆ¶å­˜æ‘º</h3>
                  <div className="luxury-card rounded-[30px] overflow-hidden">
                    {submissions.length === 0 ? <p className="text-center text-xs py-12 text-slate-300 font-light">ç›®å‰å°šç„¡é»æ•¸ç•°å‹•ç´€éŒ„</p> : submissions.filter(s => ['pending', 'approved', 'deducted', 'redeemed', 'checkin', 'bonus', 'rejected', 'mission_reward', 'scratch'].includes(s.status)).map(item => (
                        <div key={item.id} className="p-5 flex justify-between items-center border-b border-slate-50 last:border-0 hover:bg-slate-50/50 transition-colors">
                          <div className="flex flex-col min-w-0 pr-4">
                             <span className="text-[10px] text-slate-400 font-bold uppercase tracking-tighter mb-1">{item.timestamp ? new Date(item.timestamp.seconds * 1000).toLocaleDateString() : 'å‰›å‰›'}</span>
                             <div className="text-xs font-bold text-deep-blue truncate">{item.description}</div>
                          </div>
                          <div className={`text-xs font-bold ${item.status==='rejected' ? 'text-slate-300' : item.status==='pending' ? 'text-amber-500' : (item.awardedPoints > 0 ? 'text-emerald-600' : 'text-rose-500')}`}>
                             {item.status==='rejected' ? 'é§å›' : item.status==='pending' ? 'å¯©æ ¸ä¸­' : (item.awardedPoints > 0 ? `+${item.awardedPoints}` : item.awardedPoints)}
                          </div>
                        </div>
                    ))}
                  </div>
                </div>
              </div>
            )}

            {activeTab === 'activities' && (
               <div className="space-y-8 animate-in">
                  {!currentActivity ? (
                     <div className="space-y-4">
                        <div onClick={() => setCurrentActivity('wheel')} className="luxury-card p-6 h-28 flex items-center justify-between border-slate-100 hover:-translate-y-1 transition-all group cursor-pointer relative overflow-hidden">
                           <div className="absolute -right-6 -bottom-6 w-32 h-32 bg-indigo-50 rounded-full group-hover:scale-110 transition-transform z-0"></div>
                           <div className="relative z-10 flex items-center gap-4"><Icon name="Disc" size={32} className="text-indigo-400"/><div className="text-left"><p className="text-sm font-bold text-deep-blue uppercase tracking-widest">å¹¸é‹è½‰ç›¤</p><p className="text-[10px] text-label">è´å–å€ç‡çé‡‘</p></div></div>
                           <Icon name="ArrowLeft" size={16} className="rotate-180 text-slate-300"/>
                        </div>
                        <div onClick={() => setCurrentActivity('rps')} className="luxury-card p-6 h-28 flex items-center justify-between border-slate-100 hover:-translate-y-1 transition-all group cursor-pointer relative overflow-hidden">
                           <div className="absolute -right-6 -bottom-6 w-32 h-32 bg-rose-50 rounded-full group-hover:scale-110 transition-transform z-0"></div>
                           <div className="relative z-10 flex items-center gap-4"><Icon name="Hand" size={32} className="text-rose-400"/><div className="text-left"><p className="text-sm font-bold text-deep-blue uppercase tracking-widest">çŒœæ‹³å¤§å°æ±º</p><p className="text-[10px] text-label">ä»¥å°åšå¤§</p></div></div>
                           <Icon name="ArrowLeft" size={16} className="rotate-180 text-slate-300"/>
                        </div>
                        <div onClick={() => setCurrentActivity('bank')} className="luxury-card p-6 h-28 flex items-center justify-between border-slate-100 hover:-translate-y-1 transition-all group cursor-pointer relative overflow-hidden">
                           <div className="absolute -right-6 -bottom-6 w-32 h-32 bg-emerald-50 rounded-full group-hover:scale-110 transition-transform z-0"></div>
                           <div className="relative z-10 flex items-center gap-4"><Icon name="PiggyBank" size={32} className="text-emerald-500"/><div className="text-left"><p className="text-sm font-bold text-deep-blue uppercase tracking-widest">é»æ•¸å°é‡‘åº«</p><p className="text-[10px] text-label">å­˜é»ç”Ÿåˆ©æ¯</p></div></div>
                           <Icon name="ArrowLeft" size={16} className="rotate-180 text-slate-300"/>
                        </div>
                        <div onClick={() => setCurrentActivity('dice')} className="luxury-card p-6 h-28 flex items-center justify-between border-slate-100 hover:-translate-y-1 transition-all group cursor-pointer relative overflow-hidden">
                           <div className="absolute -right-6 -bottom-6 w-32 h-32 bg-amber-50 rounded-full group-hover:scale-110 transition-transform z-0"></div>
                           <div className="relative z-10 flex items-center gap-4"><Icon name="Dice" size={32} className="text-amber-500"/><div className="text-left"><p className="text-sm font-bold text-deep-blue uppercase tracking-widest">éª°å­å¤§å¸«</p><p className="text-[10px] text-label">è²·å¤§è²·å°è´çé‡‘</p></div></div>
                           <Icon name="ArrowLeft" size={16} className="rotate-180 text-slate-300"/>
                        </div>
                        <div onClick={() => setCurrentActivity('scratch_list')} className="luxury-card p-6 h-28 flex items-center justify-between border-slate-100 hover:-translate-y-1 transition-all group cursor-pointer relative overflow-hidden">
                           <div className="absolute -right-6 -bottom-6 w-32 h-32 bg-slate-100 rounded-full group-hover:scale-110 transition-transform z-0"></div>
                           <div className="relative z-10 flex items-center gap-4"><Icon name="Ticket" size={32} className="text-slate-600"/><div className="text-left"><p className="text-sm font-bold text-deep-blue uppercase tracking-widest">åˆ®åˆ®æ¨‚</p><p className="text-[10px] text-label">è©¦è©¦æ‰‹æ°£</p></div></div>
                           <Icon name="ArrowLeft" size={16} className="rotate-180 text-slate-300"/>
                        </div>
                     </div>
                  ) : currentActivity === 'wheel' ? (
                     <div className="luxury-card p-8 rounded-[40px] flex flex-col items-center animate-in">
                        <button onClick={() => setCurrentActivity(null)} className="self-start mb-6 text-[10px] font-bold text-slate-400 uppercase tracking-widest bg-slate-50 px-3 py-1.5 rounded-full">â† è¿”å›</button>
                        <div className="relative w-64 h-64 mb-8">
                           <div className="w-full h-full rounded-full border-[10px] border-white shadow-2xl overflow-hidden relative transition-transform duration-[3000ms] ease-out" style={{ transform: `rotate(${wheelRotation}deg)`, background: `conic-gradient(${gameSettings.wheelSegments.map((s,i) => `${s.color} ${i*60}deg ${(i+1)*60}deg`).join(',')})` }}>
                              {gameSettings.wheelSegments.map((seg, i) => <div key={i} className="wheel-segment" style={{ transform: `rotate(${i * 60}deg)` }}><span className="wheel-text">{seg.label}</span></div>)}
                           </div>
                           <div className="absolute top-0 left-1/2 -translate-x-1/2 -mt-4 w-0 h-0 border-l-[14px] border-l-transparent border-r-[14px] border-r-transparent border-t-[24px] border-t-slate-800 z-10"></div>
                        </div>
                        <button onClick={handleSpinWheel} disabled={wheelSpinning} className="w-full btn-luxury py-5 shadow-xl text-xs uppercase font-bold tracking-widest mb-8">{wheelSpinning ? 'æ—‹è½‰ä¸­...' : `æ—‹è½‰ä¸€æ¬¡ (${gameSettings.wheelCost} P)`}</button>
                        
                        {/* çé …æ©Ÿç‡è¡¨ */}
                        <div className="w-full bg-slate-50 rounded-2xl p-4 border border-slate-100">
                           <h4 className="text-xs font-bold text-slate-500 mb-3 text-center uppercase tracking-widest">çé …æ©Ÿç‡ä¸€è¦½</h4>
                           <div className="space-y-2">
                              {gameSettings.wheelSegments.map((seg, i) => (
                                 <div key={i} className="flex justify-between items-center text-[10px]">
                                    <div className="flex items-center gap-2">
                                       <div className="w-2 h-2 rounded-full" style={{background: seg.color}}></div>
                                       <span className="font-bold text-slate-700">{seg.label}</span>
                                    </div>
                                    <span className="font-mono text-slate-400">{Math.round((seg.weight || 0) / (wheelTotalWeight || 1) * 100)}%</span>
                                 </div>
                              ))}
                           </div>
                        </div>
                     </div>
                  ) : currentActivity === 'rps' ? (
                     <div className="luxury-card p-10 rounded-[40px] text-center animate-in">
                        <button onClick={() => setCurrentActivity(null)} className="self-start mb-6 text-[10px] font-bold text-slate-400 uppercase bg-slate-50 px-3 py-1.5 rounded-full">â† è¿”å›</button>
                        <h2 className="font-bold text-deep-blue text-lg mb-2 tracking-widest">çŒœæ‹³å¤§å°æ±º</h2>
                        <div className="bg-slate-50 p-4 rounded-xl mb-8 border border-slate-100 flex flex-col gap-2">
                           <div className="flex justify-between text-[10px] text-label tracking-wide">
                              <span>ä¸‹æ³¨é‡‘é¡ (æœ€å°‘2é»)</span>
                              <span>ç²å‹: {gameSettings.rpsWinMultiplier}å€</span>
                           </div>
                           <input type="number" className="settings-input text-center text-lg font-bold" value={rpsBetAmount} onChange={e => setRpsBetAmount(Math.max(2, parseInt(e.target.value)))} />
                        </div>

                        <div className="flex justify-around items-center mb-12">
                           <div className={rpsState==='playing'?'animate-bounce-hand':''}>
                              <div className="text-5xl mb-4">{rpsUserChoice==='rock'?'âœŠ':rpsUserChoice==='paper'?'ğŸ–ï¸':rpsUserChoice==='scissors'?'âœŒï¸':'â“'}</div>
                              <p className="text-[10px] text-label">ç©å®¶</p>
                           </div>
                           <div className="text-slate-300 text-xl italic font-serif">vs</div>
                           <div className={rpsState==='playing'?'animate-bounce-hand':''}>
                              <div className="text-5xl mb-4">{rpsCpuChoice==='rock'?'âœŠ':rpsCpuChoice==='paper'?'ğŸ–ï¸':rpsCpuChoice==='scissors'?'âœŒï¸':'â“'}</div>
                              <p className="text-[10px] text-label">åº—é•·</p>
                           </div>
                        </div>
                        <div className="grid grid-cols-3 gap-4">
                           <button onClick={() => handlePlayRPS('rock')} className="bg-white border-slate-200 border p-4 rounded-2xl shadow-sm hover:shadow-md text-3xl">âœŠ</button>
                           <button onClick={() => handlePlayRPS('paper')} className="bg-white border-slate-200 border p-4 rounded-2xl shadow-sm hover:shadow-md text-3xl">ğŸ–ï¸</button>
                           <button onClick={() => handlePlayRPS('scissors')} className="bg-white border-slate-200 border p-4 rounded-2xl shadow-sm hover:shadow-md text-3xl">âœŒï¸</button>
                        </div>
                     </div>
                  ) : currentActivity === 'bank' ? (
                     <div className="luxury-card p-8 rounded-[40px] space-y-8 animate-in">
                        <button onClick={() => setCurrentActivity(null)} className="text-[10px] font-bold text-slate-400 uppercase bg-slate-50 px-3 py-1.5 rounded-full">â† è¿”å›</button>
                        <div className="luxury-gold-bg p-10 rounded-[30px] text-center shadow-xl relative overflow-hidden">
                           <p className="text-[10px] font-bold text-white/80 uppercase mb-3">å°é‡‘åº«é¤˜é¡</p>
                           <p className="text-5xl font-bold text-white drop-shadow-sm">{savings.balance || 0}</p>
                           <div className="mt-5 flex justify-center gap-2">
                             <p className="text-[9px] font-bold text-white bg-white/20 inline-block px-3 py-1 rounded-full backdrop-blur-md">åˆ©ç‡: {gameSettings.bankRate * 100}%</p>
                             <p className="text-[9px] font-bold text-white bg-white/20 inline-block px-3 py-1 rounded-full backdrop-blur-md">é–‰é–: {gameSettings.bankLockHours}hr</p>
                           </div>
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                           <button onClick={handleDeposit} className="bg-slate-50 border py-4 rounded-xl font-bold text-xs uppercase hover:bg-slate-100 text-deep-blue">å­˜å…¥</button>
                           <button onClick={handleWithdraw} className="bg-slate-50 border py-4 rounded-xl font-bold text-xs uppercase hover:bg-slate-100 text-deep-blue">æé ˜</button>
                        </div>
                        <button onClick={handleCollectInterest} className="w-full py-5 border-2 border-amber-400 text-amber-700 rounded-2xl font-bold text-xs uppercase hover:bg-amber-50">é ˜å–æ¯æ—¥åˆ©æ¯</button>
                        
                        <div className="border-t border-slate-100 pt-6">
                           <p className="text-label mb-4 px-2">äº¤æ˜“æ˜ç´°</p>
                           <div className="space-y-3 h-40 overflow-y-auto no-scrollbar">
                              {bankTransactions.length === 0 ? <p className="text-center text-xs text-slate-300 py-4 font-light">ç„¡äº¤æ˜“ç´€éŒ„</p> : bankTransactions.map(t => (
                                 <div key={t.id} className="flex justify-between items-center bg-slate-50 p-3 rounded-xl border border-slate-100">
                                    <div className="flex flex-col">
                                       <span className="text-[9px] text-slate-400 font-bold">{t.timestamp ? new Date(t.timestamp.seconds * 1000).toLocaleDateString() : ''}</span>
                                       <span className="text-xs font-bold text-deep-blue">{t.description}</span>
                                    </div>
                                    <span className={`text-xs font-bold ${t.awardedPoints > 0 ? 'text-emerald-600' : 'text-slate-400'}`}>{t.awardedPoints > 0 ? `+${t.awardedPoints}` : t.awardedPoints}</span>
                                 </div>
                              ))}
                           </div>
                        </div>
                     </div>
                  ) : currentActivity === 'dice' ? (
                     <div className="luxury-card p-8 rounded-[40px] animate-in text-center">
                        <button onClick={() => setCurrentActivity(null)} className="self-start mb-6 text-[10px] font-bold text-slate-400 uppercase bg-slate-50 px-3 py-1.5 rounded-full">â† è¿”å›</button>
                        <h2 className="font-bold text-deep-blue text-lg mb-2">éª°å­å¤§å¸« (Sic Bo)</h2>
                        <div className="bg-slate-50 p-4 rounded-xl mb-8 border border-slate-100 flex flex-col gap-2">
                           <div className="flex justify-between text-[10px] text-label tracking-wide">
                              <span>ä¸‹æ³¨é‡‘é¡ (æœ€å°‘10é»)</span>
                              <span>è³ ç‡: 1è³ 1</span>
                           </div>
                           <input type="number" className="settings-input text-center text-lg font-bold" value={diceBetAmount} onChange={e => setDiceBetAmount(Math.max(10, parseInt(e.target.value)))} />
                        </div>

                        <div className="flex gap-4 justify-center mb-8 h-20 items-center">
                           {diceValues.map((v, i) => (
                              <div key={i} className={`w-16 h-16 bg-white rounded-xl shadow-md border border-slate-200 flex items-center justify-center text-4xl text-deep-blue ${isDiceRolling ? 'dice-shake' : ''}`}>
                                 {['âš€','âš','âš‚','âšƒ','âš„','âš…'][v-1]}
                              </div>
                           ))}
                        </div>
                        
                        <div className="grid grid-cols-2 gap-4 mb-4">
                           <button onClick={() => setDiceBetTarget('big')} className={`py-4 rounded-xl font-bold text-lg uppercase shadow-md transition-all ${diceBetTarget === 'big' ? 'bg-indigo-600 text-white ring-2 ring-indigo-300' : 'bg-white text-indigo-600 border border-indigo-100'}`}>å¤§ (11-17)</button>
                           <button onClick={() => setDiceBetTarget('small')} className={`py-4 rounded-xl font-bold text-lg uppercase shadow-md transition-all ${diceBetTarget === 'small' ? 'bg-amber-500 text-white ring-2 ring-amber-300' : 'bg-white text-amber-600 border border-amber-100'}`}>å° (4-10)</button>
                        </div>

                        <button onClick={handleRollDice} disabled={isDiceRolling} className="w-full btn-primary py-4 rounded-xl font-bold text-xs uppercase tracking-widest shadow-xl">{isDiceRolling ? 'æ“²éª°ä¸­...' : 'ä¸‹æ³¨ä¸¦æ“²éª°'}</button>
                        <p className="text-[10px] text-slate-400 mt-4">*åœéª° (ä¸‰é¡†é»æ•¸ç›¸åŒ) èŠå®¶é€šæ®º</p>
                     </div>
                  ) : currentActivity === 'scratch_list' ? (
                      <div className="animate-in">
                        <button onClick={() => setCurrentActivity(null)} className="mb-4 text-slate-400 hover:text-slate-600 flex items-center text-xs font-bold uppercase tracking-wider"><Icon name="ArrowLeft" size={14} className="mr-1"/> å¤§å»³</button>
                        <div className="space-y-4">
                          {scratchActivities.length === 0 ? <p className="text-center py-10 text-xs text-slate-300">ç›®å‰æ²’æœ‰åˆ®åˆ®æ¨‚</p> : scratchActivities.map(game => (
                             <div key={game.id} onClick={() => {setSelectedScratchGame(game); setCurrentActivity('scratch_game');}} className="luxury-card p-6 h-28 flex items-center justify-between border-slate-100 hover:-translate-y-1 transition-all group cursor-pointer relative overflow-hidden">
                                <div className="absolute -right-6 -bottom-6 w-32 h-32 bg-slate-100 rounded-full group-hover:scale-110 transition-transform z-0"></div>
                                <div className="relative z-10 flex items-center gap-4">
                                   <div className="w-12 h-12 rounded-xl bg-white overflow-hidden shadow-sm border border-slate-100"><img src={game.image} className="w-full h-full object-cover"/></div>
                                   <div className="text-left"><p className="text-sm font-bold text-deep-blue">{game.title}</p><p className="text-[10px] text-label">å¤§ç: {game.prize}</p></div>
                                </div>
                                <div className="text-xs font-bold text-slate-600 bg-slate-50 px-3 py-1 rounded-lg z-10 border border-slate-200">{game.cost} P / åˆ®</div>
                             </div>
                          ))}
                        </div>
                      </div>
                  ) : currentActivity === 'scratch_game' && selectedScratchGame ? (
                      <div className="luxury-card p-6 rounded-[30px] animate-in">
                        <button onClick={() => {setCurrentActivity('scratch_list'); setCanScratchNow(false);}} className="mb-4 text-slate-400 flex items-center text-xs font-bold"><Icon name="ArrowLeft" size={14} className="mr-1"/> è¿”å›</button>
                        <div className="text-center mb-6">
                            <h2 className="font-bold text-xl mb-1 text-deep-blue">{selectedScratchGame.title}</h2>
                            <div className="inline-block bg-slate-50 px-4 py-2 rounded-xl border border-slate-100 mb-2">
                                <p className="text-xs text-slate-500 font-bold mb-1">å°‹æ‰¾å¹¸é‹æ•¸å­—</p>
                                <p className="text-3xl font-black text-rose-500">{selectedScratchGame.target}</p>
                            </div>
                            <p className="text-xs text-slate-400 font-bold mt-2">æ¯åˆ®ä¸€æ ¼æ‰£é™¤ <span className="text-deep-blue">{selectedScratchGame.cost} P</span></p>
                        </div>
                        
                        {/* ç§»é™¤è³¼è²·æŒ‰éˆ•ï¼Œç›´æ¥é¡¯ç¤ºæ ¼å­ï¼Œé€é points åˆ¤æ–·æ˜¯å¦å¯ç© */}
                        <div className="grid grid-cols-4 gap-2.5">
                            {selectedScratchGame.grid.map((val, i) => { 
                                const isRevealed = currentGameProgress.includes(i); 
                                // åªæœ‰æ²’åˆ®é–‹ä¸”é»æ•¸è¶³å¤ æ™‚æ‰èƒ½åˆ®
                                return <ScratchCell key={i} value={val} canScratch={!isRevealed && points >= selectedScratchGame.cost} isRevealed={isRevealed} onRevealed={(v) => handleRevealed(v, selectedScratchGame, i)} />; 
                            })}
                        </div>
                        
                        {points < selectedScratchGame.cost && (
                            <p className="text-center text-xs text-rose-500 font-bold mt-4">é»æ•¸ä¸è¶³ï¼Œç„¡æ³•ç¹¼çºŒåˆ®é™¤</p>
                        )}
                      </div>
                  ) : null}
               </div>
            )}

            {activeTab === 'rewards' && (
              <div className="space-y-8 animate-in">
                <div className="luxury-card p-6 rounded-[30px] space-y-4">
                  <h3 className="font-bold text-deep-blue">å¤¢æƒ³è¨±é¡˜æ± </h3>
                  <input className="settings-input text-[11px]" placeholder="æƒ³è¦ä»€éº¼çå‹µ..." value={wishName} onChange={e => setWishName(e.target.value)} />
                  <label className="block mb-2">
                      <span className="settings-label mb-1">è¨±é¡˜åœ–ç‰‡ (å¯é¸)</span>
                      <input type="file" accept="image/*" className="text-[10px] text-slate-400 w-full" onChange={e => setWishImage(e.target.files[0])} />
                  </label>
                  <button onClick={handleMakeWish} disabled={isWishing} className="w-full btn-luxury py-4 rounded-xl font-bold text-xs uppercase tracking-widest">{isWishing ? 'æäº¤ä¸­...' : 'é€å‡ºå¤¢æƒ³'}</button>
                </div>
                
                {myWishes.length > 0 && (
                  <div className="mb-2">
                    <h3 className="text-label px-2 mb-3">å¯©æ ¸ä¸­çš„é¡˜æœ›</h3>
                    <div className="flex gap-3 overflow-x-auto pb-4 no-scrollbar">
                      {myWishes.map(wish => (
                        <div key={wish.id} className="min-w-[100px] w-[100px] flex-shrink-0 group">
                           <div className="w-full h-24 rounded-2xl bg-white overflow-hidden mb-2 relative border border-slate-100 shadow-sm">
                              {wish.image && <img src={wish.image} className="w-full h-full object-cover opacity-80" />}
                              <div className="absolute inset-0 flex items-center justify-center bg-black/5"><span className="text-[9px] bg-white/90 text-slate-600 px-2 py-1 rounded-full shadow-sm font-bold">å¯©æ ¸ä¸­</span></div>
                           </div>
                           <p className="text-xs font-bold text-slate-600 truncate text-center">{wish.name}</p>
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                <div className="grid grid-cols-2 gap-5">
                      {rewards.filter(r => r.available).map(item => (
                        <div key={item.id} className="luxury-card p-4 rounded-[30px] flex flex-col relative group shadow-sm border-slate-100">
                           <div className="aspect-square bg-slate-50 rounded-2xl mb-4 overflow-hidden border border-slate-50"><img src={item.image} className="w-full h-full object-cover group-hover:scale-105 transition-transform" /></div>
                           <h4 className="font-bold text-sm mb-2 truncate px-1 text-deep-blue">{item.name}</h4>
                           <button onClick={() => handleRedeem(item)} className="w-full py-3 bg-slate-800 text-white rounded-xl text-[10px] font-bold uppercase tracking-wider">{item.cost} P å…Œæ›</button>
                           {isAdmin && <div onClick={() => deleteItem('rewards', item.id, item.name)} className="delete-badge"><Icon name="Trash2" size={12}/></div>}
                        </div>
                      ))}
                </div>
              </div>
            )}

            {activeTab === 'notifs' && (
                <div className="space-y-4 animate-in">
                    <h3 className="text-label px-2 mb-2">é€šçŸ¥ä¸­å¿ƒ</h3>
                    {notifications.length === 0 ? (
                        <div className="text-center py-20 text-slate-300 text-xs font-light">æš«ç„¡æ–°é€šçŸ¥</div>
                    ) : (
                        notifications.map(n => (
                            <div key={n.id} className="bg-white p-5 rounded-[24px] border border-slate-100 shadow-sm">
                                <div className="flex justify-between items-start mb-1"><h4 className="font-bold text-deep-blue text-sm">{n.title}</h4><span className="text-[10px] text-slate-300">{n.timestamp ? new Date(n.timestamp.seconds * 1000).toLocaleDateString() : ''}</span></div>
                                <p className="text-xs text-slate-500 leading-relaxed font-light">{n.message}</p>
                            </div>
                        ))
                    )}
                </div>
            )}

            {activeTab === 'admin' && isAdmin && (
               <div className="space-y-8 animate-in pb-12">
                  <div className="luxury-bg p-6 rounded-[30px] text-white shadow-lg relative overflow-hidden">
                    <h2 className="text-sm font-bold flex gap-2 items-center mb-6"><Icon name="Chart" size={18}/> ç‡Ÿé‹å„€è¡¨æ¿</h2>
                    <div className="grid grid-cols-2 gap-4">
                      <div className="bg-white/10 p-4 rounded-2xl border border-white/10"><p className="text-[9px] font-bold text-slate-300 uppercase tracking-widest mb-1">å·²ç™¼æ”¾</p><p className="text-2xl font-bold">{stats.totalIssued}</p></div>
                      <div className="bg-white/10 p-4 rounded-2xl border border-white/10"><p className="text-[9px] font-bold text-slate-300 uppercase tracking-widest mb-1">å·²å›æ”¶</p><p className="text-2xl font-bold">{stats.totalRedeemed}</p></div>
                    </div>
                    <button onClick={updateAnnounce} className="w-full mt-4 bg-white/10 py-3 rounded-xl text-[10px] font-bold hover:bg-white/20 transition-colors">ä¿®æ”¹å…¬å‘Š</button>
                  </div>
                  
                  {/* æ›´æ–°: ç³»çµ±è£œçµ¦/æ‰£é™¤ UI */}
                  <div className="luxury-card p-7 rounded-[35px] space-y-4">
                      <h3 className="font-bold flex items-center gap-3 text-deep-blue text-xs tracking-widest uppercase">ç³»çµ±é»æ•¸ç®¡ç† (æ‰‹å‹•å¢æ¸›)</h3>
                      <div className="flex gap-3">
                        <input className="settings-input flex-[2]" placeholder="åŸå›  (ä¾‹å¦‚: é¡å¤–çå‹µã€æ‡²ç½°)" value={givePointsReason} onChange={e => setGivePointsReason(e.target.value)} />
                        <input type="number" className="settings-input flex-1" placeholder="é»æ•¸" value={givePointsAmount} onChange={e => setGivePointsAmount(e.target.value)} />
                      </div>
                      <div className="flex gap-3">
                          <button onClick={() => handleManagePoints(false)} className="flex-1 btn-gold py-3 rounded-xl font-bold text-xs uppercase tracking-widest shadow-md">ç™¼é€é»æ•¸ (+)</button>
                          <button onClick={() => handleManagePoints(true)} className="flex-1 bg-slate-200 text-slate-600 hover:bg-slate-300 transition-colors py-3 rounded-xl font-bold text-xs uppercase tracking-widest shadow-md">æ‰£é™¤é»æ•¸ (-)</button>
                      </div>
                  </div>

                  <div className="luxury-card p-7 rounded-[35px] space-y-6">
                      <h3 className="font-bold flex items-center gap-3 text-deep-blue text-xs tracking-widest uppercase">å¾…è™•ç†å¯©æ ¸</h3>
                      <div className="space-y-5">
                        {submissions.filter(s => s.status==='pending').map(sub => (
                           <div key={sub.id} className="bg-slate-50 p-5 rounded-2xl space-y-4 border border-slate-100 shadow-sm">
                              {sub.image && <img src={sub.image} className="w-full h-44 object-cover rounded-xl" />}
                              <p className="text-xs font-medium italic">"{sub.description}"</p>
                              <div className="flex gap-3">
                                 <input type="number" className="settings-input flex-1 font-bold" placeholder="10" value={approvalPoints[sub.id] || ''} onChange={e => setApprovalPoints({...approvalPoints, [sub.id]: e.target.value})} />
                                 <button onClick={() => handleApprove(sub, approvalPoints[sub.id] || 10)} className="btn-primary px-8 text-xs font-bold uppercase">æ‰¹å‡†</button>
                                 <button onClick={() => handleReject(sub)} className="bg-slate-200 px-4 rounded-xl text-xs font-bold text-slate-500">æ‹’çµ•</button>
                              </div>
                           </div>
                        ))}
                      </div>
                  </div>
                  
                  {/* æ–°å¢å€å¡Šï¼šè¨±é¡˜æ± å¯©æ ¸ */}
                  <div className="luxury-card p-7 rounded-[35px] space-y-6">
                      <h3 className="font-bold flex items-center gap-3 text-deep-blue text-xs tracking-widest uppercase">è¨±é¡˜æ± å¯©æ ¸ (ç©å®¶è¨±é¡˜)</h3>
                      <div className="space-y-4">
                        {rewards.filter(r => !r.available).length === 0 ? <p className="text-center text-xs text-slate-300">ç›®å‰æ²’æœ‰è¨±é¡˜</p> : 
                            rewards.filter(r => !r.available).map(wish => (
                                <div key={wish.id} className="bg-slate-50 p-4 rounded-2xl flex gap-4 items-center border border-slate-100 shadow-sm">
                                    <div className="w-16 h-16 rounded-xl bg-white overflow-hidden shrink-0"><img src={wish.image} className="w-full h-full object-cover" /></div>
                                    <div className="flex-1 min-w-0">
                                        <p className="text-xs font-bold text-deep-blue truncate">{wish.name}</p>
                                        <p className="text-[9px] text-slate-400">{wish.timestamp ? new Date(wish.timestamp.seconds * 1000).toLocaleDateString() : ''}</p>
                                    </div>
                                    <div className="flex flex-col gap-2 items-end">
                                        <input type="number" className="settings-input w-24 text-center py-1" placeholder="è¨­å®šé»æ•¸" value={wishCosts[wish.id] || ''} onChange={e => setWishCosts({...wishCosts, [wish.id]: e.target.value})} />
                                        <div className="flex gap-1">
                                            <button onClick={() => handleApproveWish(wish, wishCosts[wish.id])} className="btn-primary px-3 py-1.5 text-[10px] font-bold">ä¸Šæ¶</button>
                                            <button onClick={() => deleteItem('rewards', wish.id, wish.name)} className="bg-slate-200 px-3 py-1.5 rounded-lg text-[10px] font-bold text-slate-500">åˆªé™¤</button>
                                        </div>
                                    </div>
                                </div>
                            ))
                        }
                      </div>
                  </div>

                  <div className="luxury-card p-7 rounded-[35px] space-y-6">
                      <h3 className="font-bold flex items-center gap-3 text-deep-blue text-xs tracking-widest uppercase">å…¨ç³»çµ±æ‰“å¡ç‰†</h3>
                      <div className="grid grid-cols-3 gap-2">
                        {allCheckinPhotos.map(c => (
                           <div key={c.id} className="aspect-square rounded-xl overflow-hidden relative border border-slate-200 shadow-sm group">
                              <img src={c.image} className="w-full h-full object-cover" />
                              <div onClick={() => deleteItem('submissions', c.id, 'é€™å¼µç…§ç‰‡')} className="delete-badge hover:scale-110" style={{top:2, right:2}}><Icon name="Trash2" size={10}/></div>
                           </div>
                        ))}
                      </div>
                  </div>

                  <div className="luxury-card p-7 rounded-[35px] space-y-6">
                      <h3 className="font-bold flex items-center gap-3 text-deep-blue text-xs tracking-widest uppercase">éŠæˆ²åƒæ•¸è¨­å®š</h3>
                      <div className="grid grid-cols-2 gap-4">
                        <div><label className="settings-label">è½‰ç›¤è²»ç”¨</label><input type="number" className="settings-input" value={pendingSettings?.wheelCost} onChange={e => setPendingSettings({...pendingSettings, wheelCost: parseInt(e.target.value)})} /></div>
                        <div><label className="settings-label">æ‰“å¡çå‹µ</label><input type="number" className="settings-input" value={pendingSettings?.checkInPoints} onChange={e => setPendingSettings({...pendingSettings, checkInPoints: parseInt(e.target.value)})} /></div>
                        <div><label className="settings-label">é‡‘åº«æ—¥åˆ©ç‡</label><input type="number" step="0.01" className="settings-input" value={pendingSettings?.bankRate} onChange={e => setPendingSettings({...pendingSettings, bankRate: parseFloat(e.target.value)})} /></div>
                        <div><label className="settings-label">é‡‘åº«é–‰é–(æ™‚)</label><input type="number" className="settings-input" value={pendingSettings?.bankLockHours} onChange={e => setPendingSettings({...pendingSettings, bankLockHours: parseInt(e.target.value)})} /></div>
                        
                        <div className="col-span-2 border-t border-slate-100 my-2"></div>
                        
                        <div><label className="settings-label">çŒœæ‹³å€ç‡ (é è¨­2.0)</label><input type="number" step="0.1" className="settings-input" value={pendingSettings?.rpsWinMultiplier} onChange={e => setPendingSettings({...pendingSettings, rpsWinMultiplier: parseFloat(e.target.value)})} /></div>
                        <div><label className="settings-label text-rose-500">çŒœæ‹³å‹ç‡ (0.1~0.9)</label><input type="number" step="0.01" className="settings-input border-rose-200" value={pendingSettings?.rpsWinRate} onChange={e => setPendingSettings({...pendingSettings, rpsWinRate: parseFloat(e.target.value)})} /></div>
                        
                        <div><label className="settings-label">éª°å­å€ç‡ (é è¨­2.0)</label><input type="number" step="0.1" className="settings-input" value={pendingSettings?.diceWinMultiplier} onChange={e => setPendingSettings({...pendingSettings, diceWinMultiplier: parseFloat(e.target.value)})} /></div>
                        <div><label className="settings-label text-rose-500">éª°å­å‹ç‡ (0.1~0.9)</label><input type="number" step="0.01" className="settings-input border-rose-200" value={pendingSettings?.diceWinRate} onChange={e => setPendingSettings({...pendingSettings, diceWinRate: parseFloat(e.target.value)})} /></div>
                      </div>
                      
                      <div className="border-t border-slate-100 pt-6">
                         <p className="settings-label">è½‰ç›¤çé …è¨­å®š (æ•¸å€¼è¶Šå¤§æ©Ÿç‡è¶Šé«˜)</p>
                         {/* é€™è£¡å¢åŠ äº†æ˜ç¢ºçš„æ¨™é¡Œ */}
                         <div className="flex px-1 mb-1 text-[9px] text-slate-400 font-bold uppercase"><span className="w-1/2">çé …åç¨±</span><span className="w-1/4 pl-1">æ•¸å€¼</span><span className="w-1/4 pl-1">æ¬Šé‡</span></div>
                         <div className="grid grid-cols-2 gap-2 mb-4">
                            {pendingSettings?.wheelSegments?.map((s, i) => (
                             <div key={i} className="flex gap-1">
                                <input className="settings-input w-1/2" value={s.label} onChange={e => updateWheelSegment(i, 'label', e.target.value)} />
                                <input type="number" className="settings-input w-1/4" value={s.value} onChange={e => updateWheelSegment(i, 'value', parseInt(e.target.value))} />
                                <input type="number" className="settings-input w-1/4 border-amber-200" value={s.weight || 1} onChange={e => updateWheelSegment(i, 'weight', parseInt(e.target.value) || 1)} placeholder="æ¬Šé‡" />
                             </div>
                            ))}
                         </div>
                      </div>
                      <button onClick={handleSaveGameSettings} className="w-full py-4 btn-primary rounded-xl font-bold text-xs uppercase tracking-widest shadow-xl">å„²å­˜å…¨ç³»çµ±è¨­å®š</button>
                  </div>
                  
                  <div className="luxury-card p-7 rounded-[35px] space-y-6 admin-scratch-form">
                      <h3 className="font-bold flex items-center gap-3 text-deep-blue text-xs tracking-widest uppercase">æ ¼å­æ¨‚æ´»å‹•ç®¡ç†</h3>
                      <div className="space-y-4">
                        <input className="settings-input" placeholder="æ´»å‹•æ¨™é¡Œ" value={adminScratchTitle} onChange={e => setAdminScratchTitle(e.target.value)} />
                        <div className="grid grid-cols-2 gap-2">
                           <input className="settings-input" placeholder="å¤§ç" value={adminScratchPrize} onChange={e => setAdminScratchPrize(e.target.value)} />
                           <input type="number" className="settings-input" placeholder="èŠ±è²»" value={adminScratchCost} onChange={e => setAdminScratchCost(e.target.value)} />
                        </div>
                        {!editingScratchId && (
                           <div className="grid grid-cols-2 gap-2">
                              <input type="number" className="settings-input" placeholder="ä¸­çè™Ÿ(1-16)" value={adminScratchTarget} onChange={e => setAdminScratchTarget(e.target.value)} />
                              <input type="number" className="settings-input" placeholder="ä¸­çä½ç½®(0-15)" value={adminScratchWinnerIndex} onChange={e => setAdminScratchWinnerIndex(e.target.value)} />
                           </div>
                        )}
                        <input type="file" className="text-xs" onChange={e => setAdminScratchImage(e.target.files[0])} />
                        <div className="flex gap-2">
                           {editingScratchId && <button onClick={() => setEditingScratchId(null)} className="flex-1 bg-slate-100 py-3 rounded-xl text-xs font-bold text-slate-500">å–æ¶ˆ</button>}
                           <button onClick={handleAddScratchActivity} disabled={isAddingReward} className="flex-[2] btn-primary py-3 rounded-xl text-xs font-bold uppercase">{editingScratchId ? 'æ›´æ–°' : 'ç™¼å¸ƒ'}</button>
                        </div>
                        <div className="mt-4 pt-4 border-t border-slate-100 space-y-2">
                           {scratchActivities.map(g => (
                              <div key={g.id} className="flex items-center justify-between bg-slate-50 p-2 rounded-lg">
                                 <span className="text-xs font-bold text-slate-600">{g.title}</span>
                                 <div className="flex gap-2">
                                    <button onClick={() => handleEditScratch(g)} className="text-blue-500 font-bold text-[10px]">ç·¨è¼¯</button>
                                    <button onClick={() => setAdminMonitoringGame(g)} className="text-emerald-500 font-bold text-[10px]">ç›£æ§</button>
                                    <button onClick={() => deleteItem('scratch_activities', g.id, g.title)} className="text-red-400 p-1"><Icon name="Trash2" size={12}/></button>
                                 </div>
                              </div>
                           ))}
                        </div>
                      </div>
                  </div>
                  
                  {/* Scratch Monitoring */}
                  {adminMonitoringGame && (
                      <div className="luxury-card p-6 rounded-[30px] animate-in">
                        <div className="flex justify-between items-center mb-4"><h3 className="font-bold text-sm">ç›£æ§: {adminMonitoringGame.title}</h3><button onClick={() => setAdminMonitoringGame(null)} className="text-xs font-bold text-slate-400">é—œé–‰</button></div>
                        <div className="grid grid-cols-4 gap-2">
                           {adminMonitoringGame.grid.map((val, i) => {
                             const isRev = getRevealedCellsForGame(adminMonitoringGame.id).has(i);
                             return <div key={i} className={`aspect-square flex items-center justify-center border rounded-lg font-bold ${isRev ? 'bg-slate-100 text-slate-800' : 'text-slate-300'}`}>{isRev ? val : '?'}</div>
                           })}
                        </div>
                        <p className="text-center text-xs mt-4 text-slate-400">å·²åˆ®é–‹ {getRevealedCellsForGame(adminMonitoringGame.id).size} æ ¼</p>
                      </div>
                  )}

                  <div className="luxury-card p-6 rounded-[30px] space-y-6">
                      <h3 className="font-bold flex items-center gap-3 text-deep-blue text-xs tracking-widest uppercase">å•†å“ä¸Šæ¶</h3>
                      <div className="space-y-4">
                        <input className="settings-input" placeholder="åç¨±" value={adminRewardName} onChange={e => setAdminRewardName(e.target.value)} />
                        <input type="number" className="settings-input" placeholder="é»æ•¸" value={adminRewardCost} onChange={e => setAdminRewardCost(e.target.value)} />
                        <input type="file" accept="image/*" className="text-[10px] block w-full text-slate-400" onChange={e => setAdminRewardImage(e.target.files[0])} />
                        <button onClick={handleUploadTaskByAdmin} disabled={isAddingReward} className="w-full py-4 bg-sky-500 text-white rounded-xl font-bold text-xs uppercase shadow-md">ç¢ºèªä¸Šæ¶å•†å“</button>
                      </div>
                  </div>
                  
                  {/* ç³»çµ±ç‰ˆæœ¬è³‡è¨Š (æ”¾åœ¨å¾Œå°æœ€åº•éƒ¨) */}
                  <div className="text-center text-[9px] text-slate-300 mt-8 mb-4">
                      <p>ç³»çµ± ID: {appId}</p>
                      <p>ç‰ˆæœ¬: 1.3 (å¼·åˆ¶åŒæ­¥ç‰ˆ)</p>
                  </div>
               </div>
            )}
          </div>

          <div className="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-xl border-t border-slate-100 px-8 py-5 flex justify-between items-center text-[9px] font-bold text-slate-300 max-w-md mx-auto z-50 sm:rounded-b-[40px] shadow-[0_-10px_30px_rgba(0,0,0,0.05)]">
            <button onClick={() => setActiveTab('home')} className={`flex flex-col items-center gap-1.5 transition-all ${activeTab === 'home' ? 'text-slate-800 scale-110' : 'hover:text-slate-500'}`}><Icon name="Camera" size={24} className={activeTab === 'home' ? 'text-slate-800' : ''}/><span>é¦–é </span></button>
            <button onClick={() => setActiveTab('activities')} className={`flex flex-col items-center gap-1.5 transition-all ${activeTab === 'activities' ? 'text-slate-800 scale-110' : 'hover:text-slate-500'}`}><Icon name="Dice" size={24} className={activeTab === 'activities' ? 'text-slate-800' : ''}/><span>æ´»å‹•</span></button>
            <button onClick={() => setActiveTab('rewards')} className={`flex flex-col items-center gap-1.5 transition-all ${activeTab === 'rewards' ? 'text-slate-800 scale-110' : 'hover:text-slate-500'}`}><Icon name="Gift" size={24} className={activeTab === 'rewards' ? 'text-slate-800' : ''}/><span>å•†åº—</span></button>
            <button onClick={() => setActiveTab('notifs')} className={`flex flex-col items-center gap-1.5 transition-all ${activeTab === 'notifs' ? 'text-slate-800 scale-110' : 'hover:text-slate-500'}`}><div className="relative"><Icon name="Bell" size={24} className={activeTab === 'notifs' ? 'text-slate-800' : ''}/>{unreadCount > 0 && <span className="absolute -top-0.5 -right-0.5 bg-amber-500 w-2.5 h-2.5 rounded-full border-2 border-white"></span>}</div><span>é€šçŸ¥</span></button>
            {isAdmin && <button onClick={() => setActiveTab('admin')} className={`flex flex-col items-center gap-1.5 transition-all ${activeTab === 'admin' ? 'text-slate-800 scale-110' : 'hover:text-slate-500'}`}><Icon name="Lock" size={24} className={activeTab === 'admin' ? 'text-slate-800' : ''}/><span>å¾Œå°</span></button>}
          </div>
        </div>
      );
    }

    // å°‡ InitWrapper ç§»åˆ° App å®šç¾©ä¹‹å¾Œï¼Œæ¸²æŸ“ä¹‹å‰
    function InitWrapper() {
      const [fbReady, setFbReady] = useState(false);
      useEffect(() => {
        const check = setInterval(() => { if(window.fb && window.fb.isReady) { setFbReady(true); clearInterval(check); } }, 100);
        return () => clearInterval(check);
      }, []);
      if(!fbReady) return null;
      return <App />;
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<InitWrapper />);
  </script>
</body>
</html>
