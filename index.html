<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Point Premium | æ‡‰æœ‰ç›¡æœ‰å¤§è¶…å•†</title>
  
  <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@300;400;700&display=swap" rel="stylesheet">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <style>
    /* å…¨åŸŸå­—é«”èª¿ç´°ç‚º 300 Lightï¼Œå±•ç¾æ¥µè‡´ç²¾ç·»æ„Ÿ */
    * { 
      font-family: 'M PLUS Rounded 1c', sans-serif !important; 
      font-weight: 300; 
    }
    
    body { 
      background-color: #f8fafc; 
      color: #0f172a; 
      -webkit-tap-highlight-color: transparent; 
      overflow-x: hidden;
      overscroll-behavior-y: none;
    }
    
    .no-scrollbar::-webkit-scrollbar { display: none; }
    #root { opacity: 0; transition: opacity 0.8s ease-out; }
    #root.loaded { opacity: 1; }
    
    @keyframes floating { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
    .animate-float { animation: floating 4s ease-in-out infinite; }
    
    img { display: block; max-width: 100%; height: auto; border-radius: 12px; }
    
    /* é«˜ç´šåˆå¤œè—èˆ‡é‡‘è‰²èª¿ */
    .luxury-bg { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); }
    .gold-accent { color: #d4af37; }
    .gold-bg { background: linear-gradient(135deg, #d4af37 0%, #fcd34d 100%); }
    .gold-border { border-color: #d4af37; }
    
    .glass-card { 
      background: rgba(255, 255, 255, 0.95); 
      backdrop-filter: blur(12px); 
      border: 1px solid rgba(226, 232, 240, 0.6); 
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.03);
    }
    
    .point-card { 
      background: rgba(255, 255, 255, 0.08); 
      backdrop-filter: blur(20px); 
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }
    
    .btn-luxury {
      background: #0f172a;
      color: #f1f5f9;
      font-weight: 300;
      border-radius: 12px;
      transition: all 0.3s;
      letter-spacing: 0.05em;
    }
    .btn-luxury:active { transform: scale(0.96); opacity: 0.8; }
    
    /* è½‰ç›¤å¤–è§€ */
    .wheel-segment {
        position: absolute; width: 50%; height: 50%;
        top: 0; right: 0; transform-origin: 0% 100%;
        display: flex; align-items: center; justify-content: center;
    }
    .wheel-text {
        position: absolute; left: -100%; width: 200%;
        text-align: center; transform: rotate(30deg) translate(0, -75px);
        font-size: 10px; font-weight: 700;
    }

    .marquee { white-space: nowrap; overflow: hidden; box-sizing: border-box; }
    .marquee span { display: inline-block; padding-left: 100%; animation: marquee 25s linear infinite; }
    @keyframes marquee { 0% { transform: translate(0, 0); } 100% { transform: translate(-100%, 0); } }

    #loading-screen {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: #f8fafc; display: flex; flex-direction: column;
      align-items: center; justify-content: center; z-index: 100;
      transition: opacity 0.5s ease;
    }
    .loading-icon { font-size: 48px; margin-bottom: 16px; }
    .retry-btn { margin-top: 20px; padding: 10px 24px; background: white; border: 1px solid #cbd5e1; border-radius: 10px; color: #0f172a; font-size: 14px; display: none; }
    
    .delete-badge {
        position: absolute; top: -8px; right: -8px; 
        background: #ef4444; color: white; width: 22px; height: 22px; 
        border-radius: 50%; display: flex; align-items: center; justify-content: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.15); cursor: pointer; z-index: 20;
    }
    
    .settings-input {
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 8px 12px;
        font-size: 13px;
        width: 100%;
        outline: none;
        transition: all 0.2s;
        color: #334155;
    }
    .settings-label {
        font-size: 10px;
        font-weight: 600;
        color: #94a3b8;
        margin-bottom: 4px;
        display: block;
        text-transform: uppercase;
    }
  </style>
</head>
<body>

  <div id="root"></div>

  <!-- è¼‰å…¥ç•«é¢ -->
  <div id="loading-screen">
    <div class="animate-float loading-icon">ğŸ›’</div>
    <div style="color:#0f172a; font-weight:300; letter-spacing: 0.2em; font-size: 14px; margin-bottom: 8px;">å³å°‡é€²å…¥æ‡‰æœ‰ç›¡æœ‰å¤§è¶…å•†</div>
    <div id="loading-status" style="font-size:10px; color:#94a3b8;">æ­£åœ¨é©—è­‰èº«åˆ†...</div>
    <button class="retry-btn" id="retry-btn" onclick="window.location.reload()">é‡æ–°è¼‰å…¥</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, setPersistence, browserLocalPersistence, inMemoryPersistence } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, updateDoc, collection, onSnapshot, addDoc, increment, serverTimestamp, deleteDoc, arrayUnion, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const statusEl = document.getElementById('loading-status');
    const retryBtn = document.getElementById('retry-btn');

    try {
      const fallbackConfig = {
        apiKey: "AIzaSyBAizT0ijN3-uxegV4w2HX6VFvXvYndc3c",
        authDomain: "change-389a0.firebaseapp.com",
        projectId: "change-389a0",
        storageBucket: "change-389a0.firebasestorage.app",
        messagingSenderId: "360528719647",
        appId: "1:360528719647:web:474055ac8fb26e370c0a2a"
      };

      let firebaseConfig = fallbackConfig;
      if (typeof __firebase_config !== 'undefined' && __firebase_config) {
        try { firebaseConfig = JSON.parse(__firebase_config); } catch (e) {}
      }

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      window.fb = { db, auth, doc, setDoc, updateDoc, collection, onSnapshot, addDoc, increment, serverTimestamp, deleteDoc, arrayUnion, getDoc, appId: typeof __app_id !== 'undefined' ? __app_id : "love-sync-v1", isReady: true };
      
      (async () => {
        try {
          await setPersistence(auth, inMemoryPersistence); 
          if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
             await signInWithCustomToken(auth, __initial_auth_token);
          } else {
             await signInAnonymously(auth);
          }
        } catch (e) {
          if(retryBtn) retryBtn.style.display = 'block';
        }
      })();
    } catch (err) {
      if(retryBtn) retryBtn.style.display = 'block';
    }
    setTimeout(() => { if(retryBtn) retryBtn.style.display = 'block'; }, 10000);
  </script>

  <script type="text/babel">
    const { useState, useEffect, useRef, useMemo, Fragment } = React;

    const Icon = ({ name, size = 20, className = "" }) => {
      const icons = {
        Point: <path d="M6 2L3 6V20A2 2 0 0 0 5 22H19A2 2 0 0 0 21 20V6L18 2H6ZM3 6H21M16 10A4 4 0 0 1 8 10" />,
        Camera: (<Fragment><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></Fragment>),
        Gift: (<Fragment><rect x="3" y="8" width="18" height="4" rx="1"/><path d="M12 8v13M19 12v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-7M7.5 8a2.5 2.5 0 0 1 0-5A4.8 8 0 0 1 12 8a4.8 8 0 0 1 4.5-5 2.5 2.5 0 0 1 0 5"/></Fragment>),
        Bell: (<Fragment><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></Fragment>),
        Lock: (<Fragment><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></Fragment>),
        LogOut: (<Fragment><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></Fragment>),
        Trash2: (<Fragment><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></Fragment>),
        Ticket: (<Fragment><path d="M2 9V5a2 2 0 0 1 2-2h16a2 2 0 0 1 2-2v4a2 2 0 0 0 0 4v4a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2v-4a2 2 0 0 0 0-4Z"/><path d="M13 3v18M9 3v18M15 3v18"/></Fragment>),
        Store: (<Fragment><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><path d="M9 22V12h6v10"/></Fragment>),
        History: (<Fragment><path d="M12 8v4l3 3"/><circle cx="12" cy="12" r="10"/></Fragment>),
        Plus: (<Fragment><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></Fragment>),
        Dice: (<Fragment><rect x="2" y="2" width="20" height="20" rx="5" ry="5"/><circle cx="8.5" cy="8.5" r="1.5"/><circle cx="15.5" cy="15.5" r="1.5"/><circle cx="8.5" cy="15.5" r="1.5"/><circle cx="15.5" cy="8.5" r="1.5"/></Fragment>),
        Hand: (<Fragment><path d="M18 11V6a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v0"/><path d="M14 10V4a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v2"/><path d="M10 10.5V6a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v8"/><path d="M18 8a2 2 0 1 1 4 0v6a8 8 0 0 1-8 8h-2c-2.8 0-4.5-.86-5.99-2.34l-3.6-3.6a2 2 0 0 1 2.83-2.82L7 15"/></Fragment>),
        Save: (<Fragment><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></Fragment>),
        Target: (<Fragment><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></Fragment>),
        Disc: (<Fragment><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/><path d="M12 2a10 10 0 0 0 0 20"/><path d="M12 12 2.3 10.5"/><path d="M12 12l9.7-1.5"/></Fragment>),
        PiggyBank: (<Fragment><path d="M19 5c-1.5 0-2.8 0.6-3.8 1.5l-2.5 2.5c-3 3-5 3-5 3s-0.5-2.3 3-5l2.5-2.5c1-1 2.5-1.5 4-1.5 2.5 0 4.8 1.5 5.8 3.5H19z"/><path d="M19 5h-1"/><path d="M22 9c0 5-4 9-9 9s-9-4-9-9c0-3.3 2-6.2 4.9-7.9l0.9 0.9C7.5 3.1 6 5.4 6 8c0 3.3 2.7 6 6 6s6-2.7 6-6c0-2-0.8-3.8-2.2-5l0.7-0.7c3.1 1.7 5.5 5 5.5 6.7z"/></Fragment>),
        Sparkles: (<Fragment><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1-1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4M9 3v4M3 5h4M3 9h4"/></Fragment>),
        Edit: (<Fragment><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></Fragment>),
        Chart: (<Fragment><path d="M12 20V10M18 20V4M6 20v-4"/></Fragment>),
        Check: <polyline points="20 6 9 17 4 12"/>,
        Image: (<Fragment><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></Fragment>),
      };
      return (
        <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={1.2} strokeLinecap="round" strokeLinejoin="round" className={className}>
          {icons[name] || null}
        </svg>
      );
    };

    function App() {
      const { db, auth, doc, setDoc, updateDoc, collection, onSnapshot, addDoc, increment, serverTimestamp, deleteDoc, arrayUnion, appId, onAuthStateChanged } = window.fb;
      const [user, setUser] = useState(null);
      const [activeTab, setActiveTab] = useState('home');
      const [currentActivity, setCurrentActivity] = useState(null); 
      const [isAdmin, setIsAdmin] = useState(false);
      const [points, setPoints] = useState(0);
      const [stats, setStats] = useState({ totalIssued: 0, totalRedeemed: 0 });
      const [submissions, setSubmissions] = useState([]);
      const [rewards, setRewards] = useState([]);
      const [notifications, setNotifications] = useState([]);
      const [loading, setLoading] = useState(true);

      const defaultWheelSegments = [
        { label: "10 é»", value: 10, type: "point", color: "#fef3c7" },
        { label: "å†æ¥å†å²", value: 0, type: "text", color: "#e2e8f0" },
        { label: "5 é»", value: 5, type: "point", color: "#dbeafe" },
        { label: "50 é»", value: 50, type: "point", color: "#fcd34d" },
        { label: "éŠ˜è¬æƒ é¡§", value: 0, type: "text", color: "#cbd5e1" },
        { label: "20 é»", value: 20, type: "point", color: "#93c5fd" }
      ];

      const [gameSettings, setGameSettings] = useState({ wheelCost: 20, wheelSegments: defaultWheelSegments, rpsCost: 10, rpsWinMultiplier: 2, bankRate: 0.05, bankLockHours: 24, checkInPoints: 2, missions: [] });
      const [pendingSettings, setPendingSettings] = useState(null);

      const [savings, setSavings] = useState({ balance: 0, lastInterestTime: null, lastDepositTime: null });
      const [wheelSpinning, setWheelSpinning] = useState(false);
      const [wheelRotation, setWheelRotation] = useState(0);
      const [rpsState, setRpsState] = useState('idle');
      const [rpsUserChoice, setRpsUserChoice] = useState(null);
      const [rpsCpuChoice, setRpsCpuChoice] = useState(null);

      const [desc, setDesc] = useState('');
      const [selectedFile, setSelectedFile] = useState(null);
      const [isUploading, setIsUploading] = useState(false);
      const [adminPass, setAdminPass] = useState('');
      const [showAdminLogin, setShowAdminLogin] = useState(false);
      const [approvalPoints, setApprovalPoints] = useState({});
      const [rejectionReasons, setRejectionReasons] = useState({});
      const [wishName, setWishName] = useState('');
      const [checkInImage, setCheckInImage] = useState(null);
      const [isCheckingIn, setIsCheckingIn] = useState(false);

      const [newMissionTitle, setNewMissionTitle] = useState('');
      const [newMissionTarget, setNewMissionTarget] = useState('');
      const [newMissionReward, setNewMissionReward] = useState('');
      const [newMissionType, setNewMissionType] = useState('streak');

      const getPublicRef = (name) => collection(db, 'artifacts', appId, 'public', 'data', name);

      // --- Firebase ç›£è½ ---
      useEffect(() => {
        if (!user) return;
        const unsubStats = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'stats', 'total'), (d) => { if (d.exists()) { setPoints(d.data().totalPoints || 0); setStats({ totalIssued: d.data().totalIssued || 0, totalRedeemed: d.data().totalRedeemed || 0 }); } });
        const unsubSubs = onSnapshot(getPublicRef('submissions'), (s) => setSubmissions(s.docs.map(d => ({id: d.id, ...d.data()}))));
        const unsubRewards = onSnapshot(getPublicRef('rewards'), (s) => setRewards(s.docs.map(d => ({id: d.id, ...d.data()}))));
        const unsubSettings = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'games'), (d) => { if(d.exists()) { setGameSettings(d.data()); setPendingSettings(d.data()); } else { setPendingSettings(gameSettings); } });
        const unsubSavings = onSnapshot(doc(db, 'artifacts', appId, 'users', user.uid, 'savings', 'account'), (d) => { if(d.exists()) setSavings(d.data()); else setSavings({ balance: 0, lastInterestTime: null, lastDepositTime: null }); });
        
        return () => { unsubStats(); unsubSubs(); unsubRewards(); unsubSettings(); unsubSavings(); };
      }, [user]);

      // --- åŠŸèƒ½è™•ç† ---
      const handleSaveGameSettings = async () => { try { await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'games'), pendingSettings, { merge: true }); alert("è¨­å®šå·²æ›´æ–°"); } catch(e) { alert("æ›´æ–°å¤±æ•—"); } };
      const handleApprove = async (sub, pts) => { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'submissions', sub.id), { status: 'approved', awardedPoints: parseInt(pts) }); await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'stats', 'total'), { totalPoints: increment(pts), totalIssued: increment(pts) }); alert("å·²æ‰¹å‡†"); };
      const checkAdmin = () => { if (adminPass === 'love1314') { setIsAdmin(true); setShowAdminLogin(false); setActiveTab('admin'); setPendingSettings({...gameSettings}); alert('ç®¡ç†å“¡ æ‚¨å¥½'); } else alert('å¯†ç¢¼éŒ¯èª¤'); };

      const handleCheckIn = async () => {
        if (isCheckingIn || !checkInImage) return;
        setIsCheckingIn(true);
        try {
          const img = await compressImage(checkInImage);
          const pts = gameSettings.checkInPoints || 2;
          await addDoc(getPublicRef('submissions'), { description: "ğŸ’… æŒ‡ç”²æ‰“å¡ç´€éŒ„", image: img, status: 'checkin', awardedPoints: pts, timestamp: serverTimestamp(), userId: user.uid });
          await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'stats', 'total'), { totalPoints: increment(pts), totalIssued: increment(pts) });
          setCheckInImage(null); alert("æ‰“å¡æˆåŠŸ");
        } catch(e) { alert("å¤±æ•—"); } finally { setIsCheckingIn(false); }
      };

      const handleSpinWheel = async () => {
        const cost = gameSettings.wheelCost || 20;
        if(points < cost || wheelSpinning) return;
        setWheelSpinning(true);
        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'stats', 'total'), { totalPoints: increment(-cost), totalRedeemed: increment(cost) });
        const randomDeg = Math.floor(Math.random() * 360) + 1800;
        setWheelRotation(randomDeg);
        setTimeout(async () => {
           setWheelSpinning(false);
           const effectiveAngle = (360 - (randomDeg % 360)) % 360;
           const segmentIndex = Math.floor(effectiveAngle / 60);
           const win = gameSettings.wheelSegments[segmentIndex] || {label: "éŠ˜è¬", value: 0};
           alert(`è½‰ç›¤çµæœï¼š${win.label}`);
           if(win.value > 0) {
              await addDoc(getPublicRef('submissions'), { description: `ğŸ¡ è½‰ç›¤çå‹µï¼š${win.label}`, status: 'bonus', awardedPoints: win.value, timestamp: serverTimestamp(), userId: user.uid });
              await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'stats', 'total'), { totalPoints: increment(win.value), totalIssued: increment(win.value) });
           }
        }, 3000);
      };

      const handlePlayRPS = async (choice) => {
          const cost = gameSettings.rpsCost || 10;
          if(points < cost || rpsState === 'playing') return;
          setRpsState('playing'); setRpsUserChoice(choice);
          await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'stats', 'total'), { totalPoints: increment(-cost), totalRedeemed: increment(cost) });
          setTimeout(async () => {
              const cpu = ['rock', 'paper', 'scissors'][Math.floor(Math.random() * 3)];
              setRpsCpuChoice(cpu);
              let res = 'draw';
              if((choice === 'rock' && cpu === 'scissors') || (choice === 'paper' && cpu === 'rock') || (choice === 'scissors' && cpu === 'paper')) res = 'win';
              else if (choice !== cpu) res = 'lose';
              if(res === 'win') {
                  const winPts = cost * gameSettings.rpsWinMultiplier;
                  await addDoc(getPublicRef('submissions'), { description: "âœŠ çŒœæ‹³ç²å‹çå‹µ", status: 'bonus', awardedPoints: winPts, timestamp: serverTimestamp(), userId: user.uid });
                  await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'stats', 'total'), { totalPoints: increment(winPts), totalIssued: increment(winPts) });
                  alert(`ç²å‹ï¼è´å¾— ${winPts} é»`);
              } else if (res === 'draw') {
                  await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'stats', 'total'), { totalPoints: increment(cost), totalIssued: increment(cost) });
                  alert("å¹³æ‰‹ï¼é€€è²»");
              } else alert("è¼¸äº†...ä¸‹æ¬¡å†ä¾†");
              setRpsState('idle');
          }, 1500);
      };

      const handleDeposit = async () => {
        const amt = parseInt(prompt("å­˜å…¥é‡‘é¡:"));
        if(!amt || points < amt) return;
        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'stats', 'total'), { totalPoints: increment(-amt), totalRedeemed: increment(amt) });
        await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'savings', 'account'), { balance: (savings.balance || 0) + amt, lastDepositTime: serverTimestamp() }, { merge: true });
        alert("å­˜å…¥æˆåŠŸ");
      };

      const handleCollectInterest = async () => {
        const lastTime = savings.lastInterestTime ? savings.lastInterestTime.seconds * 1000 : 0;
        if(Date.now() - lastTime < 86400000) return alert("æ¯æ—¥åªèƒ½é ˜å–ä¸€æ¬¡åˆ©æ¯");
        const interest = Math.floor((savings.balance || 0) * (gameSettings.bankRate || 0.05));
        if(interest <= 0) return alert("æœ¬é‡‘éä½ç„¡åˆ©æ¯");
        await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'savings', 'account'), { balance: (savings.balance || 0) + interest, lastInterestTime: serverTimestamp() }, { merge: true });
        alert(`é ˜å–åˆ©æ¯ï¼š${interest} é»`);
      };

      const handleRedeem = async (r) => { if(points < r.cost) return alert("é»æ•¸ä¸è¶³"); if(confirm(`å…Œæ› ${r.name}?`)) { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'stats', 'total'), { totalPoints: increment(-r.cost), totalRedeemed: increment(r.cost) }); await addDoc(getPublicRef('submissions'), { description: `ğŸ å·²å…Œæ›ï¼š${r.name}`, image: r.image, status: 'redeemed', awardedPoints: -r.cost, timestamp: serverTimestamp(), userId: user.uid }); alert("å…Œæ›æˆåŠŸ"); } };

      const myCheckinPhotos = useMemo(() => submissions.filter(s => s.status === 'checkin' && s.userId === user?.uid && s.image).sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0)), [submissions, user]);
      const allCheckinPhotos = useMemo(() => submissions.filter(s => s.status === 'checkin' && s.image).sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0)), [submissions]);
      const myWishes = useMemo(() => rewards.filter(r => !r.available && (r.userId === user?.uid || !r.userId)), [rewards, user]);
      const missionProg = useMemo(() => {
          const mySubs = submissions.filter(s => s.userId === user?.uid);
          const totalEarned = mySubs.reduce((acc, curr) => acc + (curr.awardedPoints > 0 ? curr.awardedPoints : 0), 0);
          const checkins = [...new Set(mySubs.filter(s => s.status === 'checkin').map(s => new Date(s.timestamp?.seconds*1000).toDateString()))];
          return { streak: checkins.length, total: totalEarned };
      }, [submissions, user]);

      const updateWheelSegment = (idx, field, val) => { const ms = [...pendingSettings.wheelSegments]; ms[idx] = {...ms[idx], [field]: val}; setPendingSettings({...pendingSettings, wheelSegments: ms}); };
      const addMission = () => { if(!newMissionTitle || !newMissionTarget) return; const newM = { id: 'm'+Date.now(), title: newMissionTitle, target: parseInt(newMissionTarget), reward: parseInt(newMissionReward), type: newMissionType }; setPendingSettings({...pendingSettings, missions: [...(pendingSettings.missions||[]), newM]}); setNewMissionTitle(''); setNewMissionTarget(''); };
      const removeMission = (i) => { const ms = [...pendingSettings.missions]; ms.splice(i, 1); setPendingSettings({...pendingSettings, missions: ms}); };

      return (
        <div className="max-w-md mx-auto shadow-2xl relative min-h-screen pb-24 sm:rounded-[40px] sm:my-4 sm:border-4 sm:border-slate-200 bg-[#f1f5f9] overflow-hidden flex flex-col no-scrollbar">
          
          <div className="luxury-gradient p-6 pb-8 text-white rounded-b-[40px] shadow-lg shrink-0 z-10 relative">
            <div className="flex justify-between items-center mb-6">
              <div className="flex items-center gap-3 pl-2"><div className="w-1.5 h-6 luxury-gold-gradient rounded-full"></div><h1 className="text-lg font-bold tracking-widest uppercase font-serif gold-accent">Point Premium</h1></div>
              <div className="flex items-center gap-3">
                <button onClick={() => setActiveTab('notifs')} className="relative p-2.5 bg-white/5 rounded-xl border border-white/10"><Icon name="Bell" size={18} className="text-slate-300"/>{unreadCount > 0 && <span className="absolute top-1.5 right-1.5 bg-amber-500 w-2 h-2 rounded-full"></span>}</button>
                <button onClick={() => isAdmin ? setIsAdmin(false) : setShowAdminLogin(!showAdminLogin)} className="p-2.5 bg-white/5 rounded-xl border border-white/10"><Icon name={isAdmin ? "LogOut" : "Lock"} size={18} className="text-slate-300"/></button>
              </div>
            </div>
            <div className="flex justify-center mb-4"><div className="point-card px-10 py-4 rounded-2xl flex flex-col items-center min-w-[200px]"><span className="text-[10px] text-slate-400 uppercase tracking-widest">ç›®å‰é»æ•¸</span><span className="text-5xl font-bold text-white tracking-tight">{points}</span></div></div>
            <div className="bg-white/5 border border-white/5 rounded-xl px-4 py-2 marquee mx-2 backdrop-blur-sm"><span className="text-[11px] font-light text-slate-300">{announcement}</span></div>
            {showAdminLogin && !isAdmin && <div className="absolute top-24 right-6 bg-white p-6 rounded-2xl shadow-2xl z-50 w-64 text-slate-800 border border-slate-100 animate-in"><input type="password" placeholder="Passcode" className="w-full bg-slate-50 border p-3 rounded-xl mb-3 text-center tracking-widest outline-none text-sm" value={adminPass} onChange={e => setAdminPass(e.target.value)} autoFocus /><button onClick={checkAdmin} className="w-full btn-luxury py-3 rounded-xl font-bold text-xs uppercase">Verify</button></div>}
          </div>

          <div className="p-6 flex-1 overflow-y-auto no-scrollbar space-y-8">
            
            {activeTab === 'home' && (
              <div className="space-y-8 animate-in">
                <div className="luxury-card p-6 rounded-[30px] space-y-4">
                  <h3 className="font-bold text-slate-800 flex items-center gap-2"><Icon name="Plus" size={16}/> è³ºå–é»æ•¸å›å ±</h3>
                  <textarea className="w-full bg-slate-50 border border-slate-200 p-4 rounded-2xl text-sm min-h-[100px] outline-none" placeholder="æè¿°æ‚¨çš„åŠªåŠ›..." value={desc} onChange={e => setDesc(e.target.value)} />
                  <div className="flex gap-3">
                    <label className={`flex-[1.5] cursor-pointer py-4 rounded-xl flex items-center justify-center border border-dashed transition-all ${selectedFile ? 'border-amber-400 bg-amber-50 text-amber-600' : 'text-slate-400 border-slate-200'}`}>
                      <Icon name="Image" size={16} className="mr-2"/> <span className="font-bold text-xs">{selectedFile ? 'å·²é¸æ“‡' : 'é™„åœ–'}</span>
                      <input type="file" accept="image/*" className="hidden" onChange={e => setSelectedFile(e.target.files[0])} />
                    </label>
                    <button onClick={handleUploadTask} className="flex-1 btn-luxury py-4 rounded-xl font-bold text-xs">é€å‡º</button>
                  </div>
                </div>

                <div className="luxury-card p-6 rounded-[30px] flex items-center gap-5">
                    <label className={`w-16 h-16 rounded-2xl border-2 border-dashed flex flex-col items-center justify-center shrink-0 ${checkInImage ? 'border-amber-400 bg-amber-50 text-amber-600' : 'border-slate-200'}`}>
                       <Icon name="Camera" size={24}/>
                       <input type="file" accept="image/*" className="hidden" onChange={e => setCheckInImage(e.target.files[0])} />
                    </label>
                    <div className="flex-1"><p className="font-bold text-sm text-slate-800">æ¯æ—¥ç¾ç”²æ‰“å¡</p><p className="text-[10px] text-slate-400 font-medium">ä¸Šå‚³ç¾ç…§é ˜ {gameSettings.checkInPoints} P</p></div>
                    <button onClick={handleCheckIn} className={`px-6 py-2.5 rounded-xl text-xs font-bold ${!checkInImage ? 'bg-slate-50 text-slate-300' : 'btn-luxury'}`}>æ‰“å¡</button>
                </div>

                {myCheckinPhotos.length > 0 && (
                  <div className="space-y-4">
                    <h3 className="text-[11px] font-bold text-slate-400 uppercase tracking-widest px-2 border-l-2 border-slate-800 pl-3 ml-1">æ‰“å¡ç›¸ç°¿</h3>
                    <div className="grid grid-cols-3 gap-3">
                        {myCheckinPhotos.map(c => (
                           <div key={c.id} className="aspect-square rounded-xl overflow-hidden relative shadow-sm border border-white">
                              <img src={c.image} className="w-full h-full object-cover" />
                              <div className="absolute bottom-0 w-full bg-black/40 text-white text-[8px] py-1 text-center font-bold">
                                 {c.timestamp ? new Date(c.timestamp.seconds * 1000).toLocaleDateString(undefined, {month:'numeric', day:'numeric'}) : ''}
                              </div>
                           </div>
                        ))}
                    </div>
                  </div>
                )}

                <div className="space-y-4">
                  <h3 className="text-[10px] font-bold text-slate-400 uppercase tracking-widest px-2">æ­·å²ç´€éŒ„</h3>
                  <div className="luxury-card rounded-[24px] overflow-hidden">
                    {submissions.length === 0 ? <p className="text-center text-xs py-10 text-slate-300">ç›®å‰ç„¡ç´€éŒ„</p> : submissions.filter(s => ['pending', 'approved', 'deducted', 'redeemed', 'checkin', 'bonus', 'rejected'].includes(s.status)).map(item => (
                       <div key={item.id} className="p-4 flex justify-between items-center border-b last:border-0 hover:bg-slate-50/50">
                          <div className="flex flex-col min-w-0 pr-4">
                             <span className="text-[9px] text-slate-400 font-bold uppercase">{item.timestamp ? new Date(item.timestamp.seconds * 1000).toLocaleDateString() : 'å‰›å‰›'}</span>
                             <div className="text-xs font-medium text-slate-700 truncate">{item.description}</div>
                          </div>
                          <div className={`text-xs font-bold ${item.status==='rejected' ? 'text-slate-300' : item.status==='pending' ? 'text-amber-500' : (item.awardedPoints > 0 ? 'text-emerald-600' : 'text-rose-600')}`}>
                             {item.status==='rejected' ? 'ä¸æ ¸å‡†' : item.status==='pending' ? 'å¯©æ ¸ä¸­' : (item.awardedPoints > 0 ? `+${item.awardedPoints}` : item.awardedPoints)}
                          </div>
                       </div>
                    ))}
                  </div>
                </div>
              </div>
            )}

            {activeTab === 'activities' && (
               <div className="space-y-8 animate-in">
                  {!currentActivity ? (
                     <div className="grid grid-cols-2 gap-5">
                        <div onClick={() => setCurrentActivity('wheel')} className="bg-white p-5 rounded-[24px] h-36 flex flex-col justify-between border group transition-all hover:shadow-md"><Icon name="Disc" size={24} className="text-indigo-400 group-hover:rotate-90 transition-transform duration-500"/><div className="text-sm font-bold text-slate-700 uppercase tracking-widest">å¹¸é‹è½‰ç›¤</div></div>
                        <div onClick={() => setCurrentActivity('rps')} className="bg-white p-5 rounded-[24px] h-36 flex flex-col justify-between border group transition-all hover:shadow-md"><Icon name="Hand" size={24} className="text-rose-400 group-hover:scale-110 transition-transform"/><div className="text-sm font-bold text-slate-700 uppercase tracking-widest">çŒœæ‹³å¤§å°æ±º</div></div>
                        <div onClick={() => setCurrentActivity('bank')} className="bg-white p-5 rounded-[24px] h-36 flex flex-col justify-between border group transition-all hover:shadow-md"><Icon name="PiggyBank" size={24} className="text-emerald-400 group-hover:scale-110 transition-transform"/><div className="text-sm font-bold text-slate-700 uppercase tracking-widest">é»æ•¸å°é‡‘åº«</div></div>
                        <div onClick={() => setCurrentActivity('missions')} className="bg-white p-5 rounded-[24px] h-36 flex flex-col justify-between border group transition-all hover:shadow-md"><Icon name="Target" size={24} className="text-amber-400 group-hover:scale-110 transition-transform"/><div className="text-sm font-bold text-slate-700 uppercase tracking-widest">ä»»å‹™ä½ˆå‘Šæ¬„</div></div>
                     </div>
                  ) : currentActivity === 'wheel' ? (
                     <div className="luxury-card p-8 rounded-[40px] flex flex-col items-center animate-in">
                        <button onClick={() => setCurrentActivity(null)} className="self-start mb-6 text-[10px] font-bold text-slate-400 uppercase tracking-widest bg-slate-50 px-3 py-1.5 rounded-full">â† BACK</button>
                        <div className="relative w-64 h-64 mb-12">
                           <div className="w-full h-full rounded-full border-[10px] border-white shadow-2xl overflow-hidden relative transition-transform duration-[3000ms] ease-out" style={{ transform: `rotate(${wheelRotation}deg)`, background: `conic-gradient(${gameSettings.wheelSegments.map((s,i) => `${s.color} ${i*60}deg ${(i+1)*60}deg`).join(',')})` }}>
                              {gameSettings.wheelSegments.map((seg, i) => <div key={i} className="wheel-segment" style={{ transform: `rotate(${i * 60}deg)` }}><span className="wheel-text">{seg.label}</span></div>)}
                           </div>
                           <div className="absolute top-0 left-1/2 -translate-x-1/2 -mt-4 w-0 h-0 border-l-[14px] border-l-transparent border-r-[14px] border-r-transparent border-t-[24px] border-t-slate-800 z-10"></div>
                        </div>
                        <button onClick={handleSpinWheel} disabled={wheelSpinning} className="w-full btn-luxury py-5 shadow-xl text-xs uppercase font-bold tracking-widest">{wheelSpinning ? 'æ—‹è½‰ä¸­...' : `æ—‹è½‰ä¸€æ¬¡ (${gameSettings.wheelCost} P)`}</button>
                     </div>
                  ) : currentActivity === 'rps' ? (
                     <div className="luxury-card p-10 rounded-[40px] text-center animate-in">
                        <button onClick={() => setCurrentActivity(null)} className="self-start mb-6 text-[10px] font-bold text-slate-400 uppercase bg-slate-50 px-3 py-1.5 rounded-full">â† BACK</button>
                        <h2 className="font-bold text-slate-800 text-lg mb-12 tracking-widest">çŒœæ‹³å¤§å°æ±º</h2>
                        <div className="flex justify-around items-center mb-12">
                           <div className={rpsState==='playing'?'animate-bounce-hand':''}>
                              <div className="text-5xl mb-4">{rpsUserChoice==='rock'?'âœŠ':rpsUserChoice==='paper'?'ğŸ–ï¸':rpsUserChoice==='scissors'?'âœŒï¸':'â“'}</div>
                              <p className="text-[10px] text-slate-400 font-bold uppercase">ç©å®¶</p>
                           </div>
                           <div className="text-slate-200 text-xl italic font-serif">vs</div>
                           <div className={rpsState==='playing'?'animate-bounce-hand':''}>
                              <div className="text-5xl mb-4">{rpsCpuChoice==='rock'?'âœŠ':rpsCpuChoice==='paper'?'ğŸ–ï¸':rpsCpuChoice==='scissors'?'âœŒï¸':'â“'}</div>
                              <p className="text-[10px] text-slate-400 font-bold uppercase">åº—é•·</p>
                           </div>
                        </div>
                        <div className="grid grid-cols-3 gap-4">
                           <button onClick={() => handlePlayRPS('rock')} className="bg-white border-slate-100 border p-5 rounded-2xl shadow-sm text-3xl">âœŠ</button>
                           <button onClick={() => handlePlayRPS('paper')} className="bg-white border-slate-100 border p-5 rounded-2xl shadow-sm text-3xl">ğŸ–ï¸</button>
                           <button onClick={() => handlePlayRPS('scissors')} className="bg-white border-slate-100 border p-5 rounded-2xl shadow-sm text-3xl">âœŒï¸</button>
                        </div>
                        <p className="mt-8 text-[10px] text-slate-300 font-bold uppercase">ç²å‹å¯å¾— {gameSettings.rpsWinMultiplier} å€é»æ•¸çå‹µ</p>
                     </div>
                  ) : currentActivity === 'bank' ? (
                     <div className="luxury-card p-8 rounded-[40px] space-y-8 animate-in">
                        <button onClick={() => setCurrentActivity(null)} className="text-[10px] font-bold text-slate-400 uppercase bg-slate-50 px-3 py-1.5 rounded-full">â† BACK</button>
                        <div className="luxury-gold-gradient p-10 rounded-[30px] text-white text-center shadow-xl relative overflow-hidden">
                           <p className="text-[10px] font-bold opacity-70 uppercase mb-3">å°é‡‘åº«é¤˜é¡</p>
                           <p className="text-5xl font-bold">{savings.balance || 0}</p>
                           <p className="mt-5 text-[9px] font-bold bg-black/10 inline-block px-3 py-1 rounded-full">æ—¥åˆ©ç‡: {gameSettings.bankRate * 100}%</p>
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                           <button onClick={handleDeposit} className="bg-slate-50 border py-4 rounded-xl font-bold text-xs uppercase hover:bg-slate-100">å­˜å…¥</button>
                           <button onClick={handleWithdraw} className="bg-slate-50 border py-4 rounded-xl font-bold text-xs uppercase hover:bg-slate-100">æé ˜</button>
                        </div>
                        <button onClick={handleCollectInterest} className="w-full py-5 border-2 border-amber-300 text-amber-600 rounded-2xl font-bold text-xs uppercase hover:bg-amber-50">é ˜å–æ¯æ—¥åˆ©æ¯</button>
                     </div>
                  ) : currentActivity === 'missions' ? (
                     <div className="luxury-card p-8 rounded-[40px] animate-in">
                        <button onClick={() => setCurrentActivity(null)} className="mb-6 text-[10px] font-bold text-slate-400 uppercase bg-slate-50 px-3 py-1.5 rounded-full">â† BACK</button>
                        <h2 className="font-bold text-slate-800 text-lg mb-8 border-l-2 border-slate-800 pl-4">ä»»å‹™é€²åº¦</h2>
                        <div className="space-y-5">
                           {gameSettings.missions && gameSettings.missions.map(m => {
                              let prog = m.type === 'streak' ? missionProg.streak : missionProg.total;
                              let pct = Math.min(prog / m.target * 100, 100);
                              return (
                                 <div key={m.id} className="bg-slate-50 p-5 rounded-[25px] border border-slate-100 space-y-4">
                                    <div className="flex justify-between items-center"><span className="text-xs font-bold text-slate-800">{m.title}</span><span className="text-[10px] font-bold text-amber-600">+{m.reward}P</span></div>
                                    <div className="w-full bg-slate-200 h-1.5 rounded-full overflow-hidden"><div className="luxury-gold-gradient h-full rounded-full transition-all duration-1000" style={{ width: `${pct}%` }}></div></div>
                                    <div className="flex justify-between text-[9px] font-bold text-slate-300 uppercase tracking-widest"><span>é€²åº¦: {prog} / {m.target}</span><span>{pct === 100 ? 'å·²é”æˆ' : 'é€²è¡Œä¸­'}</span></div>
                                 </div>
                              );
                           })}
                        </div>
                     </div>
                  ) : null}
               </div>
            )}

            {activeTab === 'rewards' && (
              <div className="space-y-8 animate-in">
                <div className="luxury-card p-6 rounded-[30px] space-y-4">
                  <h3 className="font-bold text-slate-800">ç²¾å“è¨±é¡˜æ± </h3>
                  <input className="settings-input" placeholder="æƒ³è¦ä»€éº¼çå‹µ..." value={wishName} onChange={e => setWishName(e.target.value)} />
                  <button onClick={handleMakeWish} className="w-full btn-luxury py-4 rounded-xl font-bold text-xs uppercase tracking-widest">é€å‡ºç²¾å“é¡˜æœ›</button>
                </div>
                <div className="grid grid-cols-2 gap-5">
                     {rewards.filter(r => r.available).map(item => (
                        <div key={item.id} className="luxury-card p-4 rounded-[30px] flex flex-col relative group shadow-sm border-slate-100">
                           <div className="aspect-square bg-slate-50 rounded-2xl mb-4 overflow-hidden border border-slate-50"><img src={item.image} className="w-full h-full object-cover" /></div>
                           <h4 className="font-bold text-sm mb-2 truncate px-1 text-slate-700">{item.name}</h4>
                           <button onClick={() => handleRedeem(item)} className="w-full py-3 bg-slate-800 text-white rounded-xl text-[10px] font-bold uppercase tracking-wider">{item.cost} P å…Œæ›</button>
                           {isAdmin && <div onClick={() => deleteItem('rewards', item.id, item.name)} className="delete-badge"><Icon name="Trash2" size={12}/></div>}
                        </div>
                     ))}
                </div>
              </div>
            )}

            {/* Admin Tab */}
            {activeTab === 'admin' && isAdmin && (
               <div className="space-y-8 animate-in pb-12">
                  <div className="luxury-gradient p-6 rounded-[30px] text-white shadow-lg relative overflow-hidden">
                    <h2 className="text-sm font-bold flex gap-2 items-center mb-6"><Icon name="Chart" size={18}/> ç‡Ÿé‹å„€è¡¨æ¿</h2>
                    <div className="grid grid-cols-2 gap-4">
                      <div className="bg-white/10 p-4 rounded-2xl border border-white/10"><p className="text-[9px] font-bold text-slate-300 uppercase tracking-widest mb-1">å·²ç™¼æ”¾</p><p className="text-2xl font-bold">{stats.totalIssued}</p></div>
                      <div className="bg-white/10 p-4 rounded-2xl border border-white/10"><p className="text-[9px] font-bold text-slate-300 uppercase tracking-widest mb-1">å·²å›æ”¶</p><p className="text-2xl font-bold">{stats.totalRedeemed}</p></div>
                    </div>
                  </div>

                  <div className="luxury-card p-7 rounded-[35px] space-y-6">
                     <h3 className="font-bold flex items-center gap-3 text-slate-800 text-xs tracking-widest uppercase">å¾…è™•ç†å¯©æ ¸</h3>
                     <div className="space-y-5">
                        {submissions.filter(s => s.status==='pending').map(sub => (
                           <div key={sub.id} className="bg-slate-50 p-5 rounded-2xl space-y-4 border border-slate-100 shadow-sm">
                              {sub.image && <img src={sub.image} className="w-full h-44 object-cover rounded-xl" />}
                              <p className="text-xs font-medium italic">"{sub.description}"</p>
                              <div className="flex gap-3">
                                 <input type="number" className="bg-white border p-3 rounded-xl text-xs flex-1 font-bold" placeholder="10" value={approvalPoints[sub.id] || ''} onChange={e => setApprovalPoints({...approvalPoints, [sub.id]: e.target.value})} />
                                 <button onClick={() => handleApprove(sub, approvalPoints[sub.id] || 10)} className="btn-luxury px-8 text-xs font-bold uppercase">æ‰¹å‡†</button>
                              </div>
                           </div>
                        ))}
                     </div>
                  </div>

                  <div className="luxury-card p-7 rounded-[35px] space-y-6">
                     <h3 className="font-bold flex items-center gap-3 text-slate-800 text-xs tracking-widest uppercase">å…¨ç³»çµ±æ‰“å¡ç‰†</h3>
                     <div className="grid grid-cols-3 gap-2">
                        {allCheckinPhotos.map(c => (
                           <div key={c.id} className="aspect-square rounded-xl overflow-hidden relative border border-slate-200 shadow-sm group">
                              <img src={c.image} className="w-full h-full object-cover" />
                              <div onClick={() => deleteItem('submissions', c.id, 'é€™å¼µç…§ç‰‡')} className="delete-badge hover:scale-110" style={{top:2, right:2}}><Icon name="Trash2" size={10}/></div>
                           </div>
                        ))}
                     </div>
                  </div>

                  <div className="luxury-card p-7 rounded-[35px] space-y-6">
                     <h3 className="font-bold flex items-center gap-3 text-slate-800 text-xs tracking-widest uppercase">éŠæˆ²åƒæ•¸èˆ‡ä»»å‹™è¨­å®š</h3>
                     <div className="grid grid-cols-2 gap-4">
                        <div><label className="settings-label">è½‰ç›¤è²»ç”¨</label><input type="number" className="settings-input" value={pendingSettings?.wheelCost} onChange={e => setPendingSettings({...pendingSettings, wheelCost: parseInt(e.target.value)})} /></div>
                        <div><label className="settings-label">æ‰“å¡çå‹µ</label><input type="number" className="settings-input" value={pendingSettings?.checkInPoints} onChange={e => setPendingSettings({...pendingSettings, checkInPoints: parseInt(e.target.value)})} /></div>
                        <div><label className="settings-label">é‡‘åº«æ—¥åˆ©ç‡</label><input type="number" step="0.01" className="settings-input" value={pendingSettings?.bankRate} onChange={e => setPendingSettings({...pendingSettings, bankRate: parseFloat(e.target.value)})} /></div>
                        <div><label className="settings-label">é‡‘åº«é–‰é–(æ™‚)</label><input type="number" className="settings-input" value={pendingSettings?.bankLockHours} onChange={e => setPendingSettings({...pendingSettings, bankLockHours: parseInt(e.target.value)})} /></div>
                     </div>
                     
                     <div className="border-t border-slate-100 pt-6">
                        <p className="settings-label">ä»»å‹™ç®¡ç†</p>
                        <div className="space-y-2 mb-4">
                           {pendingSettings?.missions?.map((m, i) => (
                              <div key={m.id} className="flex items-center gap-3 bg-slate-50 p-2 rounded-xl border border-slate-100">
                                 <div className="flex-1 text-[10px] font-bold text-slate-600 truncate">{m.title} ({m.reward}P)</div>
                                 <button onClick={() => removeMission(i)} className="text-rose-400 p-1 hover:bg-rose-50 rounded"><Icon name="Trash2" size={14}/></button>
                              </div>
                           ))}
                        </div>
                        <div className="bg-slate-50 p-4 rounded-xl border border-slate-200 space-y-3">
                           <input className="settings-input" placeholder="ä»»å‹™æ¨™é¡Œ" value={newMissionTitle} onChange={e => setNewMissionTitle(e.target.value)} />
                           <div className="grid grid-cols-3 gap-2">
                              <input type="number" className="settings-input" placeholder="ç›®æ¨™æ•¸" value={newMissionTarget} onChange={e => setNewMissionTarget(e.target.value)} />
                              <input type="number" className="settings-input" placeholder="çå‹µé»" value={newMissionReward} onChange={e => setNewMissionReward(e.target.value)} />
                              <select className="settings-input text-[10px] font-bold" value={newMissionType} onChange={e => setNewMissionType(e.target.value)}>
                                 <option value="streak">é€£çºŒå¤©æ•¸</option>
                                 <option value="total">ç´¯è¨ˆé»æ•¸</option>
                              </select>
                           </div>
                           <button onClick={addMission} className="w-full py-2 btn-luxury rounded-lg text-[10px] font-bold uppercase tracking-widest">åŠ å…¥ä»»å‹™</button>
                        </div>
                     </div>
                     <button onClick={handleSaveGameSettings} className="w-full py-4 btn-luxury rounded-xl font-bold text-xs uppercase tracking-widest shadow-xl">å„²å­˜å…¨ç³»çµ±è¨­å®š</button>
                  </div>

                  <div className="luxury-card p-6 rounded-[30px] space-y-6">
                     <h3 className="font-bold flex items-center gap-3 text-slate-800 text-xs tracking-widest uppercase">å•†å“ä¸Šæ¶</h3>
                     <div className="space-y-4">
                        <input className="settings-input" placeholder="åç¨±" value={adminRewardName} onChange={e => setAdminRewardName(e.target.value)} />
                        <input type="number" className="settings-input" placeholder="é»æ•¸" value={adminRewardCost} onChange={e => setAdminRewardCost(e.target.value)} />
                        <input type="file" accept="image/*" className="text-[10px] block w-full text-slate-400" onChange={e => setAdminRewardImage(e.target.files[0])} />
                        <button onClick={handleUploadTaskByAdmin} disabled={isAddingReward} className="w-full py-4 bg-sky-500 text-white rounded-xl font-bold text-xs uppercase shadow-md">ç¢ºèªä¸Šæ¶å•†å“</button>
                      </div>
                  </div>
               </div>
            )}
          </div>

          <div className="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-xl border-t border-slate-100 px-8 py-5 flex justify-between items-center text-[9px] font-bold text-slate-300 max-w-md mx-auto z-50 sm:rounded-b-[40px] shadow-[0_-10px_30px_rgba(0,0,0,0.05)]">
            <button onClick={() => setActiveTab('home')} className={`flex flex-col items-center gap-1.5 transition-all ${activeTab === 'home' ? 'text-slate-800 scale-110' : 'hover:text-slate-500'}`}><Icon name="Camera" size={24} className={activeTab === 'home' ? 'text-slate-800' : ''}/><span>HOME</span></button>
            <button onClick={() => setActiveTab('activities')} className={`flex flex-col items-center gap-1.5 transition-all ${activeTab === 'activities' ? 'text-slate-800 scale-110' : 'hover:text-slate-500'}`}><Icon name="Dice" size={24} className={activeTab === 'activities' ? 'text-slate-800' : ''}/><span>GAMES</span></button>
            <button onClick={() => setActiveTab('rewards')} className={`flex flex-col items-center gap-1.5 transition-all ${activeTab === 'rewards' ? 'text-slate-800 scale-110' : 'hover:text-slate-500'}`}><Icon name="Gift" size={24} className={activeTab === 'rewards' ? 'text-slate-800' : ''}/><span>SHOP</span></button>
            <button onClick={() => setActiveTab('notifs')} className={`flex flex-col items-center gap-1.5 transition-all ${activeTab === 'notifs' ? 'text-slate-800 scale-110' : 'hover:text-slate-500'}`}><div className="relative"><Icon name="Bell" size={24} className={activeTab === 'notifs' ? 'text-slate-800' : ''}/>{unreadCount > 0 && <span className="absolute -top-0.5 -right-0.5 bg-amber-500 w-2.5 h-2.5 rounded-full border-2 border-white"></span>}</div><span>ALERT</span></button>
            {isAdmin && <button onClick={() => setActiveTab('admin')} className={`flex flex-col items-center gap-1.5 transition-all ${activeTab === 'admin' ? 'text-slate-800 scale-110' : 'hover:text-slate-500'}`}><Icon name="Lock" size={24} className={activeTab === 'admin' ? 'text-slate-800' : ''}/><span>ADMIN</span></button>}
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    function InitWrapper() {
      const [fbReady, setFbReady] = useState(false);
      useEffect(() => {
        const check = setInterval(() => { if(window.fb && window.fb.isReady) { setFbReady(true); clearInterval(check); } }, 100);
        return () => clearInterval(check);
      }, []);
      if(!fbReady) return null;
      return <App />;
    }
    root.render(<InitWrapper />);
  </script>
</body>
</html>
